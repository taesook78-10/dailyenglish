<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily 3 Lines — TTS · STT · Score · 100-Day</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="/dailyenglish/manifest.webmanifest?v=10">
  <link rel="apple-touch-icon" href="/dailyenglish/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/dailyenglish/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/dailyenglish/icon-192.png">
  <style>
  :root{
    --bg:#0b1020; --card:#111a34; --ink:#e8eefc; --muted:#9fb0df;
    --pri:#5b8cff; --good:#21d39b; --warn:#ffb454; --bad:#ff5c7a;
    --ring:#31457a; --ring-strong:#4a63a8;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
    background:
      radial-gradient(80% 60% at 10% 0%,#15224b 0%,#0b1020 60%),
      radial-gradient(80% 60% at 100% 100%,#0f1834 0%,#0b1020 60%);
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(91,140,255,.15);color:#cfe0ff;border:1px solid var(--ring);font-size:12px}
  nav{display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap; align-items:center}
  .tab{padding:10px 14px;border-radius:12px;background:#101733;border:1px solid var(--ring);cursor:pointer;color:#a7b3d6}
  .tab.active{background:#141f45;color:var(--ink);border-color:#3a5296}
  select{appearance:none;background:#101733;border:1px solid var(--ring);color:#e8eefc;padding:10px 12px;border-radius:10px;min-height:44px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg,#111a34,#0f1731);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .hd{display:flex;align-items:flex-start;justify-content:space-between;padding:18px 18px 0}
  .card .body{padding:14px 18px 20px}
  .title{font-size:26px;margin-top:4px;font-weight:900;letter-spacing:.3px}
  .subtitle{font-size:13px;color:var(--muted)}
  .line{border:1px solid var(--ring);border-radius:16px;padding:14px;margin:12px 0;background:#0f1731}
  .line p{margin:0 0 8px;font-size:18px;line-height:1.5}
  .line p.ko{margin:0 0 10px; font-size:15.5px; line-height:1.6; color:#cbd4f5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{
    appearance:none;border:none;border-radius:12px;padding:10px 14px;
    background:#17224a;color:#e8eefc;border:1px solid #2b3f7a;cursor:pointer;min-height:44px;
    transition:transform .06s ease, filter .15s ease, box-shadow .15s ease;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.pri{background:linear-gradient(180deg,#3d64ff,#2b4bd4);border-color:#3b57e0}
  .btn.warn{background:#3a2a0e;border-color:#9f6b18}
  .btn.ghost{background:transparent;border-color:#2b3f7a}
  .btn.rec{background:linear-gradient(180deg,#ff5c7a,#e44360); border-color:#ff7f97; color:white; box-shadow:0 0 0 2px rgba(255,92,122,.25) inset}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px;border:1px solid var(--ring);border-radius:12px;background:#101733;font-size:13px}
  .chip::before{content:''; width:8px; height:8px; border-radius:50%; background:linear-gradient(180deg,#a7baff,#5b8cff); box-shadow:0 0 0 2px rgba(91,140,255,.15);}
  .score{font-weight:900}
  .meter{height:12px;background:#0e1330;border-radius:999px;border:1px solid var(--ring);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff5c7a,#ffb454,#5b8cff,#21d39b)}
  .kpi{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
  .day{aspect-ratio:1/1;border:1px solid #2d3d72;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0e1430;color:#c9d4ff;font-weight:700; font-size:14px}
  @media (max-width:520px){ .calendar{grid-template-columns:repeat(7,1fr)} .day{font-size:13px} .line p{font-size:16px} .title{font-size:22px}}
  .toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;pointer-events:none}
  .toast span{pointer-events:auto;background:#101733;border:1px solid var(--ring);padding:10px 14px;border-radius:12px}
  .small{font-size:12px;color:#a7b3d6}
  .hint{font-size:12.5px;color:#d3dcff;background:#16214a;border:1px solid #2e4489;padding:10px 12px;border-radius:10px}
  .practice{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;}
  .practice .box{width:min(720px,94vw); max-height:92vh; overflow:auto; background:#101733; border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:var(--shadow);}
  .practice .box h3{margin:0 0 12px; font-size:18px;}
  .practice .ref{font-size:14.5px; color:#cfe0ff; margin:6px 0 12px; white-space:pre-wrap; line-height:1.6}
  .practice .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
  .practice .result{margin-top:12px; padding:12px; border:1px solid var(--ring); border-radius:12px; background:#0f1731}
  .feedback{display:block; font-size:12.5px; color:#cfe0ff; opacity:.95}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily 3 Lines <span class="badge">100일 챌린지</span></h1>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="btnRetry">⟲ 다시 하기</button>
        <button class="btn warn" id="btnReset">⟲ 전체 초기화</button>
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="home">오늘의 학습</button>
      <button class="tab" data-view="challenge">챌린지</button>
      <button class="tab" data-view="progress">기록</button>

      <div style="display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:wrap">
        <label class="small" for="voiceSelect">Voice</label>
        <select id="voiceSelect" title="TTS Voice"></select>

        <span class="small">속도</span>
        <button class="btn" id="rateDown">–</button>
        <span id="rate" class="small">1.0x</span>
        <button class="btn" id="rateUp">+</button>
      </div>
    </nav>

    <section id="home" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="subtitle">오늘의 제목 (Day <span id="dayNum">1</span>)</div>
            <div class="title" id="dayTitle">—</div>
          </div>
        </div>
        <div class="body" id="lines"></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>오늘의 목표</h2>
          <div class="kpi">
            <div class="chip">80점 이상 성공</div>
            <div class="chip">점수: <span class="score" id="avgScore">—</span></div>
          </div>
        </div>
        <div class="body">
          <div class="meter" title="3문장 연속 말하기 점수"><i id="meterBar"></i></div>
          <div style="height:12px"></div>
          <button class="btn pri" id="markDone" disabled>✔ 오늘 완료로 표시</button>
          <div style="height:12px"></div>
          <div class="hint">세 문장을 모두 듣고(▶︎) <b>3문장 연속 말하기(점수 반영)</b>에서 80점 이상이면 완료할 수 있어요.</div>
          <div style="height:12px"></div>
          <div class="kpi">
            <div class="chip">연속일수: <b id="streak">0</b>일</div>
            <div class="chip">마지막 완료: <span id="lastDone">—</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" style="display:none">
      <div class="card">
        <div class="hd"><h2>100일 챌린지</h2><div class="chip">Day 1 → Day 100</div></div>
        <div class="body">
          <div class="calendar" id="challenge100"></div>
        </div>
      </div>
    </section>

    <section id="progress" style="display:none">
      <div class="card">
        <div class="hd"><h2>점수 기록</h2></div>
        <div class="body"><div id="history"></div></div>
      </div>
    </section>

    <div class="toast" id="toast" style="display:none"><span id="toastMsg"></span></div>
  </div>

<script>
/* ====== Storage / Date Utilities ====== */
const LS_USER='d3l_user', LS_PROGRESS='d3l_progress';
function todayKey(){ const f = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit'}); return f.format(new Date()); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER)||'{"ttsRate":1,"lang":"en-US","voiceURI":""}'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function loadProg(){ return JSON.parse(localStorage.getItem(LS_PROGRESS)||'{}'); }
function saveProg(p){ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }

let user=loadUser(), prog=loadProg();
if(!prog._startedAt){ prog._startedAt=todayKey(); }
if(!prog._currentDay){ prog._currentDay=1; }
if(!prog._lastDate){ prog._lastDate=todayKey(); } // KST 기준 마지막 본 날짜
if(!Array.isArray(prog._history)) { prog._history = []; }
saveProg(prog);

function computeDayFromStart(){
  const start = new Date(prog._startedAt+'T00:00:00+09:00');
  return Math.max(1, Math.min(100, Math.floor((Date.now()-start)/86400000)+1));
}
function getTodayDay(){
  const cur=prog._currentDay || computeDayFromStart();
  const d=Math.max(1,Math.min(100,cur));
  if(prog._currentDay!==d){ prog._currentDay=d; saveProg(prog); }
  return d;
}

/* ====== 100 Titles ====== */
const TITLES=[ 'Morning Routine','Commuting','Coffee Break','Emails','Team Meeting','Project Update','Lunch Out','Groceries','Gym','Evening Walk',
  'Streaming Show','Weekend Plan','Laundry','Room Cleaning','Errands','Bank Visit','Pharmacy','Salon','Car Wash','Pet Care',
  'Cooking Dinner','Takeout','Birthday Party','Small Talk','Weather Chat','Sports Talk','News Catch-up','Book Club','Movie Night','Concert',
  'Coffee Chat','Study Session','Library Visit','Note Taking','Presentation Prep','Public Speaking','Mentor Advice','Goal Setting','Habit Tracking','Budgeting',
  'Online Shopping','Return/Refund','Customer Service','Travel Plan','Packing','Airport','Hotel Check-in','City Tour','Photo Walk','Museum',
  'Park Picnic','Beach Day','Hiking','Rainy Day','Snow Day','Heat Wave','Cold Snap','Sick Day','Clinic Visit','Dentist Visit',
  'Back to Work','Overtime','Deadline Push','Celebration','Thank-you Notes','Apology','Making Plans','Canceling Plans','Running Late','Time Management',
  'Morning Coffee','Afternoon Slump','Power Nap','Evening Class','Night Drive','Late Snack','Phone Call','Video Call','Texting','Social Media',
  'Digital Detox','Mindfulness','Journaling','Reading','Music Playlist','Podcast','Language Practice','Networking','Interview Prep','Part-time Job',
  'Side Project','Coding Session','Design Draft','Feedback Round','Revision','Final Review','Presentation Day','Rest Day','Family Dinner','Friends Hangout',
  'Date Night','Neighborhood Walk','Farmer’s Market','Car Maintenance','House Plants','Recycling','Donation','Volunteering','Community Event','Holiday Prep'
];

/* ====== Fallback 21-line template (kept from the original) ====== */
function bank21_fallback(title){
  const t = title.toLowerCase();
  return [
    {en:`I spent some time on ${t} today.`, ko:`오늘 ${t}에 시간을 좀 썼어요.`},
    {en:`I tried to keep ${t} simple.`, ko:`${t}는 최대한 심플하게 해봤어요.`},
    {en:`Honestly, ${t} took longer than I expected.`, ko:`솔직히 ${t}가 생각보다 오래 걸렸어요.`},
    {en:`I finally got around to ${t}.`, ko:`드디어 ${t}를 하게 됐어요.`},
    {en:`I checked in on ${t} after work.`, ko:`퇴근 후 ${t}를 잠깐 살펴봤어요.`},
    {en:`Nothing fancy with ${t}—just the basics.`, ko:`${t}는 거창하게 안 하고 기본만 했어요.`},
    {en:`I made steady progress on ${t}.`, ko:`${t}는 꾸준히 진전이 있었어요.`},
    {en:`I kept ${t} practical, not overthinking it.`, ko:`${t}는 실용적으로, 과하게 고민하진 않았어요.`},
    {en:`We talked about ${t} for a bit.`, ko:`${t}에 대해 잠깐 얘기했어요.`},
    {en:`I’ll try to be more consistent with ${t}.`, ko:`${t}를 더 꾸준히 해볼게요.`},
    {en:`Next time, I’ll plan ${t} ahead.`, ko:`다음엔 ${t}를 미리 계획해볼게요.`},
    {en:`Small wins on ${t} still count.`, ko:`${t}에서 작은 성취도 의미 있어요.`},
    {en:`Slow and steady works for ${t}.`, ko:`${t}는 천천히 꾸준히가 맞는 것 같아요.`},
    {en:`I had a quick update on ${t}.`, ko:`${t} 관련해 간단히 업데이트했어요.`},
    {en:`I kept ${t} light but useful.`, ko:`${t}는 가볍게 했지만 유익했어요.`},
    {en:`I ran into a small hiccup with ${t}.`, ko:`${t}에서 작은 문제가 있었어요.`},
    {en:`I sorted out a few details for ${t}.`, ko:`${t}의 몇 가지 디테일을 정리했어요.`},
    {en:`${t} wasn’t perfect, but it moved forward.`, ko:`${t}가 완벽하진 않았지만 진전됐어요.`},
    {en:`I wrapped up the basics of ${t}.`, ko:`${t}의 기본은 마무리했어요.`},
    {en:`I set a simple goal for ${t} this week.`, ko:`이번 주 ${t}에 단순한 목표를 세웠어요.`},
    {en:`I’m glad ${t} is finally on track.`, ko:`${t}가 드디어 궤도에 올라서 다행이에요.`},
  ];
}

/* ====== Handcrafted 21-line sets per topic (EN/KR) ======
   - 수작업 세트가 존재하면 이것을 사용하고,
   - 없으면 위의 fallback으로 자동 대체됩니다.
   - 현재 10개 주제(예시) 수작업 완성. 이후 확장 가능.
*/
const HANDCRAFTED_21 = {
  "Morning Routine": [
    {en:"I woke up to a gentle alarm and didn’t hit snooze.", ko:"잔잔한 알람 소리에 일어나고, 스누즈는 누르지 않았어요."},
    {en:"I drank a glass of warm water before anything else.", ko:"무엇보다 먼저 미지근한 물 한 잔을 마셨어요."},
    {en:"I stretched my neck and shoulders for a minute.", ko:"목과 어깨를 1분 정도 가볍게 스트레칭했어요."},
    {en:"I made my bed to start the day tidy.", ko:"정돈된 하루를 위해 침대를 먼저 정리했어요."},
    {en:"I opened the window and let the fresh air in.", ko:"창문을 열어 상쾌한 공기를 들였어요."},
    {en:"I brewed a simple coffee and enjoyed the aroma.", ko:"간단히 커피를 내려 향을 즐겼어요."},
    {en:"I planned three priorities in my notebook.", ko:"노트에 오늘의 우선순위 세 가지를 적었어요."},
    {en:"I did a five-minute breathing exercise.", ko:"5분 호흡 연습으로 마음을 가다듬었어요."},
    {en:"I kept breakfast light but balanced.", ko:"아침은 가볍지만 균형 있게 챙겼어요."},
    {en:"I checked the weather and picked comfortable clothes.", ko:"날씨를 확인하고 편한 옷을 골랐어요."},
    {en:"I left the phone face down to avoid distractions.", ko:"산만함을 막으려고 폰을 화면 아래로 두었어요."},
    {en:"I read a short paragraph to wake my brain up.", ko:"뇌를 깨우려고 짧은 글을 읽었어요."},
    {en:"I watered my plant before heading out.", ko:"나가기 전에 화분에 물을 줬어요."},
    {en:"I packed my bag the night before, so it was easy.", ko:"전날 가방을 챙겨둬서 준비가 수월했어요."},
    {en:"I left home five minutes earlier than usual.", ko:"평소보다 5분 일찍 집을 나섰어요."},
    {en:"I reminded myself to be kind and patient today.", ko:"오늘은 친절과 인내를 기억하자고 다짐했어요."},
    {en:"I kept my morning routine simple and calm.", ko:"아침 루틴을 단순하고 차분하게 유지했어요."},
    {en:"I skipped scrolling and saved time.", ko:"무의식적 스크롤을 건너뛰어 시간을 아꼈어요."},
    {en:"I took a deep breath before locking the door.", ko:"문을 잠그기 전에 깊게 한 번 숨을 들이쉬었어요."},
    {en:"I felt ready to start the day on purpose.", ko:"의도 있는 시작으로 하루를 맞이할 준비가 되었어요."},
    {en:"I told myself, 'One small win at a time.'", ko:"‘작은 성취 하나씩’이라고 스스로에게 말했어요."},
  ],
  "Commuting": [
    {en:"I caught my usual bus without rushing.", ko:"허둥대지 않고 평소 타던 버스를 잡았어요."},
    {en:"I used the ride to review my schedule.", ko:"이동 시간에 일정을 점검했어요."},
    {en:"I listened to a short podcast episode.", ko:"짧은 팟캐스트를 한 편 들었어요."},
    {en:"I stood near the door to get off smoothly.", ko:"내리기 편하게 문 근처에 섰어요."},
    {en:"I offered my seat to someone who needed it.", ko:"자리 양보가 필요한 분께 자리를 내드렸어요."},
    {en:"I practiced silent breathing when it got crowded.", ko:"혼잡할 때 조용히 호흡을 가다듬었어요."},
    {en:"I avoided doom-scrolling and watched outside.", ko:"무의미한 스크롤을 피하고 창밖을 바라봤어요."},
    {en:"I sent a quick update that I’d arrive on time.", ko:"정시에 도착한다고 간단히 알렸어요."},
    {en:"I double-checked my stop—no surprises today.", ko:"내릴 정류장을 다시 확인해 실수 없었어요."},
    {en:"I kept my bag zipped and close to me.", ko:"가방 지퍼를 잠그고 몸 가까이 뒀어요."},
    {en:"I let a train pass to get a less crowded one.", ko:"덜 붐비는 열차를 타려고 한 대를 보냈어요."},
    {en:"I stretched my calves while standing.", ko:"서 있는 동안 종아리를 스트레칭했어요."},
    {en:"I smiled at a driver who waited for pedestrians.", ko:"보행자를 배려한 운전자에게 미소로 답했어요."},
    {en:"I walked the last block to wake myself up.", ko:"마지막 한 블록은 걸으며 몸을 깨웠어요."},
    {en:"I was mindful of my posture the whole time.", ko:"내내 자세를 의식하며 유지했어요."},
    {en:"I arrived with a few minutes to spare.", ko:"여유 있게 몇 분 일찍 도착했어요."},
    {en:"I thanked myself for a calm commute.", ko:"침착한 통근을 한 나에게 고마웠어요."},
    {en:"I noticed a new café near the station.", ko:"역 근처 새 카페를 발견했어요."},
    {en:"I kept ear volume low to protect hearing.", ko:"청력을 지키려고 볼륨을 낮게 유지했어요."},
    {en:"I ended the ride feeling steady and clear.", ko:"안정되고 맑은 기분으로 이동을 마쳤어요."},
    {en:"I said, 'That was smoother than yesterday.'", ko:"‘어제보다 한결 수월했어.’라고 생각했어요."},
  ],
  "Coffee Break": [
    {en:"I chose a lighter roast for a gentle flavor.", ko:"부드러운 맛을 위해 라이트 로스트를 골랐어요."},
    {en:"I tried not to add sugar this time.", ko:"이번에는 설탕을 넣지 않으려 노력했어요."},
    {en:"I paired coffee with a handful of nuts.", ko:"견과 한 줌과 커피를 곁들였어요."},
    {en:"I took three slow breaths before the first sip.", ko:"첫 모금 전에 천천히 세 번 숨을 쉬었어요."},
    {en:"I chatted briefly with the barista.", ko:"바리스타와 짧게 대화를 나눴어요."},
    {en:"I sat by the window for natural light.", ko:"창가 자리에 앉아 자연광을 즐겼어요."},
    {en:"I kept the break to ten mindful minutes.", ko:"10분 정도의 온전한 휴식으로 제한했어요."},
    {en:"I noticed hints of citrus in the coffee.", ko:"커피에서 시트러스 향을 느꼈어요."},
    {en:"I skipped my phone and watched people pass by.", ko:"폰은 내려놓고 지나가는 사람들을 바라봤어요."},
    {en:"I refilled my water to stay hydrated.", ko:"수분 보충을 위해 물도 채워둔 뒤였어요."},
    {en:"I thanked the team by bringing back a cup.", ko:"동료에게 커피를 하나 사와 감사의 뜻을 전했어요."},
    {en:"I cleaned the mug right after finishing.", ko:"다 마시고 바로 머그컵을 씻었어요."},
    {en:"I avoided a second cup in the afternoon.", ko:"오후에는 두 번째 컵을 참았어요."},
    {en:"I tried a new origin I hadn’t tasted before.", ko:"처음 마셔보는 원두를 시도했어요."},
    {en:"I savored the warmth and slowed my pace.", ko:"따뜻함을 음미하며 속도를 늦췄어요."},
    {en:"I kept the talk light and friendly.", ko:"대화는 가볍고 친근하게 유지했어요."},
    {en:"I left the café feeling refreshed.", ko:"카페를 나올 때는 상쾌했어요."},
    {en:"I reminded myself not to drink too late.", ko:"너무 늦게 마시지 않도록 스스로에게 상기했어요."},
    {en:"I logged the taste notes in my journal.", ko:"맛 노트를 간단히 기록했어요."},
    {en:"I enjoyed the small ritual of a clean pour.", ko:"깨끗한 푸어의 작은 의식을 즐겼어요."},
    {en:"I said, 'That cup was just right.'", ko:"‘방금 그 한 잔, 딱 좋았어.’라고 생각했어요."},
  ],
  "Emails": [
    {en:"I cleared the inbox to zero once today.", ko:"오늘 한 번은 인박스를 ‘0’으로 비웠어요."},
    {en:"I answered the oldest message first.", ko:"가장 오래된 메일부터 답장했어요."},
    {en:"I used clear subject lines with verbs.", ko:"동사가 보이는 명확한 제목을 썼어요."},
    {en:"I kept each reply under five sentences.", ko:"답장은 다섯 문장 이내로 제한했어요."},
    {en:"I turned long threads into quick calls.", ko:"길어진 스레드는 간단 통화로 전환했어요."},
    {en:"I added deadlines instead of vague words.", ko:"애매한 표현 대신 마감일을 명시했어요."},
    {en:"I thanked people for prompt follow-ups.", ko:"빠른 회신에 감사 인사를 전했어요."},
    {en:"I archived newsletters after skimming.", ko:"뉴스레터는 훑어보고 보관 처리했어요."},
    {en:"I unsubscribed from one noisy list.", ko:"시끄러운 구독 하나를 해지했어요."},
    {en:"I delayed a message to send next morning.", ko:"메일 하나는 다음 날 아침 발송으로 예약했어요."},
    {en:"I attached files with clear filenames.", ko:"첨부 파일 이름을 명확히 정리했어요."},
    {en:"I used bullets to highlight actions.", ko:"할 일을 강조하려 글머리표를 사용했어요."},
    {en:"I asked one question per email.", ko:"메일당 질문은 하나만 담았어요."},
    {en:"I read everything once before sending.", ko:"보내기 전에는 반드시 한 번 더 읽었어요."},
    {en:"I avoided CC overload and kept it lean.", ko:"과한 참조를 피하고 꼭 필요한 사람만 포함했어요."},
    {en:"I thanked myself for not checking too often.", ko:"너무 자주 확인하지 않은 나에게 고마웠어요."},
    {en:"I filed important mails into simple folders.", ko:"중요 메일은 단순한 폴더로 분류했어요."},
    {en:"I flagged two messages to revisit later.", ko:"나중에 볼 메일 두 개를 플래그했어요."},
    {en:"I wrote with kindness, not urgency.", ko:"급함보다 배려를 담아 썼어요."},
    {en:"I ended with a clear next step.", ko:"다음 행동을 분명히 적고 마무리했어요."},
    {en:"I closed the tab and moved on.", ko:"메일 탭을 닫고 다음 일로 넘어갔어요."},
  ],
  "Team Meeting": [
    {en:"I joined on time with notes ready.", ko:"메모를 준비해 정시에 참여했어요."},
    {en:"I opened with outcomes, not updates.", ko:"상세 업데이트보다 결괏값부터 공유했어요."},
    {en:"I asked one clarifying question.", ko:"핵심을 묻는 질문을 하나 던졌어요."},
    {en:"I captured decisions in a shared doc.", ko:"결정 사항을 공동 문서에 정리했어요."},
    {en:"I kept side topics for later.", ko:"곁다리 주제는 나중으로 미뤘어요."},
    {en:"I summarized action items with owners.", ko:"할 일과 담당자를 요약했어요."},
    {en:"I watched the time and moved us along.", ko:"시간을 확인하며 흐름을 이끌었어요."},
    {en:"I invited quieter voices to speak.", ko:"말이 적은 사람에게 발언 기회를 드렸어요."},
    {en:"I parked unresolved issues properly.", ko:"미해결 이슈는 파킹리스트에 기록했어요."},
    {en:"I checked alignment before closing.", ko:"끝내기 전 정렬 상태를 확인했어요."},
    {en:"I avoided interruptions and listened fully.", ko:"말을 끊지 않고 끝까지 들었어요."},
    {en:"I used visuals to keep things clear.", ko:"시각 자료로 이해를 도왔어요."},
    {en:"I praised small wins in public.", ko:"작은 성과를 공개적으로 칭찬했어요."},
    {en:"I took next steps within 24 hours.", ko:"24시간 내 다음 스텝을 실행하기로 했어요."},
    {en:"I kept the meeting within the agenda.", ko:"의제 범위 안에서 회의를 진행했어요."},
    {en:"I asked 'What does good look like?' once.", ko:"‘좋음의 기준은?’을 한 번 물었어요."},
    {en:"I reduced recurring topics with a doc.", ko:"반복 논의는 문서로 압축했어요."},
    {en:"I ended five minutes early for breathing room.", ko:"여유를 위해 5분 일찍 마쳤어요."},
    {en:"I thanked everyone for focus and effort.", ko:"집중과 노력을 고맙게 생각했어요."},
    {en:"I shared minutes right after the call.", ko:"통화 직후 회의록을 공유했어요."},
    {en:"I left with energy, not confusion.", ko:"혼란이 아닌 에너지를 얻고 나왔어요."},
  ],
  "Project Update": [
    {en:"I wrote a brief status with traffic-light colors.", ko:"신호등 색으로 간단한 상태 보고를 작성했어요."},
    {en:"I highlighted risks with clear owners.", ko:"리스크와 담당자를 명확히 표시했어요."},
    {en:"I showed a before-and-after metric.", ko:"지표의 전후 비교를 보여줬어요."},
    {en:"I cut scope that didn’t add value.", ko:"가치 없는 범위는 과감히 줄였어요."},
    {en:"I turned blockers into specific asks.", ko:"막힘을 구체적 요청으로 바꿨어요."},
    {en:"I linked to the latest design and spec.", ko:"최신 디자인과 스펙 링크를 첨부했어요."},
    {en:"I called out what’s shipped this week.", ko:"이번 주 출시 항목을 명시했어요."},
    {en:"I gave a realistic next milestone date.", ko:"현실적인 다음 마일스톤 일정을 제시했어요."},
    {en:"I tagged reviewers for fast feedback.", ko:"빠른 피드백을 위해 리뷰어를 태그했어요."},
    {en:"I noted any dependency changes.", ko:"의존성 변경 사항을 정리했어요."},
    {en:"I celebrated a contributor by name.", ko:"기여자를 이름으로 칭찬했어요."},
    {en:"I clarified what ‘done’ means this phase.", ko:"이번 단계의 ‘완료’ 정의를 명확히 했어요."},
    {en:"I added a simple burndown snapshot.", ko:"간단한 번다운 스냅샷을 덧붙였어요."},
    {en:"I aligned tasks with the roadmap.", ko:"작업을 로드맵과 정렬했어요."},
    {en:"I trimmed jargon and wrote plainly.", ko:"전문 용어를 줄이고 평이하게 썼어요."},
    {en:"I kept the update under two minutes.", ko:"2분 내로 발표를 마쳤어요."},
    {en:"I invited questions and recorded them.", ko:"질문을 받아 기록해 두었어요."},
    {en:"I set a check-in for next week.", ko:"다음 주 점검 일정을 잡았어요."},
    {en:"I closed with one clear call to action.", ko:"마지막에 명확한 행동 요청을 남겼어요."},
    {en:"I shared the doc link with viewers.", ko:"문서 링크를 공유 권한과 함께 보냈어요."},
    {en:"I felt progress, not just motion.", ko:"움직임이 아닌 진전을 느꼈어요."},
  ],
  "Lunch Out": [
    {en:"I chose a balanced bowl with veggies.", ko:"채소가 많은 균형 잡힌 볼을 골랐어요."},
    {en:"I asked for less sauce and more greens.", ko:"소스는 적게, 채소는 더 달라고 했어요."},
    {en:"I drank water before ordering.", ko:"주문 전에 물을 먼저 마셨어요."},
    {en:"I shared a side so we didn’t overeat.", ko:"과식을 피하려고 사이드를 나눠 먹었어요."},
    {en:"I tried a place I’d saved last week.", ko:"지난주 저장해둔 식당을 시도했어요."},
    {en:"I put my phone away to enjoy the meal.", ko:"식사에 집중하려 폰을 치워두었어요."},
    {en:"I asked about allergens just in case.", ko:"혹시 몰라 알레르기를 확인했어요."},
    {en:"I tipped with a thank-you and a smile.", ko:"감사 인사와 함께 팁을 남겼어요."},
    {en:"I kept the lunch under an hour.", ko:"점심 시간을 한 시간 이내로 지켰어요."},
    {en:"I walked back to help digestion.", ko:"소화를 돕려고 걸어서 돌아왔어요."},
    {en:"I took a photo for my food log.", ko:"식단 기록을 위해 사진을 찍었어요."},
    {en:"I avoided heavy drinks in the afternoon.", ko:"오후를 위해 탄산은 피했어요."},
    {en:"I enjoyed a small dessert to finish.", ko:"작은 디저트로 깔끔히 마무리했어요."},
    {en:"I thanked the staff for quick service.", ko:"빠른 응대에 감사 인사를 전했어요."},
    {en:"I tried to savor every bite.", ko:"한 입 한 입 음미하려고 했어요."},
    {en:"I split the bill fairly and easily.", ko:"계산은 깔끔하게 나눴어요."},
    {en:"I noted what I’d order again.", ko:"다음에 또 먹을 메뉴를 메모했어요."},
    {en:"I kept my pace slow and relaxed.", ko:"천천히, 여유를 두고 먹었어요."},
    {en:"I left room for an afternoon coffee.", ko:"오후 커피를 위해 여지를 남겼어요."},
    {en:"I returned to work refreshed.", ko:"상쾌한 기분으로 자리로 돌아왔어요."},
    {en:"I felt grateful for good company.", ko:"좋은 동행에 고마웠어요."},
  ],
  "Groceries": [
    {en:"I checked the fridge and made a short list.", ko:"냉장고를 확인하고 짧은 리스트를 만들었어요."},
    {en:"I chose seasonal produce first.", ko:"제철 농산물을 먼저 담았어요."},
    {en:"I compared unit prices before deciding.", ko:"단가를 비교하고 선택했어요."},
    {en:"I picked whole grains over snacks.", ko:"과자보다 통곡물을 고집했어요."},
    {en:"I avoided shopping when hungry.", ko:"배고플 때 장보는 걸 피했어요."},
    {en:"I brought a reusable bag from home.", ko:"집에서 가져온 장바구니를 사용했어요."},
    {en:"I read labels for sugar and salt.", ko:"당·나트륨 표기를 확인했어요."},
    {en:"I bought just enough for the week.", ko:"일주일치만 적당히 샀어요."},
    {en:"I restocked basics like eggs and milk.", ko:"달걀과 우유 같은 기본 식재료를 채웠어요."},
    {en:"I added fresh herbs to lift flavors.", ko:"향신채를 넣어 풍미를 살리려 했어요."},
    {en:"I grabbed a backup for busy days.", ko:"바쁜 날을 위한 예비 식품도 챙겼어요."},
    {en:"I avoided plastic where possible.", ko:"가능한 한 플라스틱을 줄였어요."},
    {en:"I checked dates and rotated items.", ko:"유통기한을 확인하고 정리했어요."},
    {en:"I used points and simple discounts.", ko:"포인트와 기본 할인만 활용했어요."},
    {en:"I skipped impulse purchases at checkout.", ko:"계산대 앞 충동구매를 참았어요."},
    {en:"I stored greens right after getting home.", ko:"집에 오자마자 채소를 보관했어요."},
    {en:"I cleaned the crisper drawer quickly.", ko:"야채 칸을 재빨리 닦았어요."},
    {en:"I planned two easy dinners from the haul.", ko:"장 본 재료로 쉬운 저녁 두 끼를 계획했어요."},
    {en:"I put receipts away for tracking.", ko:"영수증은 기록을 위해 모아두었어요."},
    {en:"I felt ready for a week of simple meals.", ko:"한 주 간단한 식사를 준비한 느낌이에요."},
    {en:"I smiled at how organized the cart looked.", ko:"정돈된 카트를 보며 흐뭇했어요."},
  ],
  "Gym": [
    {en:"I warmed up for five minutes to prevent injury.", ko:"부상을 막으려고 5분간 워밍업했어요."},
    {en:"I focused on form over heavy weight.", ko:"무게보다 자세에 집중했어요."},
    {en:"I logged sets and reps in my app.", ko:"세트와 반복을 앱에 기록했어요."},
    {en:"I alternated push and pull movements.", ko:"푸시/풀을 번갈아 구성했어요."},
    {en:"I kept rest periods consistent.", ko:"휴식 시간을 일정하게 유지했어요."},
    {en:"I added one small progression today.", ko:"오늘은 작은 진전을 하나 추가했어요."},
    {en:"I hydrated between sets.", ko:"세트 사이에 수분을 보충했어요."},
    {en:"I wiped down equipment after use.", ko:"사용한 기구는 바로 닦았어요."},
    {en:"I ended with a light cooldown.", ko:"마무리는 가벼운 쿨다운으로 했어요."},
    {en:"I stretched tight hips and hamstrings.", ko:"뻣뻣한 둔근과 햄스트링을 풀었어요."},
    {en:"I avoided comparing myself to others.", ko:"다른 사람과 비교하지 않으려 했어요."},
    {en:"I kept my phone on do-not-disturb.", ko:"방해 금지 모드로 집중했어요."},
    {en:"I noted what felt stronger today.", ko:"오늘 강해진 부분을 기록했어요."},
    {en:"I lowered volume when form broke down.", ko:"자세가 무너지면 볼륨을 줄였어요."},
    {en:"I chose music that kept me moving.", ko:"움직임을 돕는 음악을 골랐어요."},
    {en:"I respected others’ space and time.", ko:"다른 사람의 공간과 시간을 존중했어요."},
    {en:"I left with steady energy, not exhaustion.", ko:"탈진이 아닌 안정된 에너지로 나왔어요."},
    {en:"I ate protein within an hour.", ko:"한 시간 안에 단백질을 섭취했어요."},
    {en:"I updated tomorrow’s plan briefly.", ko:"내일 계획을 간단히 수정했어요."},
    {en:"I thanked my body for showing up.", ko:"운동한 내 몸에 감사했어요."},
    {en:"I reminded myself: consistency beats intensity.", ko:"일관성이 강도를 이긴다고 되새겼어요."},
  ],
  "Evening Walk": [
    {en:"I walked a quiet route to unwind.", ko:"마음을 풀기 위해 조용한 길을 걸었어요."},
    {en:"I left my headphones at home tonight.", ko:"오늘 밤은 이어폰을 집에 두고 나왔어요."},
    {en:"I watched the sky change colors.", ko:"변해가는 하늘빛을 바라봤어요."},
    {en:"I kept a steady, easy pace.", ko:"균일하고 편한 속도로 걸었어요."},
    {en:"I greeted a neighbor with a smile.", ko:"이웃에게 미소로 인사했어요."},
    {en:"I noticed a new flower by the path.", ko:"길가에 새로 핀 꽃을 발견했어요."},
    {en:"I stretched my back at a bench.", ko:"벤치에서 등을 가볍게 늘렸어요."},
    {en:"I counted my breaths to slow my mind.", ko:"호흡을 세며 마음을 느리게 했어요."},
    {en:"I avoided bright screens after returning.", ko:"돌아와서는 밝은 화면을 피했어요."},
    {en:"I drank warm tea instead of a late snack.", ko:"야식 대신 따뜻한 차를 마셨어요."},
    {en:"I tracked steps just out of curiosity.", ko:"호기심으로 걸음 수만 확인했어요."},
    {en:"I kept the walk around twenty minutes.", ko:"산책은 20분 정도로 유지했어요."},
    {en:"I listened to crickets and city sounds.", ko:"귀뚜라미와 도시 소리를 함께 들었어요."},
    {en:"I felt tension melt from my shoulders.", ko:"어깨의 긴장이 스르르 풀렸어요."},
    {en:"I waved to a friendly street cat.", ko:"친근한 길고양이에게 손을 흔들었어요."},
    {en:"I took a different turn for variety.", ko:"변화를 주려고 다른 길로 꺾어 봤어요."},
    {en:"I noticed my posture getting taller.", ko:"자세가 한층 곧아진 걸 느꼈어요."},
    {en:"I ended the walk with gratitude.", ko:"감사한 마음으로 산책을 마쳤어요."},
    {en:"I planned a slightly longer walk tomorrow.", ko:"내일은 조금 더 길게 걸어보려 해요."},
    {en:"I slept better after a calm stroll.", ko:"차분한 산책 덕분에 더 잘 잤어요."},
    {en:"I told myself, 'Evening resets the day.'", ko:"‘저녁 산책이 하루를 리셋해.’라고 생각했어요."},
  ],
  "Streaming Show": [
    {en:"I picked one episode instead of binging.", ko:"정주행 대신 한 편만 보려고 골랐어요."},
    {en:"I turned on subtitles to catch details.", ko:"디테일을 잡으려고 자막을 켰어요."},
    {en:"I paused to refill water, not snacks.", ko:"간식 대신 물을 채우려 잠시 멈췄어요."},
    {en:"I noted a quote I really liked.", ko:"마음에 든 대사를 메모했어요."},
    {en:"I avoided spoilers and stayed present.", ko:"스포일러를 피하고 현재 장면에 집중했어요."},
    {en:"I lowered brightness to rest my eyes.", ko:"눈을 위해 밝기를 낮췄어요."},
    {en:"I stopped auto-play after the credits.", ko:"크레딧 후 자동 재생을 끄고 멈췄어요."},
    {en:"I recommended the show to one friend.", ko:"친구 한 명에게 작품을 추천했어요."},
    {en:"I skipped scenes that felt too heavy.", ko:"너무 무거운 장면은 건너뛰었어요."},
    {en:"I stretched during a slow scene.", ko:"느린 장면에 가벼운 스트레칭을 했어요."},
    {en:"I compared it to the book briefly.", ko:"원작 책과 잠깐 비교해 봤어요."},
    {en:"I checked the director’s other works.", ko:"감독의 다른 작품도 찾아봤어요."},
    {en:"I kept the volume low at night.", ko:"밤에는 볼륨을 낮게 유지했어요."},
    {en:"I stopped before it got too late.", ko:"너무 늦어지기 전에 끄고 쉬었어요."},
    {en:"I cleaned up the sofa and blanket.", ko:"소파와 담요를 정돈했어요."},
    {en:"I rated the episode for my log.", ko:"기록을 위해 에피소드를 별점 매겼어요."},
    {en:"I reflected on the theme afterward.", ko:"끝나고 주제를 잠시 곱씹었어요."},
    {en:"I didn’t snack mindlessly this time.", ko:"이번엔 무념무상 간식을 피했어요."},
    {en:"I decided what to watch next time.", ko:"다음에 볼 작품을 미리 정했어요."},
    {en:"I shut the screen and chose to read.", ko:"화면을 끄고 독서를 선택했어요."},
    {en:"I went to bed on time after one show.", ko:"한 편만 보고 제시간에 잠자리에 들었어요."},
  ],
  "Weekend Plan": [
    {en:"I listed one fun and one restful activity.", ko:"재미있는 일 하나, 쉬는 일 하나를 적었어요."},
    {en:"I set a budget for the outing.", ko:"외출 예산을 간단히 정했어요."},
    {en:"I checked the weather and backups.", ko:"날씨와 대안을 확인했어요."},
    {en:"I booked a time slot where needed.", ko:"필요한 곳은 시간을 예약했어요."},
    {en:"I kept the plan light to avoid stress.", ko:"스트레스를 줄이려 일정을 가볍게 잡았어요."},
    {en:"I included a short nature walk.", ko:"짧은 자연 산책을 포함했어요."},
    {en:"I picked one place to try new food.", ko:"새로운 음식을 맛볼 곳을 정했어요."},
    {en:"I left space for doing nothing.", ko:"아무것도 하지 않는 시간도 남겨뒀어요."},
    {en:"I planned a small home project.", ko:"집에서 할 작은 프로젝트도 계획했어요."},
    {en:"I set a time to call a friend.", ko:"친구에게 전화할 시간을 잡았어요."},
    {en:"I checked transit to avoid traffic.", ko:"교통 상황을 확인해 막힘을 피하려 했어요."},
    {en:"I chose a book to finish this weekend.", ko:"이번 주말에 끝낼 책을 골랐어요."},
    {en:"I planned a simple family meal.", ko:"가족과 먹을 간단한 식사를 계획했어요."},
    {en:"I prepared a picnic option just in case.", ko:"피크닉 대안도 가볍게 준비했어요."},
    {en:"I set a time to clean a small corner.", ko:"집 한 구석을 정리할 시간을 정했어요."},
    {en:"I picked a music playlist to match the mood.", ko:"분위기에 맞는 음악 플레이리스트를 골랐어요."},
    {en:"I promised myself to take photos mindfully.", ko:"사진은 의식적으로 찍기로 했어요."},
    {en:"I planned a budget-friendly treat.", ko:"지갑에 무리 없는 작은 선물을 계획했어요."},
    {en:"I scheduled a proper bedtime on Sunday.", ko:"일요일엔 제시간에 잠자리에 들기로 했어요."},
    {en:"I left Monday’s prep for Sunday evening.", ko:"월요일 준비는 일요일 저녁에 하기로 했어요."},
    {en:"I felt excited but not overloaded.", ko:"들뜨되, 과하지 않게 준비됐어요."},
  ],
};

/* ====== Pick bank (handcrafted first, then fallback) ====== */
function bank21(title){
  const set = HANDCRAFTED_21[title];
  return Array.isArray(set) && set.length===21 ? set : bank21_fallback(title);
}

/* ====== Per-day state ====== */
function ensureDayState(day){
  const k='Day'+day;
  if(!prog[k]){ prog[k]={ comboScore:null, done:false, bankOffset:0 }; }
  if(typeof prog[k].bankOffset!=='number') prog[k].bankOffset=0;
  return prog[k];
}

/* ====== TTS ====== */
let voices=[]; const voiceSelect=document.getElementById('voiceSelect');
function loadVoices(){ try{ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
function sortVoices(list){ return [...list].sort((a,b)=>{ const score=v=>(/en[-_]?US/i.test(v.lang)?2:/^en/i.test(v.lang)?1:0); const ds=score(b)-score(a); return ds||((a.name||'').localeCompare(b.name||'')); }); }
function populateVoiceSelect(){ voiceSelect.innerHTML=''; if(!voices.length){ const o=document.createElement('option'); o.textContent='(no voices)'; o.value=''; voiceSelect.appendChild(o); voiceSelect.disabled=true; return; } voiceSelect.disabled=false; const sorted=sortVoices(voices); for(const v of sorted){ const o=document.createElement('option'); o.value=v.voiceURI||v.name||''; o.textContent=`${v.name} — ${v.lang}`; voiceSelect.appendChild(o);} const byURI=sorted.find(v=>(v.voiceURI||'')===(user.voiceURI||'')); if(byURI) voiceSelect.value=byURI.voiceURI||''; else { const enUS=sorted.find(v=>/en[-_]?US/i.test(v.lang)); voiceSelect.value=(enUS&&(enUS.voiceURI||''))||(sorted[0].voiceURI||''); user.voiceURI=voiceSelect.value; saveUser(user);} }
async function waitForVoices(timeout=2000){ if(!('speechSynthesis' in window)) return; loadVoices(); if(voices.length) return; await new Promise(res=>{ const t0=Date.now(); function h(){ loadVoices(); if(voices.length||Date.now()-t0>timeout){ speechSynthesis.removeEventListener('voiceschanged',h); res(); } } speechSynthesis.addEventListener('voiceschanged',h); setTimeout(h,timeout); }); }
if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.addEventListener('voiceschanged', ()=>{ loadVoices(); populateVoiceSelect(); }); }
function resumeTTS(){ try{ if('speechSynthesis' in window && speechSynthesis.paused) speechSynthesis.resume(); }catch(_){} }
window.addEventListener('pointerdown', resumeTTS, { once:true }); document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resumeTTS(); });
function getVoice(){ if(!voices.length) return null; if(user.voiceURI){ const v=voices.find(v=>(v.voiceURI||'')===user.voiceURI); if(v) return v; } return voices.find(v=>/en[-_]?US/i.test(v.lang))||voices.find(v=>/^en/i.test(v.lang))||voices[0]||null; }
voiceSelect.addEventListener('change', ()=>{ user.voiceURI=voiceSelect.value||''; saveUser(user); toast('TTS 보이스를 변경했어요.'); });
function speakOnce(text){ return new Promise(async (resolve)=>{ if(!('speechSynthesis' in window)) return resolve(); await waitForVoices(); resumeTTS(); const utt=new SpeechSynthesisUtterance(text); utt.lang=user.lang||'en-US'; utt.rate=user.ttsRate||1; const v=getVoice(); if(v){ utt.voice=v; utt.lang=v.lang||utt.lang; } utt.onend=()=>resolve(); try{ if(speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){} setTimeout(()=>speechSynthesis.speak(utt),0); }); }
async function speakQueue(arr,onStart,onEnd){ try{ onStart&&onStart(); for(const s of arr){ await speakOnce(s); } } finally{ onEnd&&onEnd(); } }
function speak(text){ return speakQueue([text]); }

/* ====== STT & Scoring (원본 유지) ====== */
function createRecognizer(onResult,onEnd,{continuous=false,interim=false}={}){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('이 기기에서는 음성 인식이 제한됩니다. (Android Chrome 권장)'); return null; } const rec=new SR(); rec.lang='en-US'; rec.interimResults=!!interim; rec.continuous=!!continuous; rec.maxAlternatives=1; rec.onresult=(e)=>onResult&&onResult(e); rec.onerror=(e)=>{}; rec.onend=()=>onEnd&&onEnd(); return rec; }
function levenshtein(a,b){ const m=a.length,n=b.length; const d=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) d[i][0]=i; for(let j=0;j<=n;j++) d[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);} } return d[m][n]; }
function norm(s){ return s.toLowerCase().replace(/[^a-z\s]/g,'').replace(/\s+/g,' ').trim(); }
function scoreSentence(ref,hyp){ const A=norm(ref),B=norm(hyp); if(!B) return 0; const dist=levenshtein(A,B); const max=Math.max(A.length,B.length)||1; return Math.max(0, Math.round((1-dist/max)*100)); }
function tokenize(s){ return norm(s).split(' ').filter(Boolean); }
function wordDiffFeedback(ref, hyp){ const R=tokenize(ref), H=tokenize(hyp); if(!H.length) return ['조금 더 크게, 또렷하게 말해줘요!']; const setH=new Set(H); const tips=[]; const missing=R.filter(w=>!setH.has(w)); if(missing.length>=2) tips.push('단어 몇 개 빠졌어요 (끝까지 말하기).'); if(H.length <= Math.max(2, Math.floor(R.length*0.6))) tips.push('조금 더 길게, 전체 문장을 말해보세요.'); if(tips.length<=1) tips.push('억양을 살려 자연스럽게 읽어보세요.'); return tips.slice(0,2); }

/* ====== UI Refs ====== */
const tabs=document.querySelectorAll('.tab');
const views={home:document.getElementById('home'),challenge:document.getElementById('challenge'),progress:document.getElementById('progress')};
const elDayNum=document.getElementById('dayNum'); const elTitle=document.getElementById('dayTitle'); const elLines=document.getElementById('lines');
const elAvg=document.getElementById('avgScore'); const elMeter=document.getElementById('meterBar');
const btnRetry=document.getElementById('btnRetry'); const btnReset=document.getElementById('btnReset');

for (const t of tabs){ t.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active');
  Object.values(views).forEach(v=>v.style.display='none'); views[t.dataset.view].style.display='';
  if(t.dataset.view==='challenge') renderChallenge100();
  if(t.dataset.view==='progress') renderHistory();
}); }

/* ====== Toast ====== */
let toastTimer; function toast(msg){ clearTimeout(toastTimer); const el=document.getElementById('toast'); const m=document.getElementById('toastMsg'); m.textContent=msg; el.style.display='flex'; toastTimer=setTimeout(()=>el.style.display='none', 1800); }

/* ====== TTS rate ====== */
const elRate=document.getElementById('rate');
elRate.textContent=(user.ttsRate||1).toFixed(1)+'x';
document.getElementById('rateDown').onclick=()=>{ user.ttsRate=Math.max(.6, Math.round(((user.ttsRate||1)-.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };
document.getElementById('rateUp').onclick=()=>{ user.ttsRate=Math.min(1.4, Math.round(((user.ttsRate||1)+.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };

/* ====== Render Today (3 lines per view, 7 clicks → wrap) ====== */
function renderToday(){
  const day=getTodayDay(); const state=ensureDayState(day);
  const title=TITLES[day-1]; const bank = bank21(title);
  const start = (state.bankOffset||0) % 21;
  const lines = [0,1,2].map(i=> bank[(start+i)%21]);

  elDayNum.textContent=day; elTitle.textContent=title; elLines.innerHTML='';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const sttSupported=!!SR;

  lines.forEach((pair)=>{
    const text = pair.en;
    const line=document.createElement('div'); line.className='line';

    const pEn=document.createElement('p'); pEn.textContent=text; line.appendChild(pEn);
    const pKo=document.createElement('p'); pKo.textContent=pair.ko; pKo.className='ko'; line.appendChild(pKo);

    const row=document.createElement('div'); row.className='row';

    const btnPlay=document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='▶︎ 듣기';
    btnPlay.onclick=()=>{ speak(text); };

    const btnRec=document.createElement('button'); btnRec.className='btn pri'; btnRec.textContent='● 말하기(연습)';
    const btnStop=document.createElement('button'); btnStop.className='btn'; btnStop.textContent='■ 중지'; btnStop.disabled=true;
    if(!sttSupported){ btnRec.disabled=true; btnStop.disabled=true; btnRec.title='이 기기에서는 음성 인식이 제한됩니다.'; }

    const scoreBox=document.createElement('span'); scoreBox.className='score'; scoreBox.style.marginLeft='6px';
    const fbBox=document.createElement('span'); fbBox.className='feedback'; fbBox.textContent='';

    let rec=null, recActive=false, hypAccum='';
    function setRecUI(active){ if(active){ btnRec.classList.add('rec'); btnRec.textContent='● 듣는 중…(연습)'; } else { btnRec.classList.remove('rec'); btnRec.textContent='● 말하기(연습)'; } }
    function startLineRec(){
      rec = createRecognizer((e)=>{
        for(let i=e.resultIndex;i<e.results.length;i++){
          const r=e.results[i];
          if(r.isFinal){ hypAccum += (hypAccum?' ':'') + r[0].transcript; }
        }
      }, ()=>{
        if(recActive){ try{ rec=null; setTimeout(startLineRec, 200); }catch(_){} }
        else {
          const s=scoreSentence(text,hypAccum);
          const fb = (s===100) ? ['잘했어요!'] : wordDiffFeedback(text,hypAccum);
          scoreBox.textContent=`연습 점수 ${s}%`;
          fbBox.textContent=fb.join(' · ');
          btnRec.disabled=false; btnStop.disabled=true; btnStop.textContent='■ 중지';
          setRecUI(false);
        }
      }, {continuous:true, interim:false});
      if(rec){ try{ rec.start(); }catch(_){ toast('마이크 시작 실패. 권한/다른 앱 점검 후 다시 시도해 주세요.'); } }
    }
    btnRec.onclick=()=>{ if(rec||!sttSupported) return; recActive=true; hypAccum=''; btnRec.disabled=true; btnStop.disabled=false; setRecUI(true); toast('말해 보세요… (연습)'); startLineRec(); };
    btnStop.onclick=()=>{ if(!rec) return; recActive=false; try{ rec.stop(); }catch(_){} btnStop.disabled=true; btnStop.textContent='중지됨'; };

    row.appendChild(btnPlay); row.appendChild(btnRec); row.appendChild(btnStop); row.appendChild(scoreBox);
    line.appendChild(row); line.appendChild(fbBox);
    elLines.appendChild(line);
  });

  // 3문장 연속 듣기 & 말하기(점수 반영)
  const allRow=document.createElement('div'); allRow.className='row';

  const btnAll=document.createElement('button');
  btnAll.className='btn';
  btnAll.textContent='▶︎ 3문장 연속 듣기';
  btnAll.onclick=()=> speakQueue(lines.map(x=>x.en),
    ()=>{btnAll.disabled=true; btnAll.textContent='▶︎ 재생 중…';},
    ()=>{btnAll.disabled=false; btnAll.textContent='▶︎ 3문장 연속 듣기';});
  allRow.appendChild(btnAll);

  const btnRecAll=document.createElement('button');
  btnRecAll.className='btn pri';
  btnRecAll.textContent='● 3문장 연속 말하기(점수 반영)';
  if(!sttSupported){ btnRecAll.disabled=true; btnRecAll.title='이 기기에서는 음성 인식을 제한됩니다.'; }
  btnRecAll.onclick=()=> practiceReciteOneShot_final(lines.map(x=>x.en), btnRecAll);
  allRow.appendChild(btnRecAll);

  elLines.appendChild(allRow);

  updateProgress();
}

/* ====== Progress ====== */
function updateProgress(){
  const day=getTodayDay(); const d=ensureDayState(day);
  const avg = (typeof d.comboScore==='number') ? d.comboScore : 0;
  elAvg.textContent = avg>0 ? (avg+'%') : '—';
  elMeter.style.width = `${avg}%`;
  const pass = avg>=80;
  const elDone=document.getElementById('markDone');
  elDone.disabled=!pass; elDone.textContent=pass?'✔ 조건 충족! 오늘 완료하기':'✔ 오늘 완료로 표시';
  elDone.onclick=()=>{ if(pass){ markDone(getTodayDay(),avg); } };
}

function markDone(day,avg){
  const k='Day'+day; const title=TITLES[day-1];
  const now=todayKey();
  prog[k] = { ...(prog[k]||{}), comboScore:avg, done:true };
  prog.lastDone=k;
  const prev='Day'+(day-1), prevStreak=prog.streak||0;
  prog.streak = (day>1 && prog[prev]&&prog[prev].done)? prevStreak+1 : 1;
  if(!Array.isArray(prog._history)) prog._history=[];
  prog._history = prog._history.filter(h=>h.day!==day);
  prog._history.push({ day, date: now, title, avg });
  saveProg(prog);
  document.getElementById('streak').textContent=prog.streak;
  document.getElementById('lastDone').textContent=prog.lastDone;
  toast('✅ 오늘 학습 완료! 기록에 저장했어요.');
  renderChallenge100(); renderHistory();
}

/* ====== 3문장 연속 말하기 패널 ====== */
function concatenateLines(lines){ return lines.join(' '); }
function practiceReciteOneShot_final(lines, triggerBtn){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('이 브라우저는 음성 인식을 지원하지 않아요.'); return; }

  const origText = triggerBtn ? triggerBtn.textContent : '';
  function restoreTrigger(){
    if(triggerBtn){
      triggerBtn.classList.remove('rec');
      triggerBtn.disabled = false;
      triggerBtn.textContent = origText || '● 3문장 연속 말하기(점수 반영)';
    }
  }

  const wrap=document.createElement('div'); wrap.className='practice';
  const box=document.createElement('div'); box.className='box';
  const refs = lines.map((s,i)=>`${i+1}. ${s}`).join('\n');
  box.innerHTML = `
    <h3>🎤 3문장 연속 말하기 (점수 반영)</h3>
    <div class="ref">아래 3문장을 한 번에 자연스럽게 말해 보세요.\n\n${refs}</div>
    <div class="meta">
      <button class="btn pri" id="btnStart">● 말하기 시작</button>
      <button class="btn" id="btnStop" disabled>■ 중지</button>
      <span class="small">여러 번 시도 가능. <b>닫기</b>를 누른 시점의 점수가 반영됩니다.</span>
    </div>
    <div class="result" id="resultBox" style="display:none">
      <div>점수: <b id="sumScore">—</b></div>
      <div class="feedback" id="sumFb"></div>
      <div style="margin-top:8px"><button class="btn" id="btnClosePanel">닫기</button></div>
    </div>
  `;
  wrap.appendChild(box); document.body.appendChild(wrap);

  const btnStart = box.querySelector('#btnStart');
  const btnStop  = box.querySelector('#btnStop');
  const resultBox= box.querySelector('#resultBox');
  const sumScore = box.querySelector('#sumScore');
  const sumFb    = box.querySelector('#sumFb');

  let rec=null, finalText='', lastScore=null, lastFb='';
  let recActive=false;
  let canStart=true;

  function resetStartUI(){ btnStart.classList.remove('rec'); btnStart.textContent='● 말하기 시작'; btnStart.disabled=false; }
  function startRecognizer(){
    rec = createRecognizer(onResult, onEnd, {continuous:true, interim:false});
    if(rec){ try{ rec.start(); }catch(_){ can
