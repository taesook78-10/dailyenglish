<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>오늘의 영어 학습</title>

  <!-- ✅ (변경) topics.js를 먼저 로드 -->
  <script src="./topics.js?v=20250915"></script>

  <!-- ✅ (변경) SHIM: TOPICS → TITLES / TOPIC_BANKS 매핑
       - 초과분만 .slice(0,21)로 자르고
       - ⛔ 부족분 자동 채움(placeholder) 제거 -->
  <script>
  (function(){
    if (!Array.isArray(window.TOPICS)) {
      console.error("[topics] window.TOPICS가 없습니다. topics.js를 먼저 로드했는지 확인하세요.");
      return;
    }
    // 기존 코드 호환: 주제 목록
    window.TITLES = window.TOPICS.map(t => t.topic);

    // 기존 코드 호환: 주제별 문장 뱅크 [{en,ko}] 배열
    const banks = {};
    for (const item of window.TOPICS) {
      const arr = Array.isArray(item.sentences) ? item.sentences : [];
      let mapped = arr.map(s =>
        (typeof s === "string")
          ? ({ en: String(s), ko: "" })
          : ({ en: (s && s.en) ? String(s.en) : "", ko: (s && s.ko) ? String(s.ko) : "" })
      );
      // ⬇️ 21개 초과만 자르기 (부족분 자동 보충 제거)
      mapped = mapped.slice(0, 21);

      banks[item.topic] = mapped;
    }
    window.TOPIC_BANKS = banks;
  })();
  </script>

  <!-- ▼▼▼ 이하: 기존 화면/스타일 그대로 (손대지 않음) ▼▼▼ -->
  <style>
    :root{
      --bg:#f8fafc; --fg:#0f172a; --card:#ffffff;
      --brand:#4f46e5; --brand-dark:#4338ca;
      --muted:#475569; --chip-green:#16a34a; --surface:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif;
    }
    header{
      background:var(--brand); color:#fff; padding:1rem; text-align:center;
      font-weight:800; letter-spacing:.2px;
    }
    main{ max-width:900px; margin:auto; padding:1rem; }
    .card{
      background:var(--card); border-radius:18px;
      box-shadow:0 10px 30px rgba(2,6,23,.06);
      padding:1.5rem; margin:1.5rem 0;
    }
    .row{ display:flex; gap:.5rem; align-items:center; justify-content:flex-end; margin-bottom:.5rem; flex-wrap:wrap; }
    .chip{ display:inline-block; padding:.38rem .75rem; border-radius:9999px; font-size:.92rem; font-weight:700; }
    .chip.score{ background:var(--brand); color:#fff; }
    .chip.success{ background:var(--chip-green); color:#fff; }
    .meta{ font-size:.86rem; color:var(--muted); display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .meta .dot{ width:5px; height:5px; border-radius:50%; background:#cbd5e1; display:inline-block; }
    #topicTitle{ margin:.25rem 0 1rem; line-height:1.25; }
    .sentence{
      margin:.6rem 0; padding:.85rem .95rem; border-radius:10px; background:var(--surface);
      border:1px solid #e2e8f0;
    }
    .sentence b{ display:block; margin-bottom:.25rem }
    button{
      margin-top:1rem; background:var(--brand); color:#fff; border:none;
      padding:.75rem 1.1rem; border-radius:10px; font-size:1rem; cursor:pointer;
      transition:transform .02s ease-in-out, background .15s ease;
    }
    button:hover{ background:var(--brand-dark); }
    button:active{ transform:translateY(1px); }
  </style>
</head>
<body>
  <header>오늘의 영어 학습</header>

  <main>
    <div class="card">
      <!-- 점수칩(왼쪽) + 성공칩(오른쪽) : 기존 유지 -->
      <div class="row">
        <span id="scoreChip" class="chip score">점수: 0%</span>
        <span id="successChip" class="chip success" style="display:none;">성공 🎉</span>
      </div>

      <div class="meta">
        <span>Day <span id="dayNum">1</span></span>
        <span class="dot"></span>
        <span>KST <span id="todayKST">—</span></span>
      </div>

      <h2 id="topicTitle">주제</h2>

      <div id="sentences" aria-live="polite"></div>

      <button id="retryBtn" type="button" aria-label="다시하기: 다음 3문장 보기">다시하기 (3문장 교체)</button>
    </div>
  </main>

  <!-- ▼▼▼ 이하: 기존 스크립트 로직 그대로 (손대지 않음) ▼▼▼ -->
  <script>
    // 한국시간
    function kstNow(){
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset()*60000;
      return new Date(utc + 9*60*60000);
    }
    function fmtKst(d){
      const z = n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
    }
    function todayKeyKST(){ return kstNow().toISOString().slice(0,10); }

    // 진행 상태
    const LS_KEY="eng_app_progress_v2";
    const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
    if (!saved.startDate) {
      saved.startDate = todayKeyKST();
      saved.scoreByDate = {};
      localStorage.setItem(LS_KEY, JSON.stringify(saved));
    }
    function computeDayFromStart(){
      const start = new Date(saved.startDate + "T00:00:00+09:00");
      const diffDays = Math.floor((kstNow() - start) / 86400000);
      return Math.max(1, diffDays + 1);
    }

    // 데이터 접근자 (기존 사용 방식 유지)
    // TITLES, TOPIC_BANKS 는 위의 SHIM에서 세팅됨
    function bank21(title){
      // ⬇️ 외부 뱅크가 있으면 그대로 반환
      if (window.TOPIC_BANKS && Array.isArray(window.TOPIC_BANKS[title])) {
        return window.TOPIC_BANKS[title];
      }
      // ⛔ 자동 채움(placeholder) 제거: 더 이상 여기서 임의 생성하지 않음
      return [];
    }

    // 상태 & DOM
    let score = 0;
    let offset = 0;    // 0,3,6,...,18
    let lastDate = todayKeyKST();

    const $dayNum = document.getElementById("dayNum");
    const $todayKST = document.getElementById("todayKST");
    const $topicTitle = document.getElementById("topicTitle");
    const $sentences = document.getElementById("sentences");
    const $scoreChip = document.getElementById("scoreChip");
    const $successChip = document.getElementById("successChip");
    const $retryBtn = document.getElementById("retryBtn");

    function currentTitleByDay(day){
      // TITLES가 없다면 안전망으로 빈 문자열
      const titles = Array.isArray(window.TITLES) ? window.TITLES : [];
      return titles[(day - 1) % (titles.length || 1)] || "";
    }

    function render(){
      const day = computeDayFromStart();
      const title = currentTitleByDay(day);

      $dayNum.textContent = day;
      const now = kstNow();
      $todayKST.textContent = fmtKst(now);
      $topicTitle.textContent = title || "주제";

      const bank = bank21(title);
      $sentences.innerHTML = "";

      // ⛔ 여기서도 자동 채움 금지: bank가 21 미만이면 있는 만큼만 표시
      const group = [ bank[(offset+0)%21], bank[(offset+1)%21], bank[(offset+2)%21] ]
        .filter(Boolean);

      group.forEach(s=>{
        const div = document.createElement("div");
        div.className = "sentence";
        div.innerHTML = `<b>${String(s.en || "").replace(/[&<>"']/g,(m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])))}</b>${String(s.ko || "")}`;
        $sentences.appendChild(div);
      });

      $scoreChip.textContent = `점수: ${score}%`;
      $successChip.style.display = (score >= 80) ? "inline-block" : "none";
    }

    $retryBtn.addEventListener("click", ()=>{
      offset = (offset + 3) % 21;
      score = Math.min(100, score + 10);
      render();
    });

    setInterval(()=>{ $todayKST.textContent = fmtKst(kstNow()); }, 1000);
    setInterval(()=>{
      const nowKey = todayKeyKST();
      if (nowKey !== lastDate) {
        lastDate = nowKey;
        offset = 0;
        score  = 0;
        render();
      }
    }, 60 * 1000);

    render();
  </script>
</body>
</html>
