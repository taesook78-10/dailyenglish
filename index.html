<!DOCTYPE html>
<html lang="ko">

<head>
  <!-- 1) ì£¼ì œ ë°ì´í„° íŒŒì¼: ë‚´ê°€ ë§Œë“  topics.js (TOPICS ë°°ì—´ í¬í•¨) -->
<script src="./topics.js?v=20250914"></script>
<script> â€¦shimâ€¦ </script>

<!-- 2) í˜¸í™˜ ì…ˆ(shim): TOPICS â†’ ê¸°ì¡´ ì½”ë“œê°€ ê¸°ëŒ€í•˜ëŠ” TITLES/TOPIC_BANKSë¡œ ë³€í™˜ -->
<script>
(function(){
  if (!Array.isArray(window.TOPICS)) {
    console.error("[topics] window.TOPICSê°€ ì—†ìŠµë‹ˆë‹¤. topics.jsë¥¼ ë¨¼ì € ë¡œë“œí–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
    return;
  }
  // ê¸°ì¡´ ì½”ë“œ í˜¸í™˜: ì œëª© ë°°ì—´
  window.TITLES = window.TOPICS.map(t => t.topic);

  // ê¸°ì¡´ ì½”ë“œ í˜¸í™˜: ì£¼ì œ â†’ 21ë¬¸ì¥ [{en,ko}] ë§µ
  const banks = {};
  for (const item of window.TOPICS) {
    const arr = Array.isArray(item.sentences) ? item.sentences : [];
    // ë¬¸ìì—´ë§Œ ìˆëŠ” ê²½ìš° {en: "...", ko:""}ë¡œ í¬ì¥
    let mapped = arr.map(s => (typeof s === "string") ? ({en:String(s), ko:""}) : ({
      en: (s && s.en) ? String(s.en) : "",
      ko: (s && s.ko) ? String(s.ko) : ""
    }));
    // 21ê°œë¡œ ë§ì¶”ê¸° (ì´ˆê³¼ì‹œ ìë¥´ê³ , ë¶€ì¡±ì‹œ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ ì±„ì›€)
    mapped = mapped.slice(0, 21);
    while (mapped.length < 21) {
      const i = mapped.length + 1;
      mapped.push({ en:`Placeholder sentence ${i} for ${item.topic}.`, ko:"" });
    }
    banks[item.topic] = mapped;
  }
  window.TOPIC_BANKS = banks;
})();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily 3 Lines </title>
  <script src="./topics.js?v=20250914"></script>
  <script>
    (function(){
      if (!Array.isArray(window.TOPICS)) {
        console.error("[topics] window.TOPICSê°€ ì—†ìŠµë‹ˆë‹¤. topics.jsë¥¼ ë¨¼ì € ë¡œë“œí–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        return;
      }
      window.TITLES = window.TOPICS.map(t => t.topic);
      const banks = {};
      for (const item of window.TOPICS) {
        const arr = Array.isArray(item.sentences) ? item.sentences : [];
        banks[item.topic] = arr.map(s => {
          if (typeof s === "string") return { en: s, ko: "" };
          return { en: (s && s.en) ? String(s.en) : "", ko: (s && s.ko) ? String(s.ko) : "" };
        }).slice(0, 21);
        while (banks[item.topic].length < 21) {
          const i = banks[item.topic].length + 1;
          banks[item.topic].push({ en: `Placeholder sentence ${i} for ${item.topic}.`, ko: "" });
        }
      }
      window.TOPIC_BANKS = banks;
    })();
  </script>
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="/dailyenglish/manifest.webmanifest?v=10">
  <link rel="apple-touch-icon" href="/dailyenglish/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/dailyenglish/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/dailyenglish/icon-192.png">
  <style>
  :root{
    --bg:#0b1020; --card:#111a34; --ink:#e8eefc; --muted:#9fb0df;
    --pri:#5b8cff; --good:#21d39b; --warn:#ffb454; --bad:#ff5c7a;
    --ring:#31457a; --ring-strong:#4a63a8;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
    background:
      radial-gradient(80% 60% at 10% 0%,#15224b 0%,#0b1020 60%),
      radial-gradient(80% 60% at 100% 100%,#0f1834 0%,#0b1020 60%);
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(91,140,255,.15);color:#cfe0ff;border:1px solid var(--ring);font-size:12px}
  nav{display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap; align-items:center}
  .tab{padding:10px 14px;border-radius:12px;background:#101733;border:1px solid var(--ring);cursor:pointer;color:#a7b3d6}
  .tab.active{background:#141f45;color:var(--ink);border-color:#3a5296}
  select{appearance:none;background:#101733;border:1px solid var(--ring);color:#e8eefc;padding:10px 12px;border-radius:10px;min-height:44px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg,#111a34,#0f1731);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .hd{display:flex;align-items:flex-start;justify-content:space-between;padding:18px 18px 0}
  .card .body{padding:14px 18px 20px}
  .title{font-size:26px;margin-top:4px;font-weight:900;letter-spacing:.3px}
  .subtitle{font-size:13px;color:var(--muted)}
  .line{border:1px solid var(--ring);border-radius:16px;padding:14px;margin:12px 0;background:#0f1731}
  .line p{margin:0 0 8px;font-size:18px;line-height:1.5}
  .line p.ko{margin:0 0 10px; font-size:15.5px; line-height:1.6; color:#cbd4f5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .btn{
    appearance:none;border:none;border-radius:12px;padding:10px 14px;
    background:#17224a;color:#e8eefc;border:1px solid #2b3f7a;cursor:pointer;min-height:44px;
    transition:transform .06s ease, filter .15s ease, box-shadow .15s ease;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.pri{background:linear-gradient(180deg,#3d64ff,#2b4bd4);border-color:#3b57e0}
  .btn.warn{background:#3a2a0e;border-color:#9f6b18}
  .btn.ghost{background:transparent;border-color:#2b3f7a}
  .btn.rec{background:linear-gradient(180deg,#ff5c7a,#e44360); border-color:#ff7f97; color:white; box-shadow:0 0 0 2px rgba(255,92,122,.25) inset}

  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px;border:1px solid var(--ring);border-radius:12px;background:#101733;font-size:13px}
  .chip::before{content:''; width:8px; height:8px; border-radius:50%; background:linear-gradient(180deg,#a7baff,#5b8cff); box-shadow:0 0 0 2px rgba(91,140,255,.15);}
  .score{font-weight:900}

  .meter{height:12px;background:#0e1330;border-radius:999px;border:1px solid var(--ring);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff5c7a,#ffb454,#5b8cff,#21d39b)}

  .kpi{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
  .day{aspect-ratio:1/1;border:1px solid #2d3d72;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0e1430;color:#c9d4ff;font-weight:700; font-size:14px}
  @media (max-width:520px){ .calendar{grid-template-columns:repeat(7,1fr)} .day{font-size:13px} .line p{font-size:16px} .title{font-size:22px}}

  .toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;pointer-events:none}
  .toast span{pointer-events:auto;background:#101733;border:1px solid var(--ring);padding:10px 14px;border-radius:12px}

  .small{font-size:12px;color:#a7b3d6}
  .hint{font-size:12.5px;color:#d3dcff;background:#16214a;border:1px solid #2e4489;padding:10px 12px;border-radius:10px}

  /* ì—°ì† ë§í•˜ê¸° íŒ¨ë„ */
  .practice{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;}
  .practice .box{width:min(720px,94vw); max-height:92vh; overflow:auto; background:#101733; border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:var(--shadow);}
  .practice .box h3{margin:0 0 12px; font-size:18px;}
  .practice .ref{font-size:14.5px; color:#cfe0ff; margin:6px 0 12px; white-space:pre-wrap; line-height:1.6}
  .practice .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
  .practice .result{margin-top:12px; padding:12px; border:1px solid var(--ring); border-radius:12px; background:#0f1731}
  .feedback{display:block; font-size:12.5px; color:#cfe0ff; opacity:.95}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily 3 Lines <span class="badge">100ì¼ ì±Œë¦°ì§€</span></h1>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="btnRetry">âŸ² ë‹¤ì‹œ í•˜ê¸°</button>
        <button class="btn warn" id="btnReset">âŸ² ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="home">ì˜¤ëŠ˜ì˜ í•™ìŠµ</button>
      <button class="tab" data-view="challenge">ì±Œë¦°ì§€</button>
      <button class="tab" data-view="progress">ê¸°ë¡</button>

      <div style="display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:wrap">
        <label class="small" for="voiceSelect">Voice</label>
        <select id="voiceSelect" title="TTS Voice"></select>

        <span class="small">ì†ë„</span>
        <button class="btn" id="rateDown">â€“</button>
        <span id="rate" class="small">1.0x</span>
        <button class="btn" id="rateUp">+</button>
      </div>
    </nav>

    <section id="home" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="subtitle">ì˜¤ëŠ˜ì˜ ì œëª© (Day <span id="dayNum">1</span>)</div>
            <div class="title" id="dayTitle">â€”</div>
          </div>
          <!-- ì ìˆ˜ ì¹©ì€ ì´ ì¹´ë“œì—ì„œ ì œê±°(ìš”ì²­ì— ë”°ë¼ ì˜¤ë¥¸ìª½ â€˜ì˜¤ëŠ˜ì˜ ëª©í‘œâ€™ ì¹´ë“œ í—¤ë”ë¡œ ì´ë™) -->
        </div>
        <div class="body" id="lines"></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2>
          <!-- ì˜¤ë¥¸ìª½ì— '80ì  ì´ìƒ ì„±ê³µ' ë¨¼ì €, ê·¸ ì˜¤ë¥¸ìª½ì— ì ìˆ˜ ì¹© ë°°ì¹˜ -->
          <div class="kpi">
            <div class="chip">80ì  ì´ìƒ ì„±ê³µ</div>
            <div class="chip">ì ìˆ˜: <span class="score" id="avgScore">â€”</span></div>
          </div>
        </div>
        <div class="body">
          <div class="meter" title="3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸° ì ìˆ˜"><i id="meterBar"></i></div>
          <div style="height:12px"></div>
          <button class="btn pri" id="markDone" disabled>âœ” ì˜¤ëŠ˜ ì™„ë£Œë¡œ í‘œì‹œ</button>
          <div style="height:12px"></div>
          <div class="hint">ì„¸ ë¬¸ì¥ì„ ëª¨ë‘ ë“£ê³ (â–¶ï¸) <b>3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)</b>ì—ì„œ 80ì  ì´ìƒì´ë©´ ì™„ë£Œí•  ìˆ˜ ìˆì–´ìš”.</div>
          <div style="height:12px"></div>
          <div class="kpi">
            <div class="chip">ì—°ì†ì¼ìˆ˜: <b id="streak">0</b>ì¼</div>
            <div class="chip">ë§ˆì§€ë§‰ ì™„ë£Œ: <span id="lastDone">â€”</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" style="display:none">
      <div class="card">
        <div class="hd"><h2>100ì¼ ì±Œë¦°ì§€</h2><div class="chip">Day 1 â†’ Day 100</div></div>
        <div class="body">
          <div class="calendar" id="challenge100"></div>
        </div>
      </div>
    </section>

    <section id="progress" style="display:none">
      <div class="card">
        <div class="hd"><h2>ì ìˆ˜ ê¸°ë¡</h2></div>
        <div class="body"><div id="history"></div></div>
      </div>
    </section>

    <div class="toast" id="toast" style="display:none"><span id="toastMsg"></span></div>
  </div>

<script>
/* ====== Storage / Date Utilities ====== */
const LS_USER='d3l_user', LS_PROGRESS='d3l_progress';
function todayKey(){ const f = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit'}); return f.format(new Date()); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER)||'{"ttsRate":1,"lang":"en-US","voiceURI":""}'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function loadProg(){ return JSON.parse(localStorage.getItem(LS_PROGRESS)||'{}'); }
function saveProg(p){ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }

let user=loadUser(), prog=loadProg();
if(!prog._startedAt){ prog._startedAt=todayKey(); }
if(!prog._currentDay){ prog._currentDay=1; }
if(!prog._lastDate){ prog._lastDate=todayKey(); } // KST ê¸°ì¤€ ë§ˆì§€ë§‰ ë³¸ ë‚ ì§œ
if(!Array.isArray(prog._history)) { prog._history = []; }
saveProg(prog);

function computeDayFromStart(){
  const start = new Date(prog._startedAt+'T00:00:00+09:00');
  return Math.max(1, Math.min(100, Math.floor((Date.now()-start)/86400000)+1));
}
function getTodayDay(){
  // _currentDayëŠ” ìë™ìœ¼ë¡œ ìƒˆë‚ ì— ì—…ë°ì´íŠ¸ë¨(ì•„ë˜ autoDayRollover ì°¸ê³ )
  const cur=prog._currentDay || computeDayFromStart();
  const d=Math.max(1,Math.min(100,cur));
  if(prog._currentDay!==d){ prog._currentDay=d; saveProg(prog); }
  return d;
}

/* ====== Data (100 Titles) ====== */
const TITLES=[ 'Morning Routine','Commuting','Coffee Break','Emails','Team Meeting','Project Update','Lunch Out','Groceries','Gym','Evening Walk',
  'Streaming Show','Weekend Plan','Laundry','Room Cleaning','Errands','Bank Visit','Pharmacy','Salon','Car Wash','Pet Care',
  'Cooking Dinner','Takeout','Birthday Party','Small Talk','Weather Chat','Sports Talk','News Catch-up','Book Club','Movie Night','Concert',
  'Coffee Chat','Study Session','Library Visit','Note Taking','Presentation Prep','Public Speaking','Mentor Advice','Goal Setting','Habit Tracking','Budgeting',
  'Online Shopping','Return/Refund','Customer Service','Travel Plan','Packing','Airport','Hotel Check-in','City Tour','Photo Walk','Museum',
  'Park Picnic','Beach Day','Hiking','Rainy Day','Snow Day','Heat Wave','Cold Snap','Sick Day','Clinic Visit','Dentist Visit',
  'Back to Work','Overtime','Deadline Push','Celebration','Thank-you Notes','Apology','Making Plans','Canceling Plans','Running Late','Time Management',
  'Morning Coffee','Afternoon Slump','Power Nap','Evening Class','Night Drive','Late Snack','Phone Call','Video Call','Texting','Social Media',
  'Digital Detox','Mindfulness','Journaling','Reading','Music Playlist','Podcast','Language Practice','Networking','Interview Prep','Part-time Job',
  'Side Project','Coding Session','Design Draft','Feedback Round','Revision','Final Review','Presentation Day','Rest Day','Family Dinner','Friends Hangout',
  'Date Night','Neighborhood Walk','Farmerâ€™s Market','Car Maintenance','House Plants','Recycling','Donation','Volunteering','Community Event','Holiday Prep'
];

/* ====== Fixed 21-line bank per topic (EN/KR) ======
   - í…œí”Œë¦¿ì´ì§€ë§Œ "ê³ ì • 21ë¬¸ì¥"ìœ¼ë¡œ ì·¨ê¸‰ë©ë‹ˆë‹¤(ëœë¤ X).
   - titleì„ ì†Œë¬¸ìë¡œ ë¼ì›Œ ë„£ì–´ ìì—°ìŠ¤ëŸ¬ìš´ íšŒí™” ë¬¸ì¥ ì„¸íŠ¸ 21ê°œ.
*/
function bank21(title){
  const t = title.toLowerCase();
  return [
    {en:`I spent some time on ${t} today.`, ko:`ì˜¤ëŠ˜ ${t}ì— ì‹œê°„ì„ ì¢€ ì¼ì–´ìš”.`},
    {en:`I tried to keep ${t} simple.`, ko:`${t}ëŠ” ìµœëŒ€í•œ ì‹¬í”Œí•˜ê²Œ í•´ë´¤ì–´ìš”.`},
    {en:`Honestly, ${t} took longer than I expected.`, ko:`ì†”ì§íˆ ${t}ê°€ ìƒê°ë³´ë‹¤ ì˜¤ë˜ ê±¸ë ¸ì–´ìš”.`},
    {en:`I finally got around to ${t}.`, ko:`ë“œë””ì–´ ${t}ë¥¼ í•˜ê²Œ ëì–´ìš”.`},
    {en:`I checked in on ${t} after work.`, ko:`í‡´ê·¼ í›„ ${t}ë¥¼ ì ê¹ ì‚´í´ë´¤ì–´ìš”.`},
    {en:`Nothing fancy with ${t}â€”just the basics.`, ko:`${t}ëŠ” ê±°ì°½í•˜ê²Œ ì•ˆ í•˜ê³  ê¸°ë³¸ë§Œ í–ˆì–´ìš”.`},
    {en:`I made steady progress on ${t}.`, ko:`${t}ëŠ” ê¾¸ì¤€íˆ ì§„ì „ì´ ìˆì—ˆì–´ìš”.`},
    {en:`I kept ${t} practical, not overthinking it.`, ko:`${t}ëŠ” ì‹¤ìš©ì ìœ¼ë¡œ, ê³¼í•˜ê²Œ ê³ ë¯¼í•˜ì§„ ì•Šì•˜ì–´ìš”.`},
    {en:`We talked about ${t} for a bit.`, ko:`${t}ì— ëŒ€í•´ ì ê¹ ì–˜ê¸°í–ˆì–´ìš”.`},
    {en:`Iâ€™ll try to be more consistent with ${t}.`, ko:`${t}ë¥¼ ë” ê¾¸ì¤€íˆ í•´ë³¼ê²Œìš”.`},
    {en:`Next time, Iâ€™ll plan ${t} ahead.`, ko:`ë‹¤ìŒì—” ${t}ë¥¼ ë¯¸ë¦¬ ê³„íší•´ë³¼ê²Œìš”.`},
    {en:`Small wins on ${t} still count.`, ko:`${t}ì—ì„œ ì‘ì€ ì„±ì·¨ë„ ì˜ë¯¸ ìˆì–´ìš”.`},
    {en:`Slow and steady works for ${t}.`, ko:`${t}ëŠ” ì²œì²œíˆ ê¾¸ì¤€íˆê°€ ë§ëŠ” ê²ƒ ê°™ì•„ìš”.`},
    {en:`I had a quick update on ${t}.`, ko:`${t} ê´€ë ¨í•´ ê°„ë‹¨íˆ ì—…ë°ì´íŠ¸í–ˆì–´ìš”.`},
    {en:`I kept ${t} light but useful.`, ko:`${t}ëŠ” ê°€ë³ê²Œ í–ˆì§€ë§Œ ìœ ìµí–ˆì–´ìš”.`},
    {en:`I ran into a small hiccup with ${t}.`, ko:`${t}ì—ì„œ ì‘ì€ ë¬¸ì œê°€ ìˆì—ˆì–´ìš”.`},
    {en:`I sorted out a few details for ${t}.`, ko:`${t}ì˜ ëª‡ ê°€ì§€ ë””í…Œì¼ì„ ì •ë¦¬í–ˆì–´ìš”.`},
    {en:`${t} wasnâ€™t perfect, but it moved forward.`, ko:`${t}ê°€ ì™„ë²½í•˜ì§„ ì•Šì•˜ì§€ë§Œ ì§„ì „ëì–´ìš”.`},
    {en:`I wrapped up the basics of ${t}.`, ko:`${t}ì˜ ê¸°ë³¸ì€ ë§ˆë¬´ë¦¬í–ˆì–´ìš”.`},
    {en:`I set a simple goal for ${t} this week.`, ko:`ì´ë²ˆ ì£¼ ${t}ì— ë‹¨ìˆœí•œ ëª©í‘œë¥¼ ì„¸ì› ì–´ìš”.`},
    {en:`Iâ€™m glad ${t} is finally on track.`, ko:`${t}ê°€ ë“œë””ì–´ ê¶¤ë„ì— ì˜¬ë¼ì„œ ë‹¤í–‰ì´ì—ìš”.`},
  ];
}

/* ====== Per-day state ====== */
function ensureDayState(day){
  const k='Day'+day;
  if(!prog[k]){ prog[k]={ comboScore:null, done:false, bankOffset:0 }; }
  if(typeof prog[k].bankOffset!=='number') prog[k].bankOffset=0;
  return prog[k];
}

/* ====== TTS ====== */
let voices=[]; const voiceSelect=document.getElementById('voiceSelect');
function loadVoices(){ try{ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
function sortVoices(list){ return [...list].sort((a,b)=>{ const score=v=>(/en[-_]?US/i.test(v.lang)?2:/^en/i.test(v.lang)?1:0); const ds=score(b)-score(a); return ds||((a.name||'').localeCompare(b.name||'')); }); }
function populateVoiceSelect(){ voiceSelect.innerHTML=''; if(!voices.length){ const o=document.createElement('option'); o.textContent='(no voices)'; o.value=''; voiceSelect.appendChild(o); voiceSelect.disabled=true; return; } voiceSelect.disabled=false; const sorted=sortVoices(voices); for(const v of sorted){ const o=document.createElement('option'); o.value=v.voiceURI||v.name||''; o.textContent=`${v.name} â€” ${v.lang}`; voiceSelect.appendChild(o);} const byURI=sorted.find(v=>(v.voiceURI||'')===(user.voiceURI||'')); if(byURI) voiceSelect.value=byURI.voiceURI||''; else { const enUS=sorted.find(v=>/en[-_]?US/i.test(v.lang)); voiceSelect.value=(enUS&&(enUS.voiceURI||''))||(sorted[0].voiceURI||''); user.voiceURI=voiceSelect.value; saveUser(user);} }
async function waitForVoices(timeout=2000){ if(!('speechSynthesis' in window)) return; loadVoices(); if(voices.length) return; await new Promise(res=>{ const t0=Date.now(); function h(){ loadVoices(); if(voices.length||Date.now()-t0>timeout){ speechSynthesis.removeEventListener('voiceschanged',h); res(); } } speechSynthesis.addEventListener('voiceschanged',h); setTimeout(h,timeout); }); }
if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.addEventListener('voiceschanged', ()=>{ loadVoices(); populateVoiceSelect(); }); }
function resumeTTS(){ try{ if('speechSynthesis' in window && speechSynthesis.paused) speechSynthesis.resume(); }catch(_){} }
window.addEventListener('pointerdown', resumeTTS, { once:true }); document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resumeTTS(); });
function getVoice(){ if(!voices.length) return null; if(user.voiceURI){ const v=voices.find(v=>(v.voiceURI||'')===user.voiceURI); if(v) return v; } return voices.find(v=>/en[-_]?US/i.test(v.lang))||voices.find(v=>/^en/i.test(v.lang))||voices[0]||null; }
voiceSelect.addEventListener('change', ()=>{ user.voiceURI=voiceSelect.value||''; saveUser(user); toast('TTS ë³´ì´ìŠ¤ë¥¼ ë³€ê²½í–ˆì–´ìš”.'); });
function speakOnce(text){ return new Promise(async (resolve)=>{ if(!('speechSynthesis' in window)) return resolve(); await waitForVoices(); resumeTTS(); const utt=new SpeechSynthesisUtterance(text); utt.lang=user.lang||'en-US'; utt.rate=user.ttsRate||1; const v=getVoice(); if(v){ utt.voice=v; utt.lang=v.lang||utt.lang; } utt.onend=()=>resolve(); try{ if(speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){} setTimeout(()=>speechSynthesis.speak(utt),0); }); }
async function speakQueue(arr,onStart,onEnd){ try{ onStart&&onStart(); for(const s of arr){ await speakOnce(s); } } finally{ onEnd&&onEnd(); } }
function speak(text){ return speakQueue([text]); }

/* ====== STT & Scoring ====== */
function createRecognizer(onResult,onEnd,{continuous=false,interim=false}={}){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤. (Android Chrome ê¶Œì¥)'); return null; } const rec=new SR(); rec.lang='en-US'; rec.interimResults=!!interim; rec.continuous=!!continuous; rec.maxAlternatives=1; rec.onresult=(e)=>onResult&&onResult(e); rec.onerror=(e)=>{/* ì¼ì‹œ ì˜¤ë¥˜ëŠ” onendì—ì„œ ë³µêµ¬ */}; rec.onend=()=>onEnd&&onEnd(); return rec; }
function levenshtein(a,b){ const m=a.length,n=b.length; const d=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) d[i][0]=i; for(let j=0;j<=n;j++) d[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);} } return d[m][n]; }
function norm(s){ return s.toLowerCase().replace(/[^a-z\s]/g,'').replace(/\s+/g,' ').trim(); }
function scoreSentence(ref,hyp){ const A=norm(ref),B=norm(hyp); if(!B) return 0; const dist=levenshtein(A,B); const max=Math.max(A.length,B.length)||1; return Math.max(0, Math.round((1-dist/max)*100)); }
function tokenize(s){ return norm(s).split(' ').filter(Boolean); }
function wordDiffFeedback(ref, hyp){ const R=tokenize(ref), H=tokenize(hyp); if(!H.length) return ['ì¡°ê¸ˆ ë” í¬ê²Œ, ë˜ë ·í•˜ê²Œ ë§í•´ì¤˜ìš”!']; const setH=new Set(H); const tips=[]; const missing=R.filter(w=>!setH.has(w)); if(missing.length>=2) tips.push('ë‹¨ì–´ ëª‡ ê°œ ë¹ ì¡Œì–´ìš” (ëê¹Œì§€ ë§í•˜ê¸°).'); if(H.length <= Math.max(2, Math.floor(R.length*0.6))) tips.push('ì¡°ê¸ˆ ë” ê¸¸ê²Œ, ì „ì²´ ë¬¸ì¥ì„ ë§í•´ë³´ì„¸ìš”.'); if(tips.length<=1) tips.push('ì–µì–‘ì„ ì‚´ë ¤ ìì—°ìŠ¤ëŸ½ê²Œ ì½ì–´ë³´ì„¸ìš”.'); return tips.slice(0,2); }

/* ====== UI Refs ====== */
const tabs=document.querySelectorAll('.tab');
const views={home:document.getElementById('home'),challenge:document.getElementById('challenge'),progress:document.getElementById('progress')};
const elDayNum=document.getElementById('dayNum'); const elTitle=document.getElementById('dayTitle'); const elLines=document.getElementById('lines');
const elAvg=document.getElementById('avgScore'); const elMeter=document.getElementById('meterBar');
const btnRetry=document.getElementById('btnRetry'); const btnReset=document.getElementById('btnReset');

for (const t of tabs){ t.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active');
  Object.values(views).forEach(v=>v.style.display='none'); views[t.dataset.view].style.display='';
  if(t.dataset.view==='challenge') renderChallenge100();
  if(t.dataset.view==='progress') renderHistory();
}); }

/* ====== Toast ====== */
let toastTimer; function toast(msg){ clearTimeout(toastTimer); const el=document.getElementById('toast'); const m=document.getElementById('toastMsg'); m.textContent=msg; el.style.display='flex'; toastTimer=setTimeout(()=>el.style.display='none', 1800); }

/* ====== TTS rate ====== */
const elRate=document.getElementById('rate');
elRate.textContent=(user.ttsRate||1).toFixed(1)+'x';
document.getElementById('rateDown').onclick=()=>{ user.ttsRate=Math.max(.6, Math.round(((user.ttsRate||1)-.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };
document.getElementById('rateUp').onclick=()=>{ user.ttsRate=Math.min(1.4, Math.round(((user.ttsRate||1)+.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };

/* ====== Render Today (fixed 21 bank, 3 lines per view) ====== */
function renderToday(){
  const day=getTodayDay(); const state=ensureDayState(day);
  const title=TITLES[day-1]; const bank = bank21(title);
  const start = (state.bankOffset||0) % 21;
  const lines = [0,1,2].map(i=> bank[(start+i)%21]);

  elDayNum.textContent=day; elTitle.textContent=title; elLines.innerHTML='';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const sttSupported=!!SR;

  lines.forEach((pair)=>{
    const text = pair.en;
    const line=document.createElement('div'); line.className='line';

    const pEn=document.createElement('p'); pEn.textContent=text; line.appendChild(pEn);
    const pKo=document.createElement('p'); pKo.textContent=pair.ko; pKo.className='ko'; line.appendChild(pKo);

    const row=document.createElement('div'); row.className='row';

    const btnPlay=document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='â–¶ï¸ ë“£ê¸°';
    btnPlay.onclick=()=>{ speak(text); };

    const btnRec=document.createElement('button'); btnRec.className='btn pri'; btnRec.textContent='â— ë§í•˜ê¸°(ì—°ìŠµ)';
    const btnStop=document.createElement('button'); btnStop.className='btn'; btnStop.textContent='â–  ì¤‘ì§€'; btnStop.disabled=true;
    if(!sttSupported){ btnRec.disabled=true; btnStop.disabled=true; btnRec.title='ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤.'; }

    const scoreBox=document.createElement('span'); scoreBox.className='score'; scoreBox.style.marginLeft='6px';
    const fbBox=document.createElement('span'); fbBox.className='feedback'; fbBox.textContent='';

    // ì—°ìŠµ: ë°˜ë“œì‹œ ì‚¬ìš©ìê°€ ì¤‘ì§€ ëˆŒëŸ¬ì•¼ ì¢…ë£Œ(ìë™ ì¢…ë£Œì‹œ ì¬ì‹œì‘)
    let rec=null, recActive=false, hypAccum='';
    function setRecUI(active){ if(active){ btnRec.classList.add('rec'); btnRec.textContent='â— ë“£ëŠ” ì¤‘â€¦(ì—°ìŠµ)'; } else { btnRec.classList.remove('rec'); btnRec.textContent='â— ë§í•˜ê¸°(ì—°ìŠµ)'; } }
    function startLineRec(){
      rec = createRecognizer((e)=>{
        for(let i=e.resultIndex;i<e.results.length;i++){
          const r=e.results[i];
          if(r.isFinal){ hypAccum += (hypAccum?' ':'') + r[0].transcript; }
        }
      }, ()=>{
        if(recActive){ try{ rec=null; setTimeout(startLineRec, 200); }catch(_){} }
        else {
          const s=scoreSentence(text,hypAccum);
          const fb = (s===100) ? ['ì˜í–ˆì–´ìš”!'] : wordDiffFeedback(text,hypAccum);
          scoreBox.textContent=`ì—°ìŠµ ì ìˆ˜ ${s}%`;
          fbBox.textContent=fb.join(' Â· ');
          btnRec.disabled=false; btnStop.disabled=true; btnStop.textContent='â–  ì¤‘ì§€';
          setRecUI(false);
        }
      }, {continuous:true, interim:false});
      if(rec){ try{ rec.start(); }catch(_){ toast('ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨. ê¶Œí•œ/ë‹¤ë¥¸ ì•± ì ê²€ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'); } }
    }
    btnRec.onclick=()=>{ if(rec||!sttSupported) return; recActive=true; hypAccum=''; btnRec.disabled=true; btnStop.disabled=false; setRecUI(true); toast('ë§í•´ ë³´ì„¸ìš”â€¦ (ì—°ìŠµ)'); startLineRec(); };
    btnStop.onclick=()=>{ if(!rec) return; recActive=false; try{ rec.stop(); }catch(_){} btnStop.disabled=true; btnStop.textContent='ì¤‘ì§€ë¨'; };

    row.appendChild(btnPlay); row.appendChild(btnRec); row.appendChild(btnStop); row.appendChild(scoreBox);
    line.appendChild(row); line.appendChild(fbBox);
    elLines.appendChild(line);
  });

  // 3ë¬¸ì¥ ì—°ì† ë“£ê¸° & ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)
  const allRow=document.createElement('div'); allRow.className='row';

  const btnAll=document.createElement('button');
  btnAll.className='btn';
  btnAll.textContent='â–¶ï¸ 3ë¬¸ì¥ ì—°ì† ë“£ê¸°';
  btnAll.onclick=()=> speakQueue(lines.map(x=>x.en),
    ()=>{btnAll.disabled=true; btnAll.textContent='â–¶ï¸ ì¬ìƒ ì¤‘â€¦';},
    ()=>{btnAll.disabled=false; btnAll.textContent='â–¶ï¸ 3ë¬¸ì¥ ì—°ì† ë“£ê¸°';});
  allRow.appendChild(btnAll);

  const btnRecAll=document.createElement('button');
  btnRecAll.className='btn pri';
  btnRecAll.textContent='â— 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)';
  if(!sttSupported){ btnRecAll.disabled=true; btnRecAll.title='ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤.'; }
  btnRecAll.onclick=()=> practiceReciteOneShot_final(lines.map(x=>x.en), btnRecAll);
  allRow.appendChild(btnRecAll);

  elLines.appendChild(allRow);

  updateProgress();
}

/* ====== Progress (ì—°ì† ë§í•˜ê¸° ì ìˆ˜ë§Œ ë°˜ì˜) ====== */
function updateProgress(){
  const day=getTodayDay(); const d=ensureDayState(day);
  const avg = (typeof d.comboScore==='number') ? d.comboScore : 0;
  elAvg.textContent = avg>0 ? (avg+'%') : 'â€”';
  elMeter.style.width = `${avg}%`;
  const pass = avg>=80;
  const elDone=document.getElementById('markDone');
  elDone.disabled=!pass; elDone.textContent=pass?'âœ” ì¡°ê±´ ì¶©ì¡±! ì˜¤ëŠ˜ ì™„ë£Œí•˜ê¸°':'âœ” ì˜¤ëŠ˜ ì™„ë£Œë¡œ í‘œì‹œ';
  elDone.onclick=()=>{ if(pass){ markDone(getTodayDay(),avg); } };
}

function markDone(day,avg){
  const k='Day'+day; const title=TITLES[day-1];
  const now=todayKey();
  prog[k] = { ...(prog[k]||{}), comboScore:avg, done:true };
  prog.lastDone=k;
  const prev='Day'+(day-1), prevStreak=prog.streak||0;
  prog.streak = (day>1 && prog[prev]&&prog[prev].done)? prevStreak+1 : 1;
  if(!Array.isArray(prog._history)) prog._history=[];
  prog._history = prog._history.filter(h=>h.day!==day);
  prog._history.push({ day, date: now, title, avg });
  saveProg(prog);
  document.getElementById('streak').textContent=prog.streak;
  document.getElementById('lastDone').textContent=prog.lastDone;
  toast('âœ… ì˜¤ëŠ˜ í•™ìŠµ ì™„ë£Œ! ê¸°ë¡ì— ì €ì¥í–ˆì–´ìš”.');
  renderChallenge100(); renderHistory();
}

/* ====== 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°: â€˜ì¤‘ì§€â€™ ëˆ„ë¥´ê¸° ì „ ìë™ì¬ì‹œì‘ ====== */
function concatenateLines(lines){ return lines.join(' '); }
function practiceReciteOneShot_final(lines, triggerBtn){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.'); return; }

  const origText = triggerBtn ? triggerBtn.textContent : '';
  function restoreTrigger(){
    if(triggerBtn){
      triggerBtn.classList.remove('rec');
      triggerBtn.disabled = false;
      triggerBtn.textContent = origText || 'â— 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)';
    }
  }

  const wrap=document.createElement('div'); wrap.className='practice';
  const box=document.createElement('div'); box.className='box';
  const refs = lines.map((s,i)=>`${i+1}. ${s}`).join('\n');
  box.innerHTML = `
    <h3>ğŸ¤ 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸° (ì ìˆ˜ ë°˜ì˜)</h3>
    <div class="ref">ì•„ë˜ 3ë¬¸ì¥ì„ í•œ ë²ˆì— ìì—°ìŠ¤ëŸ½ê²Œ ë§í•´ ë³´ì„¸ìš”.\n\n${refs}</div>
    <div class="meta">
      <button class="btn pri" id="btnStart">â— ë§í•˜ê¸° ì‹œì‘</button>
      <button class="btn" id="btnStop" disabled>â–  ì¤‘ì§€</button>
      <span class="small">ì—¬ëŸ¬ ë²ˆ ì‹œë„ ê°€ëŠ¥. <b>ë‹«ê¸°</b>ë¥¼ ëˆ„ë¥¸ ì‹œì ì˜ ì ìˆ˜ê°€ ë°˜ì˜ë©ë‹ˆë‹¤.</span>
    </div>
    <div class="result" id="resultBox" style="display:none">
      <div>ì ìˆ˜: <b id="sumScore">â€”</b></div>
      <div class="feedback" id="sumFb"></div>
      <div style="margin-top:8px"><button class="btn" id="btnClosePanel">ë‹«ê¸°</button></div>
    </div>
  `;
  wrap.appendChild(box); document.body.appendChild(wrap);

  const btnStart = box.querySelector('#btnStart');
  const btnStop  = box.querySelector('#btnStop');
  const resultBox= box.querySelector('#resultBox');
  const sumScore = box.querySelector('#sumScore');
  const sumFb    = box.querySelector('#sumFb');

  let rec=null, finalText='', lastScore=null, lastFb='';
  let recActive=false;   // ì‚¬ìš©ìê°€ â€˜ì¤‘ì§€â€™ ëˆ„ë¥´ê¸° ì „ true
  let canStart=true;

  function resetStartUI(){ btnStart.classList.remove('rec'); btnStart.textContent='â— ë§í•˜ê¸° ì‹œì‘'; btnStart.disabled=false; }
  function startRecognizer(){
    rec = createRecognizer(onResult, onEnd, {continuous:true, interim:false});
    if(rec){ try{ rec.start(); }catch(_){ canStart=true; resetStartUI(); btnStop.disabled=true; toast('ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'); } }
    else { canStart=true; resetStartUI(); btnStop.disabled=true; }
  }

  function onResult(e){
    for (let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal) finalText += (finalText?' ':'') + r[0].transcript;
    }
  }
  function onEnd(){
    if(recActive){ try{ rec=null; setTimeout(startRecognizer, 200); }catch(_){}; return; }
    const refAll = concatenateLines(lines);
    const sc = scoreSentence(refAll, finalText);
    const fb = (sc===100) ? ['ì˜í–ˆì–´ìš”!'] : wordDiffFeedback(refAll, finalText);

    lastScore = isNaN(sc)? null : sc; lastFb = fb.join(' Â· ');
    sumScore.textContent = (lastScore==null)? 'â€”' : (lastScore + '%');
    sumFb.textContent = lastFb; resultBox.style.display = '';

    btnStop.disabled = true; btnStop.textContent = 'ì¤‘ì§€ë¨';
    resetStartUI(); rec=null; setTimeout(()=>{ canStart=true; }, 200);
  }

  btnStart.onclick = ()=>{
    if(!canStart || recActive) return;
    canStart=false; finalText='';
    recActive=true;
    if(triggerBtn){ triggerBtn.classList.add('rec'); triggerBtn.disabled=true; triggerBtn.textContent='â— ì—°ì† ë§í•˜ê¸° ì¤‘â€¦'; }
    btnStart.classList.add('rec'); btnStart.textContent='â— ë“£ëŠ” ì¤‘â€¦'; btnStart.disabled=true;
    btnStop.disabled=false; btnStop.textContent='â–  ì¤‘ì§€';
    setTimeout(startRecognizer, 150);
    toast('í•œ ë²ˆì— 3ë¬¸ì¥ì„ ë§í•´ ë³´ì„¸ìš”â€¦');
  };

  btnStop.onclick = ()=>{
    if(!recActive) return;
    recActive=false;                 // ì‚¬ìš©ìê°€ ëˆŒëŸ¬ì•¼ ì¢…ë£Œ
    if(rec){ try{ rec.stop(); }catch(_){ } }
    btnStop.disabled = true; btnStop.textContent = 'ì¤‘ì§€ë¨';
  };

  box.querySelector('#btnClosePanel').onclick = ()=>{
    try{ if(recActive && rec){ recActive=false; rec.abort(); } }catch(_){}
    document.body.removeChild(wrap);
    restoreTrigger();
    if(lastScore!=null){
      const day=getTodayDay(); const d=ensureDayState(day);
      d.comboScore = lastScore; saveProg(prog);
      updateProgress();
      toast(`ì ìˆ˜ ${lastScore}% ë°˜ì˜ ì™„ë£Œ`);
    } else {
      toast('ì ìˆ˜ ì—†ì´ ë‹«ì•˜ìŠµë‹ˆë‹¤.');
    }
  };
}

/* ====== 100-Day Calendar & History ====== */
function renderChallenge100(){
  const grid=document.getElementById('challenge100'); grid.innerHTML='';
  const cur=getTodayDay();
  for(let i=1;i<=100;i++){
    const cell=document.createElement('div'); cell.className='day'; cell.textContent=i;
    const k='Day'+i; if(prog[k] && prog[k].done){ cell.classList.add('done'); cell.style.borderColor='#3b82f6'; }
    if(i===cur){ cell.style.outline='2px solid #5b8cff'; cell.style.color='#e8eefc'; }
    cell.title=k+(i===cur?' â€¢ today':'');
    cell.onclick=()=>{ prog._currentDay=i; saveProg(prog); tabs.forEach(b=>{ if(b.dataset.view==='home'){ b.click(); }}); renderToday(); };
    grid.appendChild(cell);
  }
}

function renderHistory(){
  const box=document.getElementById('history');
  let list = Array.isArray(prog._history) ? [...prog._history] : [];
  if (!list.length){
    list = Object.entries(prog)
      .filter(([k,v])=>/^Day\d+$/.test(k) && v && typeof v.comboScore==='number')
      .map(([k,v])=>({ day: parseInt(k.slice(3)), date: '', title: TITLES[parseInt(k.slice(3))-1], avg: v.comboScore }));
  }
  list.sort((a,b)=> a.day - b.day);
  if(!list.length){ box.innerHTML='<div class="small">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const frag=document.createDocumentFragment();
  list.forEach(item=>{
    const div=document.createElement('div'); div.className='line';
    const dateTxt = item.date ? ` <span class="small">(${item.date})</span>` : '';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <b>Day ${item.day} â€” ${item.title}${dateTxt}</b><span class="score">${item.avg}%</span></div>`;
    frag.appendChild(div);
  });
  box.innerHTML=''; box.appendChild(frag);
}

/* ====== Shortcuts ====== */
btnRetry.onclick=()=>{
  const day=getTodayDay(); const k='Day'+day; const st=ensureDayState(day);
  // ì ìˆ˜/ì™„ë£Œ ë¦¬ì…‹ + 3ë¬¸ì¥ ë‹¤ìŒ ë¬¶ìŒìœ¼ë¡œ ì´ë™
  st.comboScore=null; st.done=false;
  st.bankOffset = ((st.bankOffset||0) + 3) % 21;
  saveProg(prog);
  renderToday(); updateProgress();
  toast('ğŸ” ë‹¤ìŒ 3ë¬¸ì¥ìœ¼ë¡œ ë°”ê¿¨ì–´ìš”.');
};
btnReset.onclick=()=>{ if(!confirm('ì •ë§ ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? (ì·¨ì†Œ ë¶ˆê°€)')) return;
  localStorage.removeItem(LS_PROGRESS); prog=loadProg();
  prog._startedAt=todayKey(); prog._currentDay=1; prog._lastDate=todayKey(); prog._history=[];
  saveProg(prog);
  renderToday(); renderChallenge100(); renderHistory(); updateProgress(); toast('ğŸ§¹ ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ëì–´ìš”.');
};

/* ====== Auto Day Rollover (KST) ======
   - í•œêµ­ì‹œê°„ ìì •ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ Day ì—…ë°ì´íŠ¸ & í™”ë©´ ê°±ì‹ 
*/
function autoDayRolloverTick(){
  const nowKey = todayKey();
  if(prog._lastDate !== nowKey){
    prog._lastDate = nowKey;
    // ì‹œì‘ì¼ ê¸°ì¤€ Day ìë™ ê³„ì‚°
    prog._currentDay = computeDayFromStart();
    // ìƒˆ ë‚ ì—ëŠ” í•´ë‹¹ Day ìƒíƒœ ì´ˆê¸°í™”(ë¬¸ì¥ ë­‰ì¹˜ ì²˜ìŒë¶€í„° ë³´ì—¬ì£¼ë„ë¡ bankOffset=0)
    const k='Day'+prog._currentDay;
    if(!prog[k]) prog[k]={ comboScore:null, done:false, bankOffset:0 };
    saveProg(prog);
    renderToday(); renderChallenge100(); updateProgress();
    toast('ğŸ“… ìƒˆë¡œìš´ ë‚ ì´ ì‹œì‘ë˜ì–´ ì£¼ì œë¥¼ ë°”ê¿¨ì–´ìš”!');
  }
}
setInterval(autoDayRolloverTick, 60*1000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
// ì•± ì§„ì… ì§í›„ì—ë„ í•œë²ˆ í™•ì¸
autoDayRolloverTick();

/* ====== PWA ====== */
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }

/* ====== Boot ====== */
function initHeaderKPI(){ document.getElementById('streak').textContent = prog.streak||0; document.getElementById('lastDone').textContent = prog.lastDone||'â€”'; }
function updateHeaderKPI(){ document.getElementById('streak').textContent = prog.streak||0; document.getElementById('lastDone').textContent = prog.lastDone||'â€”'; }
function boot(){ initHeaderKPI(); renderToday(); renderChallenge100(); updateProgress(); }
boot();
const TOPICS = [
  {
    "topic": "Coffee & CafÃ©",
    "sentences": [
      "Could I get a medium latte to go?",
      "I usually drink two cups of coffee in the morning.",
      "If I had known the cafÃ© was closed, I would have gone somewhere else.",
      "She had already finished her espresso before I arrived.",
      "Iâ€™ve never tried pumpkin spice latte before.",
      "Can you make it half sweet, please?",
      "There was a long line at the cafÃ© yesterday.",
      "I will try a new coffee shop tomorrow.",
      "Do you take Apple Pay here?",
      "I had been waiting for ten minutes when they finally served me.",
      "Please add an extra shot in that.",
      "What pastry do you recommend this morning?",
      "The cold brew is stronger than I expected.",
      "I wish I could drink coffee late at night without losing sleep.",
      "By the time I got there, they had already run out of croissants.",
      "Iâ€™ve just spilled some coffee on the desk.",
      "Would you mind warming this up a little more?",
      "Mind if I grab a seat by the outlet?",
      "Had I known about this cafÃ© earlier, I would have come sooner.",
      "I was drinking my cappuccino while reading a book.",
      "Letâ€™s try their seasonal special today."
    ]
  },
  {
    "topic": "Morning Routine",
    "sentences": [
      "Did you brush your teeth after waking up?",
      "I always make my bed neatly before breakfast.",
      "If I had gone to bed earlier, I wouldnâ€™t feel so tired now.",
      "She had already left for school when I woke up.",
      "Iâ€™ve just finished a short morning meditation.",
      "What time do you usually wake up on weekends?",
      "I was preparing my lunch while listening to the radio.",
      "Please open the window for some fresh air.",
      "He will take a shower after his run.",
      "Had I prepared my clothes last night, I wouldnâ€™t be late now.",
      "I often skip breakfast when Iâ€™m in a hurry.",
      "Do you usually check your phone right after waking up?",
      "I used to drink only water in the morning.",
      "By the time I got downstairs, Dad had already made coffee.",
      "Letâ€™s stretch for ten minutes before starting the day.",
      "Iâ€™ve packed my bag, so Iâ€™m ready to go.",
      "Was she still sleeping at 8 a.m.?",
      "I wrote todayâ€™s to-do list before leaving home.",
      "If it rains, Iâ€™ll take the bus instead of walking.",
      "I was brushing my hair while my sister was eating.",
      "Donâ€™t forget to water the plants before leaving."
    ]
  },
  {
    "topic": "Commuting",
    "sentences": [
      "Do you take the bus or subway to work?",
      "I usually spend thirty minutes commuting.",
      "If I had left earlier, I wouldnâ€™t have missed the train.",
      "She had already boarded when I arrived at the station.",
      "Iâ€™ve been stuck in traffic for an hour.",
      "Can I sit here, or is this seat taken?",
      "I was listening to a podcast on the bus.",
      "Please tap your card at the turnstile.",
      "He will carpool with his colleague tomorrow.",
      "Had I known about the delay, I would have left home sooner.",
      "I missed my stop yesterday.",
      "Do you read books on the train?",
      "I often walk to work when the weather is nice.",
      "By the time I reached the station, the train had just left.",
      "Letâ€™s grab coffee on the way to the office.",
      "I was cycling while my friend was taking the bus.",
      "How long does it take you to commute?",
      "Iâ€™ll take a taxi if Iâ€™m running late.",
      "I had been waiting at the bus stop for fifteen minutes.",
      "Donâ€™t block the door when people are getting off.",
      "I enjoy watching people while commuting."
    ]
  },
  {
    "topic": "Emails",
    "sentences": [
      "Do you check your email every morning?",
      "I usually reply to important messages first.",
      "If I had attached the file, they wouldnâ€™t have asked again.",
      "She had already sent the report before the deadline.",
      "Iâ€™ve just received an invitation by email.",
      "Can you please proofread this email for me?",
      "I was writing an email when the phone rang.",
      "Please CC my manager on this message.",
      "He will send the draft later today.",
      "Had I known his address, I would have emailed him directly.",
      "I deleted five spam emails this morning.",
      "Do you use folders to organize your inbox?",
      "I used to ignore promotional messages.",
      "By the time I opened the email, the meeting had already started.",
      "Letâ€™s write a polite thank-you email.",
      "Iâ€™ve checked my inbox, and there are no new messages.",
      "Was she sending an email at that moment?",
      "I replied quickly to his question.",
      "If you need details, Iâ€™ll forward the original message.",
      "I had been drafting the email for half an hour.",
      "Donâ€™t forget to check for attachments before sending."
    ]
  },
  {
    "topic": "Meetings",
    "sentences": [
      "Do you attend many meetings every week?",
      "I usually take notes during meetings.",
      "If I had read the agenda, I would have been more prepared.",
      "She had already presented when I entered the room.",
      "Iâ€™ve joined three online meetings today.",
      "Can you share your screen, please?",
      "I was listening carefully when they asked a question.",
      "Please mute your microphone when not speaking.",
      "He will summarize the key points at the end.",
      "Had I been on time, I wouldnâ€™t have missed the opening remarks.",
      "I disagreed politely with one suggestion.",
      "Do you prefer online meetings or face-to-face?",
      "I used to feel nervous about speaking up.",
      "By the time the meeting ended, it had lasted two hours.",
      "Letâ€™s schedule a follow-up meeting next week.",
      "Iâ€™ve already shared the slides with the team.",
      "Were they still discussing the budget at that time?",
      "I asked a question during Q&A.",
      "If she presents tomorrow, Iâ€™ll take notes for her.",
      "I had been preparing my report before the meeting started.",
      "Donâ€™t forget to send the meeting minutes afterward."
    ]
  },
  {
    "topic": "Exercise",
    "sentences": [
      "Do you exercise every day?",
      "I usually go jogging in the park.",
      "If I had joined the gym earlier, I would be healthier now.",
      "She had already finished her workout before breakfast.",
      "Iâ€™ve been practicing yoga for three months.",
      "Can you show me how to use this machine?",
      "I was lifting weights when you called me.",
      "Please stretch before you start.",
      "He will join the basketball game this evening.",
      "Had I brought my sneakers, I would have exercised too.",
      "I skipped exercise yesterday because of the rain.",
      "Do you like swimming as exercise?",
      "I used to run every morning in high school.",
      "By the time I reached the park, the class had already started.",
      "Letâ€™s try a new Pilates routine today.",
      "Iâ€™ve already walked 10,000 steps.",
      "Were they still practicing when you left?",
      "I encouraged my friend to work out with me.",
      "If itâ€™s sunny tomorrow, Iâ€™ll go hiking.",
      "I had been training for a month before the marathon.",
      "Donâ€™t forget to drink water while exercising."
    ]
  },
  {
    "topic": "Walking",
    "sentences": [
      "Do you take a walk after dinner?",
      "I often walk my dog in the morning.",
      "If I had walked faster, I would have caught the bus.",
      "She had already gone for a walk before lunch.",
      "Iâ€™ve just returned from a long walk.",
      "Can you join me for a walk this evening?",
      "I was walking along the river when it started to rain.",
      "Please use the crosswalk for safety.",
      "He will walk to school tomorrow.",
      "Had I known the park was closed, I wouldnâ€™t have gone there.",
      "I felt refreshed after my walk yesterday.",
      "Do you like walking in the rain?",
      "I used to take long walks on weekends.",
      "By the time I arrived, they had already finished walking.",
      "Letâ€™s walk to the cafÃ© instead of driving.",
      "Iâ€™ve walked more than five kilometers today.",
      "Were you walking home when I called?",
      "I stopped to look at the flowers.",
      "If it doesnâ€™t rain, Iâ€™ll walk to work.",
      "I had been walking for an hour before I sat down.",
      "Donâ€™t forget to wear comfortable shoes for walking."
    ]
  },
  {
    "topic": "Grocery Shopping",
    "sentences": [
      "Do you go grocery shopping every week?",
      "I usually write a shopping list before going out.",
      "If I had remembered the coupons, I would have saved money.",
      "She had already bought milk before I got to the store.",
      "Iâ€™ve just paid for the groceries.",
      "Can you grab some eggs from that shelf?",
      "I was looking for rice when I saw my neighbor.",
      "Please check the expiration date before buying.",
      "He will shop for vegetables tomorrow.",
      "Had I carried a reusable bag, I wouldnâ€™t need plastic ones.",
      "I forgot to buy bread yesterday.",
      "Do you compare prices before you buy?",
      "I used to shop at the local market.",
      "By the time I arrived, they had already closed the counter.",
      "Letâ€™s buy some fruit for dessert.",
      "Iâ€™ve already picked up everything we need.",
      "Were you still shopping when I called?",
      "I tried a free food sample at the store.",
      "If thereâ€™s a discount, Iâ€™ll buy extra.",
      "I had been waiting in line for ten minutes.",
      "Donâ€™t forget to check the shopping list again."
    ]
  },
  {
    "topic": "Cooking",
    "sentences": [
      "Do you cook dinner every night?",
      "I usually make pasta on weekends.",
      "If I had followed the recipe, it would have tasted better.",
      "She had already cooked rice before I set the table.",
      "Iâ€™ve tried baking cookies for the first time.",
      "Can you chop the onions for me?",
      "I was frying eggs when the phone rang.",
      "Please wash the vegetables first.",
      "He will cook steak tonight.",
      "Had I added more salt, the soup would have been tastier.",
      "I prepared lunch boxes yesterday.",
      "Do you enjoy trying new recipes?",
      "I used to help my mom in the kitchen.",
      "By the time we sat down, the food had already cooled.",
      "Letâ€™s bake a cake together.",
      "Iâ€™ve cooked three dishes already.",
      "Were you still cooking when they arrived?",
      "I boiled the pasta until it was soft.",
      "If you mix these spices, itâ€™ll taste amazing.",
      "I had been cooking all afternoon before guests came.",
      "Donâ€™t forget to turn off the stove."
    ]
  },
  {
    "topic": "Mentor Advice",
    "sentences": [
      "I asked what success looks like before giving advice.",
      "I listened fully before suggesting any next steps.",
      "If I had understood earlier, I could have guided better.",
      "She had already prepared questions before meeting me.",
      "Iâ€™ve often encouraged them to take small steps.",
      "Can you share what challenges you are facing?",
      "I was giving feedback when the call was interrupted.",
      "Please remember to highlight strengths first.",
      "He will follow up with his mentee tomorrow.",
      "Had I known his goals, I would have advised differently.",
      "I celebrated a small win with my mentee yesterday.",
      "Do you want practical tips or encouragement?",
      "I used to give too much advice at once.",
      "By the time we finished, she had already made a plan.",
      "Letâ€™s set realistic goals together.",
      "Iâ€™ve written down key takeaways from our session.",
      "Were you still reflecting when I asked the question?",
      "I gave feedback privately and praised publicly.",
      "If you try this approach, youâ€™ll see improvement.",
      "I had been mentoring him for a year before he got promoted.",
      "Donâ€™t forget that growth takes time."
    ]
  }
];

 
</script>
  <script>
/* ê¸°ì¡´ bank21ëŠ” í…œí”Œë¦¿ ë¬¸ì¥ ìƒì„±ê¸°.
   ì•„ë˜ì—ì„œëŠ” ê¸°ì¡´ êµ¬í˜„ì„ ë°±ì—…í•´ ë‘ê³ , ì™¸ë¶€ TOPIC_BANKSê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©í•˜ë„ë¡ ì¬ì •ì˜í•©ë‹ˆë‹¤. */
(function(){
  if (typeof window.bank21 === "function") {
    window._genericBank21 = window.bank21; // ë°±ì—…
  }
  window.bank21 = function(title){
    try{
      const bankMap = window.TOPIC_BANKS || {};
      const arr = bankMap[title];
      if (Array.isArray(arr) && arr.length === 21) return arr;      // âœ… ì™¸ë¶€ ì£¼ì œ ë±…í¬ ìš°ì„ 
    }catch(e){ /* ignore */ }
    return (typeof window._genericBank21 === "function")
      ? window._genericBank21(title)                                // â¬…ï¸ ì—†ìœ¼ë©´ ê¸°ì¡´ í…œí”Œë¦¿ ë¬¸ì¥
      : [];                                                          // ìµœí›„ì˜ ì•ˆì „ë§
  };
})();
</script>
<script> â€¦bank21 overrideâ€¦ </script>
</body>
</html>
