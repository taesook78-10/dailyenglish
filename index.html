<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily 3 Lines — TTS · STT · Score · 100-Day</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="/dailyenglish/manifest.webmanifest?v=9">
  <link rel="apple-touch-icon" href="/dailyenglish/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/dailyenglish/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/dailyenglish/icon-192.png">
  <style>
  :root{
    --bg:#0b1020; --card:#111a34; --ink:#e8eefc; --muted:#9fb0df;
    --pri:#5b8cff; --good:#21d39b; --warn:#ffb454; --bad:#ff5c7a;
    --ring:#31457a; --ring-strong:#4a63a8;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --radius:18px; --radius-sm:12px;
    --pad:16px; --gap:10px; --gap-lg:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
    color:var(--ink);
    background:
      radial-gradient(80% 60% at 10% 0%,#15224b 0%,#0b1020 60%),
      radial-gradient(80% 60% at 100% 100%,#0f1834 0%,#0b1020 60%);
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(91,140,255,.15);color:#cfe0ff;border:1px solid var(--ring);font-size:12px}
  nav{display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap; align-items:center}
  .tab{padding:10px 14px;border-radius:12px;background:#101733;border:1px solid var(--ring);cursor:pointer;color:#a7b3d6; transition:filter .15s}
  .tab.active{background:#141f45;color:var(--ink);border-color:#3a5296}
  .tab:focus-visible{outline:2px solid var(--ring-strong); outline-offset:2px}
  select{
    appearance:none;background:#101733;border:1px solid var(--ring);color:#e8eefc;
    padding:10px 12px;border-radius:10px;min-height:44px;
  }
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr;}}
  .card{
    background:linear-gradient(180deg,#111a34,#0f1731);
    border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)
  }
  .card .hd{display:flex;align-items:flex-start;justify-content:space-between;padding:18px 18px 0}
  .card .body{padding:14px 18px 20px}
  .title{font-size:26px;margin-top:4px;font-weight:900;letter-spacing:.3px}
  .subtitle{font-size:13px;color:var(--muted)}
  .line{
    border:1px solid var(--ring);
    border-radius:16px;
    padding:14px;
    margin:12px 0;
    background:#0f1731
  }
  .line p{margin:0 0 8px;font-size:18px;line-height:1.5}
  .line p.ko{margin:0 0 10px; font-size:15.5px; line-height:1.6; color:#cbd4f5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .btn{
    appearance:none;border:none;border-radius:12px;padding:10px 14px;
    background:#17224a;color:#e8eefc;border:1px solid #2b3f7a;cursor:pointer;min-height:44px;
    transition:transform .06s ease, filter .15s ease, box-shadow .15s ease;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.pri{background:linear-gradient(180deg,#3d64ff,#2b4bd4);border-color:#3b57e0}
  .btn.warn{background:#3a2a0e;border-color:#9f6b18}
  .btn.ghost{background:transparent;border-color:#2b3f7a}
  .btn.rec{background:linear-gradient(180deg,#ff5c7a,#e44360); border-color:#ff7f97; color:white; box-shadow:0 0 0 2px rgba(255,92,122,.25) inset}
  .btn:focus-visible{outline:2px solid var(--ring-strong); outline-offset:2px; box-shadow:0 0 0 4px rgba(91,140,255,.18)}

  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;border:1px solid var(--ring);border-radius:12px;background:#101733;font-size:13px
  }
  .chip::before{
    content:''; width:8px; height:8px; border-radius:50%;
    background:linear-gradient(180deg,#a7baff,#5b8cff); box-shadow:0 0 0 2px rgba(91,140,255,.15);
  }
  .score{font-weight:900}

  .meter{height:12px;background:#0e1330;border-radius:999px;border:1px solid var(--ring);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff5c7a,#ffb454,#5b8cff,#21d39b)}

  .kpi{display:flex;gap:8px;flex-wrap:wrap}

  .calendar{
    display:grid;grid-template-columns:repeat(10,1fr);gap:8px
  }
  .day{
    aspect-ratio:1/1;border:1px solid #2d3d72;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:#0e1430;color:#c9d4ff;font-weight:700; font-size:14px;
    transition:filter .15s, transform .06s;
  }
  .day:hover{filter:brightness(1.06)}
  .day:active{transform:translateY(1px)}
  .day.done{
    border-color:#4a63a8;background:radial-gradient(100% 100% at 30% 20%,rgba(33,211,155,.25),transparent 60%)
  }
  @media (max-width:520px){
    .calendar{grid-template-columns:repeat(7,1fr)}
    .day{font-size:13px}
    .line p{font-size:16px}
    .title{font-size:22px}
  }

  .toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;pointer-events:none}
  .toast span{pointer-events:auto;background:#101733;border:1px solid var(--ring);padding:10px 14px;border-radius:12px}

  .small{font-size:12px;color:#a7b3d6}
  .hint{
    font-size:12.5px;color:#d3dcff;background:#16214a;border:1px solid #2e4489;
    padding:10px 12px;border-radius:10px
  }

  /* 연속 말하기 패널 */
  .practice{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;}
  .practice .box{width:min(720px,94vw); max-height:92vh; overflow:auto; background:#101733; border:1px solid var(--ring); border-radius:16px; padding:16px 16px 14px; box-shadow:var(--shadow);}
  .practice .box h3{margin:0 0 12px; font-size:18px;}
  .practice .ref{font-size:14.5px; color:#cfe0ff; margin:6px 0 12px; white-space:pre-wrap; line-height:1.6}
  .practice .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
  .practice .result{margin-top:12px; padding:12px; border:1px solid var(--ring); border-radius:12px; background:#0f1731}
  .feedback{display:block; font-size:12.5px; color:#cfe0ff; opacity:.95}

  /* 숨김 배지 */
  #diagSupport, #diagVoices { display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily 3 Lines <span class="badge">100일 챌린지</span></h1>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="btnRetry">⟲ 다시 하기</button>
        <button class="btn warn" id="btnReset">⟲ 전체 초기화</button>
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="home">오늘의 학습</button>
      <button class="tab" data-view="challenge">챌린지</button>
      <button class="tab" data-view="progress">기록</button>

      <div style="display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:wrap">
        <label class="small" for="voiceSelect">Voice</label>
        <select id="voiceSelect" title="TTS Voice"></select>

        <span class="small">속도</span>
        <button class="btn" id="rateDown">–</button>
        <span id="rate" class="small">1.0x</span>
        <button class="btn" id="rateUp">+</button>
      </div>
    </nav>

    <section id="home" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="subtitle">오늘의 제목 (Day <span id="dayNum">1</span>)</div>
            <div class="title" id="dayTitle">—</div>
          </div>
          <div class="kpi">
            <div class="chip">점수: <span class="score" id="avgScore">—</span></div>
          </div>
        </div>
        <div class="body" id="lines"></div>
      </div>

      <div class="card">
        <div class="hd"><h2>오늘의 목표</h2><div class="chip">80점 이상 성공</div></div>
        <div class="body">
          <div class="meter" title="3문장 연속 말하기 점수"><i id="meterBar"></i></div>
          <div style="height:12px"></div>
          <button class="btn pri" id="markDone" disabled>✔ 오늘 완료로 표시</button>
          <div style="height:12px"></div>
          <div class="hint">세 문장을 모두 듣고(▶︎) <b>3문장 연속 말하기(점수 반영)</b>에서 80점 이상이면 완료할 수 있어요.</div>
          <div style="height:12px"></div>
          <div class="kpi">
            <div class="chip">연속일수: <b id="streak">0</b>일</div>
            <div class="chip">마지막 완료: <span id="lastDone">—</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" style="display:none">
      <div class="card">
        <div class="hd"><h2>100일 챌린지</h2><div class="chip">Day 1 → Day 100</div></div>
        <div class="body">
          <div class="calendar" id="challenge100"></div>
        </div>
      </div>
    </section>

    <section id="progress" style="display:none">
      <div class="card">
        <div class="hd"><h2>점수 기록</h2></div>
        <div class="body"><div id="history"></div></div>
      </div>
    </section>

    <div class="toast" id="toast" style="display:none"><span id="toastMsg"></span></div>
  </div>

<script>
// ===== Storage =====
const LS_USER='d3l_user', LS_PROGRESS='d3l_progress';
function todayKey(){ const f = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit'}); return f.format(new Date()); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER)||'{"ttsRate":1,"lang":"en-US","voiceURI":""}'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function loadProg(){ return JSON.parse(localStorage.getItem(LS_PROGRESS)||'{}'); }
function saveProg(p){ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }
let user=loadUser(), prog=loadProg();
if(!prog._startedAt){ prog._startedAt=todayKey(); saveProg(prog); }
if(!prog._currentDay){ prog._currentDay=1; saveProg(prog); }
if(!Array.isArray(prog._history)) { prog._history = []; saveProg(prog); }
function computeDayFromStart(){ const start = new Date(prog._startedAt+'T00:00:00+09:00'); return Math.max(1, Math.min(100, Math.floor((Date.now()-start)/86400000)+1)); }

// ===== Data =====
const TITLES=[ 'Morning Routine','Commuting','Coffee Break','Emails','Team Meeting','Project Update','Lunch Out','Groceries','Gym','Evening Walk',
  'Streaming Show','Weekend Plan','Laundry','Room Cleaning','Errands','Bank Visit','Pharmacy','Salon','Car Wash','Pet Care',
  'Cooking Dinner','Takeout','Birthday Party','Small Talk','Weather Chat','Sports Talk','News Catch-up','Book Club','Movie Night','Concert',
  'Coffee Chat','Study Session','Library Visit','Note Taking','Presentation Prep','Public Speaking','Mentor Advice','Goal Setting','Habit Tracking','Budgeting',
  'Online Shopping','Return/Refund','Customer Service','Travel Plan','Packing','Airport','Hotel Check-in','City Tour','Photo Walk','Museum',
  'Park Picnic','Beach Day','Hiking','Rainy Day','Snow Day','Heat Wave','Cold Snap','Sick Day','Clinic Visit','Dentist Visit',
  'Back to Work','Overtime','Deadline Push','Celebration','Thank-you Notes','Apology','Making Plans','Canceling Plans','Running Late','Time Management',
  'Morning Coffee','Afternoon Slump','Power Nap','Evening Class','Night Drive','Late Snack','Phone Call','Video Call','Texting','Social Media',
  'Digital Detox','Mindfulness','Journaling','Reading','Music Playlist','Podcast','Language Practice','Networking','Interview Prep','Part-time Job',
  'Side Project','Coding Session','Design Draft','Feedback Round','Revision','Final Review','Presentation Day','Rest Day','Family Dinner','Friends Hangout',
  'Date Night','Neighborhood Walk','Farmer’s Market','Car Maintenance','House Plants','Recycling','Donation','Volunteering','Community Event','Holiday Prep'
];
const L1 = [
  { en:(t)=>`I spent some time on ${t} today.`, ko:(t)=>`오늘 ${t}에 시간을 좀 썼어요.` },
  { en:(t)=>`I worked on ${t} a bit this morning.`, ko:(t)=>`오늘 아침에 ${t}를 조금 했어요.` },
  { en:(t)=>`We focused on ${t} for a while today.`, ko:(t)=>`오늘 ${t}에 잠시 집중했어요.` },
  { en:(t)=>`I finally got around to ${t}.`, ko:(t)=>`드디어 ${t}를 하게 됐어요.` },
  { en:(t)=>`I checked in on ${t} after work.`, ko:(t)=>`퇴근하고 ${t}를 잠깐 살펴봤어요.` }
];
const L2 = [
  { en:()=>`Nothing fancy—just keeping things simple.`, ko:()=>`대단한 건 없고—그냥 심플하게 했어요.` },
  { en:()=>`It took longer than I expected, to be honest.`, ko:()=>`솔직히 생각보다 시간이 좀 걸렸어요.` },
  { en:()=>`It was casual but really helpful.`, ko:()=>`가볍게 했지만 꽤 도움이 됐어요.` },
  { en:()=>`It wasn’t perfect, but it was progress.`, ko:()=>`완벽하진 않았지만, 진전은 있었어요.` },
  { en:()=>`I tried to keep it practical and not overthink it.`, ko:()=>`실용적으로, 너무 고민하지 않으려 했어요.` }
];
const L3 = [
  { en:()=>`I'll try to be more consistent this week.`, ko:()=>`이번 주엔 더 꾸준히 해볼게요.` },
  { en:()=>`Next time, I'll plan ahead and keep it easy.`, ko:()=>`다음엔 미리 계획하고 쉽게 가볼게요.` },
  { en:()=>`I'm glad we're on the same page now.`, ko:()=>`이제 생각이 맞아서 다행이에요.` },
  { en:()=>`Small wins still count.`, ko:()=>`작은 성취도 의미 있어요.` },
  { en:()=>`Slow and steady works for me.`, ko:()=>`천천히 꾸준히가 제 스타일이에요.` }
];
function pickIdx(a){ return Math.floor(Math.random()*a.length); }
function randomLinesBilingual(title){
  const t = title.toLowerCase();
  const s1=L1[pickIdx(L1)], s2=L2[pickIdx(L2)], s3=L3[pickIdx(L3)];
  return [
    { en:s1.en(t), ko:s1.ko(t) },
    { en:s2.en(), ko:s2.ko() },
    { en:s3.en(), ko:s3.ko() }
  ];
}

// ===== TTS =====
let voices=[]; const voiceSelect=document.getElementById('voiceSelect');
function loadVoices(){ try{ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
function sortVoices(list){ return [...list].sort((a,b)=>{ const score=v=>(/en[-_]?US/i.test(v.lang)?2:/^en/i.test(v.lang)?1:0); const ds=score(b)-score(a); return ds||((a.name||'').localeCompare(b.name||'')); }); }
function populateVoiceSelect(){ voiceSelect.innerHTML=''; if(!voices.length){ const o=document.createElement('option'); o.textContent='(no voices)'; o.value=''; voiceSelect.appendChild(o); voiceSelect.disabled=true; return; } voiceSelect.disabled=false; const sorted=sortVoices(voices); for(const v of sorted){ const o=document.createElement('option'); o.value=v.voiceURI||v.name||''; o.textContent=`${v.name} — ${v.lang}`; voiceSelect.appendChild(o);} const byURI=sorted.find(v=>(v.voiceURI||'')===(user.voiceURI||'')); if(byURI) voiceSelect.value=byURI.voiceURI||''; else { const enUS=sorted.find(v=>/en[-_]?US/i.test(v.lang)); voiceSelect.value=(enUS&&(enUS.voiceURI||''))||(sorted[0].voiceURI||''); user.voiceURI=voiceSelect.value; saveUser(user);} }
async function waitForVoices(timeout=2000){ if(!('speechSynthesis' in window)) return; loadVoices(); if(voices.length) return; await new Promise(res=>{ const t0=Date.now(); function h(){ loadVoices(); if(voices.length||Date.now()-t0>timeout){ speechSynthesis.removeEventListener('voiceschanged',h); res(); } } speechSynthesis.addEventListener('voiceschanged',h); setTimeout(h,timeout); }); }
if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.addEventListener('voiceschanged', ()=>{ loadVoices(); populateVoiceSelect(); }); }
function resumeTTS(){ try{ if('speechSynthesis' in window && speechSynthesis.paused) speechSynthesis.resume(); }catch(_){} }
window.addEventListener('pointerdown', resumeTTS, { once:true }); document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resumeTTS(); });
function getVoice(){ if(!voices.length) return null; if(user.voiceURI){ const v=voices.find(v=>(v.voiceURI||'')===user.voiceURI); if(v) return v; } return voices.find(v=>/en[-_]?US/i.test(v.lang))||voices.find(v=>/^en/i.test(v.lang))||voices[0]||null; }
voiceSelect.addEventListener('change', ()=>{ user.voiceURI=voiceSelect.value||''; saveUser(user); toast('TTS 보이스를 변경했어요.'); });
function speakOnce(text){ return new Promise(async (resolve)=>{ if(!('speechSynthesis' in window)) return resolve(); await waitForVoices(); resumeTTS(); const utt=new SpeechSynthesisUtterance(text); utt.lang=user.lang||'en-US'; utt.rate=user.ttsRate||1; const v=getVoice(); if(v){ utt.voice=v; utt.lang=v.lang||utt.lang; } utt.onend=()=>resolve(); try{ if(speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){} setTimeout(()=>speechSynthesis.speak(utt),0); }); }
async function speakQueue(arr,onStart,onEnd){ try{ onStart&&onStart(); for(const s of arr){ await speakOnce(s); } } finally{ onEnd&&onEnd(); } }
function speak(text){ return speakQueue([text]); }

// ===== STT & Scoring =====
function createRecognizer(onResult,onEnd,{continuous=false,interim=false}={}){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('이 기기에서는 음성 인식이 제한됩니다. (Android Chrome 권장)'); return null; } const rec=new SR(); rec.lang='en-US'; rec.interimResults=!!interim; rec.continuous=!!continuous; rec.maxAlternatives=1; rec.onresult=(e)=>onResult&&onResult(e); rec.onerror=(e)=>onErrorHandler(e); rec.onend=()=>onEnd&&onEnd(); return rec; }
function onErrorHandler(e){ const err=e&&e.error||''; if(err==='no-speech'||err==='network'||err==='audio-capture'){ /* 일시 오류는 onend에서 복구 */ } }
function levenshtein(a,b){ const m=a.length,n=b.length; const d=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) d[i][0]=i; for(let j=0;j<=n;j++) d[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);} } return d[m][n]; }
function norm(s){ return s.toLowerCase().replace(/[^a-z\s]/g,'').replace(/\s+/g,' ').trim(); }
function scoreSentence(ref,hyp){ const A=norm(ref),B=norm(hyp); if(!B) return 0; const dist=levenshtein(A,B); const max=Math.max(A.length,B.length)||1; return Math.max(0, Math.round((1-dist/max)*100)); }
function tokenize(s){ return norm(s).split(' ').filter(Boolean); }
function wordDiffFeedback(ref, hyp){ const R=tokenize(ref), H=tokenize(hyp); if(!H.length) return ['조금 더 크게, 또렷하게 말해줘요!']; const setH=new Set(H); const tips=[]; const missing=R.filter(w=>!setH.has(w)); if(missing.length>=2) tips.push('단어 몇 개 빠졌어요 (전체 끝까지 말하기).'); if(H.length <= Math.max(2, Math.floor(R.length*0.6))) tips.push('말이 너무 짧아요. 전체 문장을 끝까지 말해보세요.'); const endsS=R.filter(w=>/^[a-z]+s$/.test(w)); if(endsS.some(w=>!H.includes(w))) tips.push('복수형/3인칭 단수 -s 소리를 살려요.'); const endsED=R.filter(w=>/^[a-z]+ed$/.test(w)); if(endsED.some(w=>!H.includes(w))) tips.push('과거형 -ed 발음 점검!'); if(/th/.test(norm(ref)) && !/th/.test(norm(hyp))) tips.push('th(θ/ð) 혀끝 소리 주의!'); if(/[rl]/.test(norm(ref)) && !/[rl]/.test(norm(hyp))) tips.push('R/L 구분 또렷하게!'); if(/v/.test(norm(ref)) && /b/.test(norm(hyp))) tips.push('v(아랫입술+윗이) vs b 구분!'); if(tips.length<=1) tips.push('억양을 살려 자연스럽게 읽어보세요.'); return tips.slice(0,2); }

// ===== UI Refs =====
const tabs=document.querySelectorAll('.tab');
const views={home:document.getElementById('home'),challenge:document.getElementById('challenge'),progress:document.getElementById('progress')};
const elDayNum=document.getElementById('dayNum'); const elTitle=document.getElementById('dayTitle'); const elLines=document.getElementById('lines');
const elAvg=document.getElementById('avgScore'); const elMeter=document.getElementById('meterBar');
const btnRetry=document.getElementById('btnRetry'); const btnReset=document.getElementById('btnReset');

for (const t of tabs){ t.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active');
  Object.values(views).forEach(v=>v.style.display='none'); views[t.dataset.view].style.display='';
  if(t.dataset.view==='challenge') renderChallenge100();
  if(t.dataset.view==='progress') renderHistory();
}); }

// Toast
let toastTimer; function toast(msg){ clearTimeout(toastTimer); const el=document.getElementById('toast'); const m=document.getElementById('toastMsg'); m.textContent=msg; el.style.display='flex'; toastTimer=setTimeout(()=>el.style.display='none', 1800); }

// Rate
const elRate=document.getElementById('rate');
elRate.textContent=(user.ttsRate||1).toFixed(1)+'x';
document.getElementById('rateDown').onclick=()=>{ user.ttsRate=Math.max(.6, Math.round(((user.ttsRate||1)-.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };
document.getElementById('rateUp').onclick=()=>{ user.ttsRate=Math.min(1.4, Math.round(((user.ttsRate||1)+.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };

// ===== Day/State =====
function getTodayDay(){ const auto=computeDayFromStart(); const cur=prog._currentDay||auto; const d=Math.max(1,Math.min(100,cur)); if(prog._currentDay!==d){ prog._currentDay=d; saveProg(prog);} return d; }
function ensureDayState(day){
  const k='Day'+day;
  if(!prog[k]){ prog[k]={ comboScore:null, done:false }; saveProg(prog); }
  return prog[k];
}

// ===== Render Today =====
function renderToday(){
  const day=getTodayDay(); const data=ensureDayState(day); const title=TITLES[day-1];
  const pairs=randomLinesBilingual(title);
  elDayNum.textContent=day; elTitle.textContent=title; elLines.innerHTML='';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const sttSupported=!!SR;

  pairs.forEach((pair,i)=>{
    const text = pair.en;
    const line=document.createElement('div'); line.className='line';

    const pEn=document.createElement('p'); pEn.textContent=text; line.appendChild(pEn);
    const pKo=document.createElement('p'); pKo.textContent=pair.ko; pKo.className='ko'; line.appendChild(pKo);

    const row=document.createElement('div'); row.className='row';

    const btnPlay=document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='▶︎ 듣기';
    btnPlay.onclick=()=>{ speak(text); };

    const btnRec=document.createElement('button'); btnRec.className='btn pri'; btnRec.textContent='● 말하기(연습)';
    const btnStop=document.createElement('button'); btnStop.className='btn'; btnStop.textContent='■ 중지'; btnStop.disabled=true;
    if(!sttSupported){ btnRec.disabled=true; btnStop.disabled=true; btnRec.title='이 기기에서는 음성 인식이 제한됩니다.'; }

    const scoreBox=document.createElement('span'); scoreBox.className='score'; scoreBox.style.marginLeft='6px';
    const fbBox=document.createElement('span'); fbBox.className='feedback'; fbBox.textContent='';

    // 개별 말하기(연습): 반드시 사용자 '중지'로 종료
    let rec=null, recActive=false, hypAccum='';
    function setRecUI(active){ if(active){ btnRec.classList.add('rec'); btnRec.textContent='● 듣는 중…(연습)'; } else { btnRec.classList.remove('rec'); btnRec.textContent='● 말하기(연습)'; } }

    function startLineRec(){
      rec = createRecognizer((e)=>{
        for(let i=e.resultIndex;i<e.results.length;i++){
          const r=e.results[i];
          if(r.isFinal){ hypAccum += (hypAccum?' ':'') + r[0].transcript; }
        }
      }, ()=>{
        if(recActive){
          try{ rec=null; setTimeout(startLineRec, 200); }catch(_){}
        } else {
          const s=scoreSentence(text,hypAccum);
          const fb = (s===100) ? ['잘했어요!'] : wordDiffFeedback(text,hypAccum);
          scoreBox.textContent=`연습 점수 ${s}%`;
          fbBox.textContent=fb.join(' · ');
          btnRec.disabled=false; btnStop.disabled=true; btnStop.textContent='■ 중지';
          setRecUI(false);
        }
      }, {continuous:true, interim:false});
      if(rec){ try{ rec.start(); }catch(_){ toast('마이크 시작 실패. 권한/다른 앱 점검 후 다시 시도해 주세요.'); } }
    }

    btnRec.onclick=()=>{ 
      if(rec||!sttSupported) return; 
      recActive=true; hypAccum='';
      btnRec.disabled=true; btnStop.disabled=false; setRecUI(true); toast('말해 보세요… (연습)');
      startLineRec();
    };
    btnStop.onclick=()=>{ 
      if(!rec) return;
      recActive=false;
      try{ rec.stop(); }catch(_){}
      btnStop.disabled=true; btnStop.textContent='중지됨';
    };

    row.appendChild(btnPlay); row.appendChild(btnRec); row.appendChild(btnStop); row.appendChild(scoreBox);
    line.appendChild(row); line.appendChild(fbBox);
    elLines.appendChild(line);
  });

  // 3문장 연속 듣기 & 3문장 연속 말하기(점수 반영)
  const allRow=document.createElement('div'); allRow.className='row';

  const btnAll=document.createElement('button');
  btnAll.className='btn';
  btnAll.textContent='▶︎ 3문장 연속 듣기';
  btnAll.onclick=()=> speakQueue(pairs.map(x=>x.en),
    ()=>{btnAll.disabled=true; btnAll.textContent='▶︎ 재생 중…';},
    ()=>{btnAll.disabled=false; btnAll.textContent='▶︎ 3문장 연속 듣기';});
  allRow.appendChild(btnAll);

  const btnRecAll=document.createElement('button');
  btnRecAll.className='btn pri';
  btnRecAll.textContent='● 3문장 연속 말하기(점수 반영)';
  if(!sttSupported){ btnRecAll.disabled=true; btnRecAll.title='이 기기에서는 음성 인식이 제한됩니다.'; }
  btnRecAll.onclick=()=> practiceReciteOneShot_final(pairs.map(x=>x.en), btnRecAll);
  allRow.appendChild(btnRecAll);

  elLines.appendChild(allRow);

  updateProgress();
}

// ===== Progress (연속 말하기 점수만 반영) =====
function updateProgress(){
  const day=getTodayDay(); const d=ensureDayState(day);
  const avg = (typeof d.comboScore==='number') ? d.comboScore : 0;
  document.getElementById('avgScore').textContent = avg>0 ? (avg+'%') : '—';
  document.getElementById('meterBar').style.width = `${avg}%`;

  const pass = avg>=80;
  const elDone=document.getElementById('markDone');
  elDone.disabled=!pass; elDone.textContent=pass?'✔ 조건 충족! 오늘 완료하기':'✔ 오늘 완료로 표시';
  elDone.onclick=()=>{ if(pass){ markDone(getTodayDay(),avg); } };
}

function markDone(day,avg){
  const k='Day'+day; const title=TITLES[day-1];
  const now=todayKey();
  prog[k] = { comboScore:avg, done:true };
  prog.lastDone=k;
  const prev='Day'+(day-1), prevStreak=prog.streak||0;
  prog.streak = (day>1 && prog[prev]&&prog[prev].done)? prevStreak+1 : 1;
  if(!Array.isArray(prog._history)) prog._history=[];
  prog._history = prog._history.filter(h=>h.day!==day);
  prog._history.push({ day, date: now, title, avg });
  saveProg(prog);
  document.getElementById('streak').textContent=prog.streak;
  document.getElementById('lastDone').textContent=prog.lastDone;
  toast('✅ 오늘 학습 완료! 기록에 저장했어요.');
  renderChallenge100(); renderHistory();
}

// ===== 연속 말하기 (닫을 때 마지막 점수만 반영) =====
function concatenateLines(lines){ return lines.join(' '); }
function practiceReciteOneShot_final(lines, triggerBtn){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('이 브라우저는 음성 인식을 지원하지 않아요.'); return; }

  const origText = triggerBtn ? triggerBtn.textContent : '';
  function restoreTrigger(){
    if(triggerBtn){
      triggerBtn.classList.remove('rec');
      triggerBtn.disabled = false;
      triggerBtn.textContent = origText || '● 3문장 연속 말하기(점수 반영)';
    }
  }

  const wrap=document.createElement('div'); wrap.className='practice';
  const box=document.createElement('div'); box.className='box';
  const refs = lines.map((s,i)=>`${i+1}. ${s}`).join('\n');
  box.innerHTML = `
    <h3>🎤 3문장 연속 말하기 (점수 반영)</h3>
    <div class="ref">아래 3문장을 한 번에 자연스럽게 말해 보세요.\n\n${refs}</div>
    <div class="meta">
      <button class="btn pri" id="btnStart">● 말하기 시작</button>
      <button class="btn" id="btnStop" disabled>■ 중지</button>
      <span class="small">여러 번 시도해도 됩니다. <b>닫기</b>를 누른 시점의 점수가 반영됩니다.</span>
    </div>
    <div class="result" id="resultBox" style="display:none">
      <div>종합 점수: <b id="sumScore">—</b></div>
      <div class="feedback" id="sumFb"></div>
      <div style="margin-top:8px"><button class="btn" id="btnClosePanel">닫기</button></div>
    </div>
  `;
  wrap.appendChild(box); document.body.appendChild(wrap);

  const btnStart = box.querySelector('#btnStart');
  const btnStop  = box.querySelector('#btnStop');
  const resultBox= box.querySelector('#resultBox');
  const sumScore = box.querySelector('#sumScore');
  const sumFb    = box.querySelector('#sumFb');

  let rec=null, finalText='', lastScore=null, lastFb='', canStart=true;

  function resetStartUI(){ btnStart.classList.remove('rec'); btnStart.textContent='● 말하기 시작'; btnStart.disabled=false; }

  function onResult(e){ for (let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i]; if(r.isFinal) finalText += (finalText?' ':'') + r[0].transcript; } }
  function onEnd(){
    const refAll = concatenateLines(lines);
    const sc = scoreSentence(refAll, finalText);
    const fb = (sc===100) ? ['잘했어요!'] : wordDiffFeedback(refAll, finalText);

    lastScore = isNaN(sc)? null : sc; lastFb = fb.join(' · ');
    sumScore.textContent = (lastScore==null)? '—' : (lastScore + '%');
    sumFb.textContent = lastFb; resultBox.style.display = '';

    btnStop.disabled = true; btnStop.textContent = '중지됨';
    resetStartUI(); rec=null; finalText=''; setTimeout(()=>{ canStart=true; }, 200);
  }

  btnStart.onclick = ()=>{
    if(!canStart || rec) return;
    canStart=false; finalText='';
    if(triggerBtn){ triggerBtn.classList.add('rec'); triggerBtn.disabled=true; triggerBtn.textContent='● 연속 말하기 중…'; }
    btnStart.classList.add('rec'); btnStart.textContent='● 듣는 중…'; btnStart.disabled=true;
    btnStop.disabled=false; btnStop.textContent='■ 중지';

    setTimeout(()=>{
      rec = createRecognizer(onResult, onEnd, {continuous:true, interim:false});
      if(rec){ try{ rec.start(); }catch(_){ canStart=true; resetStartUI(); btnStop.disabled=true; toast('마이크 시작에 실패했습니다. 다시 시도해 주세요.'); } }
      else { canStart=true; resetStartUI(); btnStop.disabled=true; }
      toast('한 번에 3문장을 말해 보세요…');
    }, 150);
  };

  btnStop.onclick = ()=>{ if(rec){ try{ rec.stop(); }catch(_){ } } btnStop.disabled = true; btnStop.textContent = '중지됨'; };

  box.querySelector('#btnClosePanel').onclick = ()=>{
    try{ if(rec){ rec.abort(); } }catch(_){}
    document.body.removeChild(wrap);
    restoreTrigger();
    if(lastScore!=null){
      const day=getTodayDay(); const d=ensureDayState(day);
      d.comboScore = lastScore; saveProg(prog);
      updateProgress();
      toast(`종합 점수 ${lastScore}% 반영 완료`);
    } else {
      toast('점수 없이 닫았습니다.');
    }
  };
}

// ===== 100-Day Calendar =====
function renderChallenge100(){
  const grid=document.getElementById('challenge100'); grid.innerHTML='';
  const cur=getTodayDay();
  for(let i=1;i<=100;i++){
    const cell=document.createElement('div'); cell.className='day'; cell.textContent=i;
    const k='Day'+i; if(prog[k] && prog[k].done){ cell.classList.add('done'); cell.style.borderColor='#3b82f6'; }
    if(i===cur){ cell.style.outline='2px solid #5b8cff'; cell.style.color='#e8eefc'; }
    cell.title=k+(i===cur?' • today':'');
    cell.onclick=()=>{ prog._currentDay=i; saveProg(prog); tabs.forEach(b=>{ if(b.dataset.view==='home'){ b.click(); }}); renderToday(); };
    grid.appendChild(cell);
  }
}

// ===== History =====
function renderHistory(){
  const box=document.getElementById('history');
  let list = Array.isArray(prog._history) ? [...prog._history] : [];
  if (!list.length){
    list = Object.entries(prog)
      .filter(([k,v])=>/^Day\d+$/.test(k) && v && typeof v.comboScore==='number')
      .map(([k,v])=>({ day: parseInt(k.slice(3)), date: '', title: TITLES[parseInt(k.slice(3))-1], avg: v.comboScore }));
  }
  list.sort((a,b)=> a.day - b.day);
  if(!list.length){ box.innerHTML='<div class="small">아직 기록이 없습니다.</div>'; return; }
  const frag=document.createDocumentFragment();
  list.forEach(item=>{
    const div=document.createElement('div'); div.className='line';
    const dateTxt = item.date ? ` <span class="small">(${item.date})</span>` : '';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <b>Day ${item.day} — ${item.title}${dateTxt}</b><span class="score">${item.avg}%</span></div>`;
    frag.appendChild(div);
  });
  box.innerHTML=''; box.appendChild(frag);
}

// ===== Shortcuts =====
document.getElementById('btnRetry').onclick=()=>{ const day=getTodayDay(); prog['Day'+day]={ comboScore:null, done:false }; saveProg(prog); renderToday(); updateProgress(); toast('🔁 오늘 학습을 초기 상태로 되돌렸어요.');};
document.getElementById('btnReset').onclick=()=>{ if(!confirm('정말 전체 데이터를 초기화할까요? (취소 불가)')) return;
  localStorage.removeItem(LS_PROGRESS); prog=loadProg(); prog._startedAt=todayKey(); prog._currentDay=1; prog._history=[]; saveProg(prog);
  renderToday(); renderChallenge100(); renderHistory(); updateProgress(); toast('🧹 모든 데이터가 초기화됐어요.');
};

// ===== PWA =====
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }

// ===== Boot =====
function initHeaderKPI(){ document.getElementById('streak').textContent = prog.streak||0; document.getElementById('lastDone').textContent = prog.lastDone||'—'; }
async function initDiag(){ /* voices lazy */ }
async function boot(){ initHeaderKPI(); renderToday(); renderChallenge100(); updateProgress(); }
boot();
</script>
</body>
</html>
