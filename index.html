<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily 3 Lines â€” TTS Â· STT Â· Score Â· 100-Day</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="/dailyenglish/manifest.webmanifest?v=10">
  <link rel="apple-touch-icon" href="/dailyenglish/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/dailyenglish/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/dailyenglish/icon-192.png">
  <style>
  :root{
    --bg:#0b1020; --card:#111a34; --ink:#e8eefc; --muted:#9fb0df;
    --pri:#5b8cff; --good:#21d39b; --warn:#ffb454; --bad:#ff5c7a;
    --ring:#31457a; --ring-strong:#4a63a8;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
    background:
      radial-gradient(80% 60% at 10% 0%,#15224b 0%,#0b1020 60%),
      radial-gradient(80% 60% at 100% 100%,#0f1834 0%,#0b1020 60%);
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(91,140,255,.15);color:#cfe0ff;border:1px solid var(--ring);font-size:12px}
  nav{display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap; align-items:center}
  .tab{padding:10px 14px;border-radius:12px;background:#101733;border:1px solid var(--ring);cursor:pointer;color:#a7b3d6}
  .tab.active{background:#141f45;color:var(--ink);border-color:#3a5296}
  select{appearance:none;background:#101733;border:1px solid var(--ring);color:#e8eefc;padding:10px 12px;border-radius:10px;min-height:44px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg,#111a34,#0f1731);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .hd{display:flex;align-items:flex-start;justify-content:space-between;padding:18px 18px 0}
  .card .body{padding:14px 18px 20px}
  .title{font-size:26px;margin-top:4px;font-weight:900;letter-spacing:.3px}
  .subtitle{font-size:13px;color:var(--muted)}
  .line{border:1px solid var(--ring);border-radius:16px;padding:14px;margin:12px 0;background:#0f1731}
  .line p{margin:0 0 8px;font-size:18px;line-height:1.5}
  .line p.ko{margin:0 0 10px; font-size:15.5px; line-height:1.6; color:#cbd4f5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .btn{
    appearance:none;border:none;border-radius:12px;padding:10px 14px;
    background:#17224a;color:#e8eefc;border:1px solid #2b3f7a;cursor:pointer;min-height:44px;
    transition:transform .06s ease, filter .15s ease, box-shadow .15s ease;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.pri{background:linear-gradient(180deg,#3d64ff,#2b4bd4);border-color:#3b57e0}
  .btn.warn{background:#3a2a0e;border-color:#9f6b18}
  .btn.ghost{background:transparent;border-color:#2b3f7a}
  .btn.rec{background:linear-gradient(180deg,#ff5c7a,#e44360); border-color:#ff7f97; color:white; box-shadow:0 0 0 2px rgba(255,92,122,.25) inset}

  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px;border:1px solid var(--ring);border-radius:12px;background:#101733;font-size:13px}
  .chip::before{content:''; width:8px; height:8px; border-radius:50%; background:linear-gradient(180deg,#a7baff,#5b8cff); box-shadow:0 0 0 2px rgba(91,140,255,.15);}
  .score{font-weight:900}

  .meter{height:12px;background:#0e1330;border-radius:999px;border:1px solid var(--ring);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff5c7a,#ffb454,#5b8cff,#21d39b)}

  .kpi{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
  .day{aspect-ratio:1/1;border:1px solid #2d3d72;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0e1430;color:#c9d4ff;font-weight:700; font-size:14px}
  @media (max-width:520px){ .calendar{grid-template-columns:repeat(7,1fr)} .day{font-size:13px} .line p{font-size:16px} .title{font-size:22px}}

  .toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;pointer-events:none}
  .toast span{pointer-events:auto;background:#101733;border:1px solid var(--ring);padding:10px 14px;border-radius:12px}

  .small{font-size:12px;color:#a7b3d6}
  .hint{font-size:12.5px;color:#d3dcff;background:#16214a;border:1px solid #2e4489;padding:10px 12px;border-radius:10px}

  /* ì—°ì† ë§í•˜ê¸° íŒ¨ë„ */
  .practice{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;}
  .practice .box{width:min(720px,94vw); max-height:92vh; overflow:auto; background:#101733; border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:var(--shadow);}
  .practice .box h3{margin:0 0 12px; font-size:18px;}
  .practice .ref{font-size:14.5px; color:#cfe0ff; margin:6px 0 12px; white-space:pre-wrap; line-height:1.6}
  .practice .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
  .practice .result{margin-top:12px; padding:12px; border:1px solid var(--ring); border-radius:12px; background:#0f1731}
  .feedback{display:block; font-size:12.5px; color:#cfe0ff; opacity:.95}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily 3 Lines <span class="badge">100ì¼ ì±Œë¦°ì§€</span></h1>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="btnRetry">âŸ² ë‹¤ì‹œ í•˜ê¸°</button>
        <button class="btn warn" id="btnReset">âŸ² ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="home">ì˜¤ëŠ˜ì˜ í•™ìŠµ</button>
      <button class="tab" data-view="challenge">ì±Œë¦°ì§€</button>
      <button class="tab" data-view="progress">ê¸°ë¡</button>

      <div style="display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:wrap">
        <label class="small" for="voiceSelect">Voice</label>
        <select id="voiceSelect" title="TTS Voice"></select>

        <span class="small">ì†ë„</span>
        <button class="btn" id="rateDown">â€“</button>
        <span id="rate" class="small">1.0x</span>
        <button class="btn" id="rateUp">+</button>
      </div>
    </nav>

    <section id="home" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="subtitle">ì˜¤ëŠ˜ì˜ ì œëª© (Day <span id="dayNum">1</span>)</div>
            <div class="title" id="dayTitle">â€”</div>
          </div>
        </div>
        <div class="body" id="lines"></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2>
          <div class="kpi">
            <div class="chip">80ì  ì´ìƒ ì„±ê³µ</div>
            <div class="chip">ì ìˆ˜: <span class="score" id="avgScore">â€”</span></div>
          </div>
        </div>
        <div class="body">
          <div class="meter" title="3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸° ì ìˆ˜"><i id="meterBar"></i></div>
          <div style="height:12px"></div>
          <button class="btn pri" id="markDone" disabled>âœ” ì˜¤ëŠ˜ ì™„ë£Œë¡œ í‘œì‹œ</button>
          <div style="height:12px"></div>
          <div class="hint">ì„¸ ë¬¸ì¥ì„ ëª¨ë‘ ë“£ê³ (â–¶ï¸) <b>3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)</b>ì—ì„œ 80ì  ì´ìƒì´ë©´ ì™„ë£Œí•  ìˆ˜ ìˆì–´ìš”.</div>
          <div style="height:12px"></div>
          <div class="kpi">
            <div class="chip">ì—°ì†ì¼ìˆ˜: <b id="streak">0</b>ì¼</div>
            <div class="chip">ë§ˆì§€ë§‰ ì™„ë£Œ: <span id="lastDone">â€”</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" style="display:none">
      <div class="card">
        <div class="hd"><h2>100ì¼ ì±Œë¦°ì§€</h2><div class="chip">Day 1 â†’ Day 100</div></div>
        <div class="body">
          <div class="calendar" id="challenge100"></div>
        </div>
      </div>
    </section>

    <section id="progress" style="display:none">
      <div class="card">
        <div class="hd"><h2>ì ìˆ˜ ê¸°ë¡</h2></div>
        <div class="body"><div id="history"></div></div>
      </div>
    </section>

    <div class="toast" id="toast" style="display:none"><span id="toastMsg"></span></div>
  </div>

<script>
/* ====== Storage / Date Utilities ====== */
const LS_USER='d3l_user', LS_PROGRESS='d3l_progress';
function todayKey(){ const f = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit'}); return f.format(new Date()); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER)||'{"ttsRate":1,"lang":"en-US","voiceURI":""}'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function loadProg(){ return JSON.parse(localStorage.getItem(LS_PROGRESS)||'{}'); }
function saveProg(p){ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }

let user=loadUser(), prog=loadProg();
if(!prog._startedAt){ prog._startedAt=todayKey(); }
if(!prog._currentDay){ prog._currentDay=1; }
if(!prog._lastDate){ prog._lastDate=todayKey(); } // KST ê¸°ì¤€ ë§ˆì§€ë§‰ ë³¸ ë‚ ì§œ
if(!Array.isArray(prog._history)) { prog._history = []; }
saveProg(prog);

function computeDayFromStart(){
  const start = new Date(prog._startedAt+'T00:00:00+09:00');
  return Math.max(1, Math.min(100, Math.floor((Date.now()-start)/86400000)+1));
}
function getTodayDay(){
  const cur=prog._currentDay || computeDayFromStart();
  const d=Math.max(1,Math.min(100,cur));
  if(prog._currentDay!==d){ prog._currentDay=d; saveProg(prog); }
  return d;
}

/* ====== Data (100 Titles) ====== */
const TITLES=[ 'Morning Routine','Commuting','Coffee Break','Emails','Team Meeting','Project Update','Lunch Out','Groceries','Gym','Evening Walk',
  'Streaming Show','Weekend Plan','Laundry','Room Cleaning','Errands','Bank Visit','Pharmacy','Salon','Car Wash','Pet Care',
  'Cooking Dinner','Takeout','Birthday Party','Small Talk','Weather Chat','Sports Talk','News Catch-up','Book Club','Movie Night','Concert',
  'Coffee Chat','Study Session','Library Visit','Note Taking','Presentation Prep','Public Speaking','Mentor Advice','Goal Setting','Habit Tracking','Budgeting',
  'Online Shopping','Return/Refund','Customer Service','Travel Plan','Packing','Airport','Hotel Check-in','City Tour','Photo Walk','Museum',
  'Park Picnic','Beach Day','Hiking','Rainy Day','Snow Day','Heat Wave','Cold Snap','Sick Day','Clinic Visit','Dentist Visit',
  'Back to Work','Overtime','Deadline Push','Celebration','Thank-you Notes','Apology','Making Plans','Canceling Plans','Running Late','Time Management',
  'Morning Coffee','Afternoon Slump','Power Nap','Evening Class','Night Drive','Late Snack','Phone Call','Video Call','Texting','Social Media',
  'Digital Detox','Mindfulness','Journaling','Reading','Music Playlist','Podcast','Language Practice','Networking','Interview Prep','Part-time Job',
  'Side Project','Coding Session','Design Draft','Feedback Round','Revision','Final Review','Presentation Day','Rest Day','Family Dinner','Friends Hangout',
  'Date Night','Neighborhood Walk','Farmerâ€™s Market','Car Maintenance','House Plants','Recycling','Donation','Volunteering','Community Event','Holiday Prep'
];

/* ====== TOPIC BANKS ======
   - ê° ì£¼ì œëŠ” (1) ì™„ì „ ì»¤ìŠ¤í…€ 21ë¬¸ì¥ ë°°ì—´ ë˜ëŠ”
                 (2) category í‚¤ì›Œë“œ(ì˜ˆ: 'coffee','airport',...) ë¡œ ì§€ì • ê°€ëŠ¥
   - ì•„ë˜ ê¸°ë³¸ ì„¸íŒ…ì€ 100ê°œ ì „ì²´ ì£¼ì œë¥¼ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜í•´ ë‘ .
   - íŠ¹ì • ì£¼ì œë¥¼ ì™„ì „ ì»¤ìŠ¤í…€í•˜ê³  ì‹¶ìœ¼ë©´ í•´ë‹¹ í‚¤ì— 21ë¬¸ì¥ ë°°ì—´ì„ ì§ì ‘ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.
*/
const TOPIC_BANKS = {
  // ì¼ìƒ/ì´ë™
  'Morning Routine': 'routine',
  'Commuting': 'commute',
  // ì»¤í”¼ ê´€ë ¨
  'Coffee Break': 'coffee',
  'Morning Coffee': 'coffee',
  'Coffee Chat': 'coffee',
  // ì—…ë¬´/íšŒì˜/ë¬¸ì„œ
  'Emails': 'emails',
  'Team Meeting': 'meeting',
  'Project Update': 'work',
  'Note Taking': 'study',
  'Presentation Prep': 'presentation',
  'Public Speaking': 'public_speaking',
  'Mentor Advice': 'mentoring',
  'Goal Setting': 'planning',
  'Habit Tracking': 'habit',
  'Budgeting': 'budget',
  // ì‹ì‚¬/ì‡¼í•‘/í—¬ìŠ¤
  'Lunch Out': 'dining',
  'Groceries': 'groceries',
  'Gym': 'gym',
  // ì €ë…/ì—¬ê°€
  'Evening Walk': 'walk',
  'Streaming Show': 'streaming',
  'Weekend Plan': 'weekend',
  'Laundry': 'homecare',
  'Room Cleaning': 'homecare',
  'Errands': 'errands',
  'Bank Visit': 'bank',
  'Pharmacy': 'pharmacy',
  'Salon': 'salon',
  'Car Wash': 'car_wash',
  'Pet Care': 'pet',
  'Cooking Dinner': 'cooking',
  'Takeout': 'takeout',
  'Birthday Party': 'party',
  'Small Talk': 'smalltalk',
  'Weather Chat': 'weather_chat',
  'Sports Talk': 'sports',
  'News Catch-up': 'news',
  'Book Club': 'book',
  'Movie Night': 'movie',
  'Concert': 'concert',
  // í•™ìŠµ/ë„ì„œê´€
  'Study Session': 'study',
  'Library Visit': 'library',
  // ì˜¨ë¼ì¸/ì‡¼í•‘/ê³ ê°
  'Online Shopping': 'shopping',
  'Return/Refund': 'refund',
  'Customer Service': 'customer_service',
  // ì—¬í–‰
  'Travel Plan': 'travel',
  'Packing': 'packing',
  'Airport': 'airport',
  'Hotel Check-in': 'hotel',
  'City Tour': 'tour',
  'Photo Walk': 'photo',
  'Museum': 'museum',
  'Park Picnic': 'picnic',
  'Beach Day': 'beach',
  'Hiking': 'hiking',
  // ë‚ ì”¨
  'Rainy Day': 'rain',
  'Snow Day': 'snow',
  'Heat Wave': 'heat',
  'Cold Snap': 'cold',
  // ê±´ê°•
  'Sick Day': 'sick',
  'Clinic Visit': 'clinic',
  'Dentist Visit': 'dentist',
  // ì—…ë¬´ í˜ì´ìŠ¤
  'Back to Work': 'work',
  'Overtime': 'overtime',
  'Deadline Push': 'deadline',
  'Celebration': 'celebration',
  'Thank-you Notes': 'thanks',
  'Apology': 'apology',
  // ì•½ì†/ì‹œê°„
  'Making Plans': 'plans',
  'Canceling Plans': 'cancel',
  'Running Late': 'late',
  'Time Management': 'timemanage',
  // í•˜ë£¨ ë¦¬ë“¬
  'Afternoon Slump': 'slump',
  'Power Nap': 'nap',
  'Evening Class': 'class',
  'Night Drive': 'drive',
  'Late Snack': 'snack',
  // ì†Œí†µ
  'Phone Call': 'phone',
  'Video Call': 'video',
  'Texting': 'text',
  'Social Media': 'social',
  // ë§ˆìŒ/ê¸°ë¡/ì½˜í…ì¸ 
  'Digital Detox': 'detox',
  'Mindfulness': 'mindfulness',
  'Journaling': 'journal',
  'Reading': 'reading',
  'Music Playlist': 'music',
  'Podcast': 'podcast',
  'Language Practice': 'language',
  // ì»¤ë¦¬ì–´
  'Networking': 'network',
  'Interview Prep': 'interview',
  'Part-time Job': 'parttime',
  // ì‚¬ì´ë“œ/ì œì‘
  'Side Project': 'side',
  'Coding Session': 'coding',
  'Design Draft': 'design',
  'Feedback Round': 'feedback',
  'Revision': 'revision',
  'Final Review': 'final_review',
  'Presentation Day': 'presentation_day',
  // íœ´ì‹/ê°€ì¡±/ì¹œêµ¬/ë°ì´íŠ¸
  'Rest Day': 'rest',
  'Family Dinner': 'family',
  'Friends Hangout': 'friends',
  'Date Night': 'date',
  'Neighborhood Walk': 'walk',
  'Farmerâ€™s Market': 'market',
  // ì§‘/í™˜ê²½/ê³µë™ì²´
  'Car Maintenance': 'car_maint',
  'House Plants': 'plants',
  'Recycling': 'recycling',
  'Donation': 'donation',
  'Volunteering': 'volunteer',
  'Community Event': 'community',
  'Holiday Prep': 'holiday'
};

/* ====== ì¹´í…Œê³ ë¦¬ë³„ ë¬¸ì¥ í…œí”Œë¦¿ ======
   - ê° ì¹´í…Œê³ ë¦¬ì—ì„œ 21ë¬¸ì¥ì„ ì •í™•íˆ ë°˜í™˜ (en/ko í˜ì–´)
   - ì»¤í”¼/ê³µí•­ ë“±ì€ ì „ìš© ì½˜í…ì¸ , ê¸°íƒ€ëŠ” ë²”ìš© "ì£¼ì œ ë§ì¶¤ í…œí”Œë¦¿"
*/
function lines_coffee(){
  return [
    {en:"I drink a cup of coffee every morning.", ko:"ë‚˜ëŠ” ë§¤ì¼ ì•„ì¹¨ ì»¤í”¼ë¥¼ í•œ ì” ë§ˆì…”ìš”."},
    {en:"I tried a new coffee shop today.", ko:"ì˜¤ëŠ˜ ìƒˆë¡œìš´ ì»¤í”¼ìˆì— ê°€ë´¤ì–´ìš”."},
    {en:"I like iced coffee in the summer.", ko:"ì—¬ë¦„ì—ëŠ” ì•„ì´ìŠ¤ì»¤í”¼ë¥¼ ì¢‹ì•„í•´ìš”."},
    {en:"Too much coffee makes me nervous.", ko:"ì»¤í”¼ë¥¼ ë„ˆë¬´ ë§ì´ ë§ˆì‹œë©´ ì‹ ê²½ì´ ì˜ˆë¯¼í•´ì ¸ìš”."},
    {en:"I ordered a latte with no sugar.", ko:"ì„¤íƒ• ì—†ì´ ë¼í…Œë¥¼ ì£¼ë¬¸í–ˆì–´ìš”."},
    {en:"The aroma of fresh coffee woke me up.", ko:"ê°“ ë‚´ë¦° ì»¤í”¼ í–¥ì´ ì ì„ ê¹¨ì›Œì¤¬ì–´ìš”."},
    {en:"I ground the beans right before brewing.", ko:"ì¶”ì¶œí•˜ê¸° ì§ì „ì— ì›ë‘ë¥¼ ê°ˆì•˜ì–´ìš”."},
    {en:"Iâ€™m learning to make better pour-over.", ko:"ë” ë§›ìˆëŠ” í‘¸ì–´ì˜¤ë²„ë¥¼ ë°°ìš°ê³  ìˆì–´ìš”."},
    {en:"I added a splash of milk to my coffee.", ko:"ì»¤í”¼ì— ìš°ìœ ë¥¼ ì•½ê°„ ë„£ì—ˆì–´ìš”."},
    {en:"We chatted over coffee after lunch.", ko:"ì ì‹¬ í›„ ì»¤í”¼ ë§ˆì‹œë©° ìˆ˜ë‹¤ë¥¼ ë–¨ì—ˆì–´ìš”."},
    {en:"I switched to decaf in the evening.", ko:"ì €ë…ì—ëŠ” ë””ì¹´í˜ì¸ìœ¼ë¡œ ë°”ê¿¨ì–´ìš”."},
    {en:"The barista recommended a seasonal blend.", ko:"ë°”ë¦¬ìŠ¤íƒ€ê°€ ì‹œì¦Œ ë¸”ë Œë“œë¥¼ ì¶”ì²œí–ˆì–´ìš”."},
    {en:"I tried a single-origin espresso shot.", ko:"ì‹±ê¸€ ì˜¤ë¦¬ì§„ ì—ìŠ¤í”„ë ˆì†Œ ìƒ·ì„ ë§ˆì…”ë´¤ì–´ìš”."},
    {en:"I compared light and dark roasts.", ko:"ë¼ì´íŠ¸ ë¡œìŠ¤íŠ¸ì™€ ë‹¤í¬ ë¡œìŠ¤íŠ¸ë¥¼ ë¹„êµí•´ ë´¤ì–´ìš”."},
    {en:"I cleaned my coffee grinder today.", ko:"ì˜¤ëŠ˜ ì»¤í”¼ ê·¸ë¼ì¸ë”ë¥¼ ì²­ì†Œí–ˆì–´ìš”."},
    {en:"I set a budget for my coffee spending.", ko:"ì»¤í”¼ ì§€ì¶œ ì˜ˆì‚°ì„ ì •í–ˆì–´ìš”."},
    {en:"I skipped coffee to sleep better tonight.", ko:"ì˜¤ëŠ˜ ë°¤ ìˆ™ë©´ì„ ìœ„í•´ ì»¤í”¼ë¥¼ ê±´ë„ˆë›°ì—ˆì–´ìš”."},
    {en:"I paired coffee with a small dessert.", ko:"ì»¤í”¼ì™€ ì‘ì€ ë””ì €íŠ¸ë¥¼ ê³ë“¤ì˜€ì–´ìš”."},
    {en:"The cafÃ© was cozy and quiet.", ko:"ì¹´í˜ê°€ ì•„ëŠ‘í•˜ê³  ì¡°ìš©í–ˆì–´ìš”."},
    {en:"I learned a new brewing ratio.", ko:"ìƒˆë¡œìš´ ì¶”ì¶œ ë¹„ìœ¨ì„ ë°°ì› ì–´ìš”."},
    {en:"Iâ€™m glad my coffee turned out smooth.", ko:"ì»¤í”¼ê°€ ë¶€ë“œëŸ½ê²Œ ì˜ ë‚˜ì™€ì„œ ë§Œì¡±í–ˆì–´ìš”."},
  ];
}
function lines_airport(){
  return [
    {en:"I checked in online before going to the airport.", ko:"ê³µí•­ì— ê°€ê¸° ì „ì— ì˜¨ë¼ì¸ ì²´í¬ì¸ì„ í–ˆì–´ìš”."},
    {en:"I arrived early to avoid long lines.", ko:"ê¸´ ì¤„ì„ í”¼í•˜ë ¤ê³  ì¼ì° ë„ì°©í–ˆì–´ìš”."},
    {en:"Security screening was quick today.", ko:"ì˜¤ëŠ˜ ë³´ì•ˆ ê²€ìƒ‰ì´ ë¹¨ëì–´ìš”."},
    {en:"I printed my boarding pass just in case.", ko:"í˜¹ì‹œ ëª°ë¼ íƒ‘ìŠ¹ê¶Œì„ ì¶œë ¥í–ˆì–´ìš”."},
    {en:"I double-checked my gate and seat number.", ko:"ê²Œì´íŠ¸ì™€ ì¢Œì„ ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í–ˆì–´ìš”."},
    {en:"I put my liquids in a clear bag.", ko:"ì•¡ì²´ë¥˜ë¥¼ íˆ¬ëª…í•œ ë´‰íˆ¬ì— ë„£ì—ˆì–´ìš”."},
    {en:"I kept my passport in an easy-to-reach pocket.", ko:"ì—¬ê¶Œì„ êº¼ë‚´ê¸° ì‰¬ìš´ ì£¼ë¨¸ë‹ˆì— ë„£ì–´ë‘ì—ˆì–´ìš”."},
    {en:"I grabbed a quick snack before boarding.", ko:"íƒ‘ìŠ¹ ì „ì— ê°„ë‹¨íˆ ê°„ì‹ì„ ë¨¹ì—ˆì–´ìš”."},
    {en:"Boarding started right on time.", ko:"íƒ‘ìŠ¹ì´ ì œì‹œê°„ì— ì‹œì‘ëì–´ìš”."},
    {en:"I listened for announcements near the gate.", ko:"ê²Œì´íŠ¸ ê·¼ì²˜ì—ì„œ ì•ˆë‚´ ë°©ì†¡ì„ ë“¤ì—ˆì–´ìš”."},
    {en:"I used a carry-on to travel light.", ko:"ê°€ë³ê²Œ ë“¤ê³  íƒˆ ìˆ˜í™”ë¬¼ë§Œ ê°€ì ¸ê°”ì–´ìš”."},
    {en:"I kept my phone charged for the e-ticket.", ko:"ì „ì íƒ‘ìŠ¹ê¶Œì„ ìœ„í•´ íœ´ëŒ€í°ì„ ì¶©ì „í•´ ë‘ì—ˆì–´ìš”."},
    {en:"I checked the baggage weight limit.", ko:"ìˆ˜í•˜ë¬¼ ë¬´ê²Œ ì œí•œì„ í™•ì¸í–ˆì–´ìš”."},
    {en:"I asked for a window seat politely.", ko:"ì°½ê°€ ìë¦¬ë¥¼ ì •ì¤‘íˆ ë¶€íƒí–ˆì–´ìš”."},
    {en:"I watched the planes take off and land.", ko:"ë¹„í–‰ê¸° ì´ë¥™ê³¼ ì°©ë¥™ì„ êµ¬ê²½í–ˆì–´ìš”."},
    {en:"I followed the signs to immigration.", ko:"í‘œì§€íŒì„ ë”°ë¼ ì¶œì…êµ­ ì‹¬ì‚¬ë¡œ ê°”ì–´ìš”."},
    {en:"I filled out the arrival form carefully.", ko:"ì…êµ­ ì‹ ê³ ì„œë¥¼ ê¼¼ê¼¼íˆ ì‘ì„±í–ˆì–´ìš”."},
    {en:"I kept my valuables in my personal bag.", ko:"ê·€ì¤‘í’ˆì€ ê°œì¸ ê°€ë°©ì— ë³´ê´€í–ˆì–´ìš”."},
    {en:"I checked the airport map to find my gate.", ko:"ê³µí•­ ì§€ë„ë¥¼ ë³´ê³  ê²Œì´íŠ¸ë¥¼ ì°¾ì•˜ì–´ìš”."},
    {en:"I stretched my legs before the long flight.", ko:"ê¸´ ë¹„í–‰ ì „ ë‹¤ë¦¬ë¥¼ ì­‰ íˆì–´ìš”."},
    {en:"Iâ€™m glad the flight departed smoothly.", ko:"ë¹„í–‰ê¸°ê°€ ìˆœì¡°ë¡­ê²Œ ì¶œë°œí•´ì„œ ë‹¤í–‰ì´ì—ìš”."},
  ];
}
function lines_hotel(){
  return [
    {en:"I confirmed my reservation before the trip.", ko:"ì—¬í–‰ ì „ì— ì˜ˆì•½ì„ í™•ì¸í–ˆì–´ìš”."},
    {en:"I asked for early check-in politely.", ko:"ì •ì¤‘í•˜ê²Œ ì–¼ë¦¬ ì²´í¬ì¸ì„ ìš”ì²­í–ˆì–´ìš”."},
    {en:"I showed my ID and booking number at the desk.", ko:"ë°ìŠ¤í¬ì—ì„œ ì‹ ë¶„ì¦ê³¼ ì˜ˆì•½ë²ˆí˜¸ë¥¼ ë³´ì—¬ì¤¬ì–´ìš”."},
    {en:"I requested a quiet room on a higher floor.", ko:"ì¸µê³ ê°€ ë†’ì€ ì¡°ìš©í•œ ë°©ì„ ë¶€íƒí–ˆì–´ìš”."},
    {en:"I checked the room for cleanliness.", ko:"ê°ì‹¤ ì²­ê²° ìƒíƒœë¥¼ í™•ì¸í–ˆì–´ìš”."},
    {en:"I tested the key card and safe.", ko:"í‚¤ ì¹´ë“œì™€ ê¸ˆê³ ë¥¼ ì ê²€í–ˆì–´ìš”."},
    {en:"I asked about breakfast hours.", ko:"ì•„ì¹¨ ì‹ì‚¬ ì‹œê°„ì„ ë¬¼ì–´ë´¤ì–´ìš”."},
    {en:"I set the air conditioner to a comfortable level.", ko:"ì—ì–´ì»¨ì„ í¸ì•ˆí•œ ì˜¨ë„ë¡œ ì„¤ì •í–ˆì–´ìš”."},
    {en:"I used the luggage rack to keep things tidy.", ko:"ì§ ì •ë¦¬ë¥¼ ìœ„í•´ ëŸ¬ê¸°ì§€ë™ì„ ì‚¬ìš©í–ˆì–´ìš”."},
    {en:"I called the front desk for extra towels.", ko:"ìˆ˜ê±´ì„ ë” ë‹¬ë¼ê³  í”„ëŸ°íŠ¸ì— ì „í™”í–ˆì–´ìš”."},
    {en:"I planned tomorrowâ€™s route with the hotel map.", ko:"í˜¸í…” ì§€ë„ë¡œ ë‚´ì¼ ë™ì„ ì„ ê³„íší–ˆì–´ìš”."},
    {en:"I charged my devices near the desk.", ko:"ì±…ìƒ ê·¼ì²˜ì—ì„œ ê¸°ê¸°ë¥¼ ì¶©ì „í–ˆì–´ìš”."},
    {en:"I put the â€˜Do Not Disturbâ€™ sign on the door.", ko:"ë¬¸ì— 'ê°ì‹¤ ì •ì¤‘' í‘œì§€ë¥¼ ê±¸ì—ˆì–´ìš”."},
    {en:"I checked out the gym and pool hours.", ko:"í—¬ìŠ¤ì¥ê³¼ ìˆ˜ì˜ì¥ ìš´ì˜ ì‹œê°„ì„ í™•ì¸í–ˆì–´ìš”."},
    {en:"I kept my passport in the room safe.", ko:"ì—¬ê¶Œì„ ê°ì‹¤ ê¸ˆê³ ì— ë³´ê´€í–ˆì–´ìš”."},
    {en:"I requested a late checkout if possible.", ko:"ê°€ëŠ¥í•˜ë©´ ë ˆì´íŠ¸ ì²´í¬ì•„ì›ƒì„ ìš”ì²­í–ˆì–´ìš”."},
    {en:"I thanked the staff for their help.", ko:"ì§ì›ë“¤ì˜ ë„ì›€ì— ê°ì‚¬ ì¸ì‚¬ë¥¼ í–ˆì–´ìš”."},
    {en:"I left a small tip for housekeeping.", ko:"í•˜ìš°ìŠ¤í‚¤í•‘ì„ ìœ„í•´ ì‘ì€ íŒì„ ë‚¨ê²¼ì–´ìš”."},
    {en:"I checked out smoothly at the front desk.", ko:"í”„ëŸ°íŠ¸ì—ì„œ ìˆ˜ì›”í•˜ê²Œ ì²´í¬ì•„ì›ƒí–ˆì–´ìš”."},
    {en:"I saved the hotel address on my phone.", ko:"í˜¸í…” ì£¼ì†Œë¥¼ íœ´ëŒ€í°ì— ì €ì¥í•´ ë‘ì—ˆì–´ìš”."},
    {en:"Iâ€™m happy the room met my needs.", ko:"ê°ì‹¤ì´ ê¸°ëŒ€ì— ë§ì•„ì„œ ë§Œì¡±í–ˆì–´ìš”."},
  ];
}

/* ====== ë²”ìš©/ë‹¤ìˆ˜ ì¹´í…Œê³ ë¦¬ í…œí”Œë¦¿ ======
   - title(ì£¼ì œëª…)ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë¼ì›Œ ë„£ë˜, ì‹¤ì œ ìƒí™© ë§¥ë½ìœ¼ë¡œ 21ë¬¸ì¥ êµ¬ì„±
*/
function lines_generic(title){
  const t = title;
  return [
    {en:`I spent some time on ${t} today.`, ko:`ì˜¤ëŠ˜ ${t}ì— ì‹œê°„ì„ ì¢€ ì¼ì–´ìš”.`},
    {en:`I tried to keep ${t} simple and practical.`, ko:`${t}ëŠ” ì‹¤ìš©ì ìœ¼ë¡œ, ê°„ë‹¨íˆ í•´ë´¤ì–´ìš”.`},
    {en:`Honestly, ${t} took longer than I expected.`, ko:`ì†”ì§íˆ ${t}ê°€ ìƒê°ë³´ë‹¤ ì˜¤ë˜ ê±¸ë ¸ì–´ìš”.`},
    {en:`I finally made progress with ${t}.`, ko:`ë“œë””ì–´ ${t}ì—ì„œ ì§„ì „ì´ ìˆì—ˆì–´ìš”.`},
    {en:`I set one clear goal for ${t}.`, ko:`${t}ë¥¼ ìœ„í•´ ëª…í™•í•œ ëª©í‘œ í•˜ë‚˜ë¥¼ ì •í–ˆì–´ìš”.`},
    {en:`I checked a few details related to ${t}.`, ko:`${t}ì™€ ê´€ë ¨ëœ ëª‡ ê°€ì§€ ë””í…Œì¼ì„ ì ê²€í–ˆì–´ìš”.`},
    {en:`I talked about ${t} with a friend briefly.`, ko:`${t}ì— ëŒ€í•´ ì¹œêµ¬ì™€ ì ê¹ ì´ì•¼ê¸°í–ˆì–´ìš”.`},
    {en:`I learned a small tip that helps with ${t}.`, ko:`${t}ì— ë„ì›€ì´ ë˜ëŠ” ì‘ì€ íŒì„ ë°°ì› ì–´ìš”.`},
    {en:`I wrote down notes to improve ${t} next time.`, ko:`ë‹¤ìŒì— ${t}ë¥¼ ë” ì˜í•˜ë ¤ê³  ë©”ëª¨ë¥¼ ë‚¨ê²¼ì–´ìš”.`},
    {en:`I kept my expectations realistic for ${t}.`, ko:`${t}ì— ëŒ€í•œ ê¸°ëŒ€ì¹˜ë¥¼ í˜„ì‹¤ì ìœ¼ë¡œ ì¡ì•˜ì–´ìš”.`},
    {en:`I planned a simple routine around ${t}.`, ko:`${t}ë¥¼ ìœ„í•œ ê°„ë‹¨í•œ ë£¨í‹´ì„ ì„¸ì› ì–´ìš”.`},
    {en:`I found a tool that makes ${t} easier.`, ko:`${t}ë¥¼ ë” ì‰½ê²Œ í•˜ëŠ” ë„êµ¬ë¥¼ ì°¾ì•˜ì–´ìš”.`},
    {en:`I practiced a few times to get used to ${t}.`, ko:`${t}ì— ìµìˆ™í•´ì§€ë ¤ê³  ëª‡ ë²ˆ ì—°ìŠµí–ˆì–´ìš”.`},
    {en:`I checked my progress on ${t}.`, ko:`${t} ì§„í–‰ ìƒí™©ì„ í™•ì¸í–ˆì–´ìš”.`},
    {en:`I fixed a small issue that blocked ${t}.`, ko:`${t}ë¥¼ ë§‰ë˜ ì‘ì€ ë¬¸ì œë¥¼ í•´ê²°í–ˆì–´ìš”.`},
    {en:`I adjusted my schedule to fit ${t}.`, ko:`${t}ì— ë§ê²Œ ì¼ì •ì„ ì¡°ì •í–ˆì–´ìš”.`},
    {en:`I asked for feedback about ${t}.`, ko:`${t}ì— ëŒ€í•œ í”¼ë“œë°±ì„ ìš”ì²­í–ˆì–´ìš”.`},
    {en:`I kept ${t} consistent but flexible.`, ko:`${t}ë¥¼ ê¾¸ì¤€íˆ í•˜ë˜ ìœ ì—°í•˜ê²Œ í–ˆì–´ìš”.`},
    {en:`I wrapped up the basics of ${t}.`, ko:`${t}ì˜ ê¸°ë³¸ì„ ë§ˆë¬´ë¦¬í–ˆì–´ìš”.`},
    {en:`I set a reminder to revisit ${t} soon.`, ko:`ê³§ ${t}ë¥¼ ë‹¤ì‹œ ë³´ë ¤ê³  ì•Œë¦¼ì„ ì„¤ì •í–ˆì–´ìš”.`},
    {en:`Iâ€™m glad ${t} is moving in the right direction.`, ko:`${t}ê°€ ì¢‹ì€ ë°©í–¥ìœ¼ë¡œ ê°€ì„œ ë‹¤í–‰ì´ì—ìš”.`},
  ];
}

/* ====== ì¹´í…Œê³ ë¦¬ ë¼ìš°íŒ… ====== */
function build21ByCategory(cat, title){
  switch(cat){
    case 'coffee': return lines_coffee();
    case 'airport': return lines_airport();
    case 'hotel': return lines_hotel();
    // ì•„ë˜ëŠ” ê°„ê²°í™”ë¥¼ ìœ„í•´ ëŒ€ë¶€ë¶„ genericì— title ì£¼ì….
    // í•„ìš” ì‹œ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ì „ìš© ì„¸íŠ¸ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.
    default: return lines_generic(title);
  }
}

/* ====== bank21(title) â†’ TOPIC_BANKS ì‚¬ìš© ====== */
function bank21(title){
  const override = TOPIC_BANKS[title];
  if (Array.isArray(override) && override.length === 21) {
    return override; // ì™„ì „ ì»¤ìŠ¤í…€ 21ë¬¸ì¥
  }
  // category ë¬¸ìì—´ì´ë©´ í•´ë‹¹ ì „ìš©/ë²”ìš© ì„¸íŠ¸ ìƒì„±
  const cat = (typeof override === 'string' && override) ? override : 'generic';
  return build21ByCategory(cat, title);
}

/* ====== Per-day state ====== */
function ensureDayState(day){
  const k='Day'+day;
  if(!prog[k]){ prog[k]={ comboScore:null, done:false, bankOffset:0 }; }
  if(typeof prog[k].bankOffset!=='number') prog[k].bankOffset=0;
  return prog[k];
}

/* ====== TTS ====== */
let voices=[]; const voiceSelect=document.getElementById('voiceSelect');
function loadVoices(){ try{ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
function sortVoices(list){ return [...list].sort((a,b)=>{ const score=v=>(/en[-_]?US/i.test(v.lang)?2:/^en/i.test(v.lang)?1:0); const ds=score(b)-score(a); return ds||((a.name||'').localeCompare(b.name||'')); }); }
function populateVoiceSelect(){ voiceSelect.innerHTML=''; if(!voices.length){ const o=document.createElement('option'); o.textContent='(no voices)'; o.value=''; voiceSelect.appendChild(o); voiceSelect.disabled=true; return; } voiceSelect.disabled=false; const sorted=sortVoices(voices); for(const v of sorted){ const o=document.createElement('option'); o.value=v.voiceURI||v.name||''; o.textContent=`${v.name} â€” ${v.lang}`; voiceSelect.appendChild(o);} const byURI=sorted.find(v=>(v.voiceURI||'')===(user.voiceURI||'')); if(byURI) voiceSelect.value=byURI.voiceURI||''; else { const enUS=sorted.find(v=>/en[-_]?US/i.test(v.lang)); voiceSelect.value=(enUS&&(enUS.voiceURI||''))||(sorted[0].voiceURI||''); user.voiceURI=voiceSelect.value; saveUser(user);} }
async function waitForVoices(timeout=2000){ if(!('speechSynthesis' in window)) return; loadVoices(); if(voices.length) return; await new Promise(res=>{ const t0=Date.now(); function h(){ loadVoices(); if(voices.length||Date.now()-t0>timeout){ speechSynthesis.removeEventListener('voiceschanged',h); res(); } } speechSynthesis.addEventListener('voiceschanged',h); setTimeout(h,timeout); }); }
if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.addEventListener('voiceschanged', ()=>{ loadVoices(); populateVoiceSelect(); }); }
function resumeTTS(){ try{ if('speechSynthesis' in window && speechSynthesis.paused) speechSynthesis.resume(); }catch(_){} }
window.addEventListener('pointerdown', resumeTTS, { once:true }); document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resumeTTS(); });
function getVoice(){ if(!voices.length) return null; if(user.voiceURI){ const v=voices.find(v=>(v.voiceURI||'')===user.voiceURI); if(v) return v; } return voices.find(v=>/en[-_]?US/i.test(v.lang))||voices.find(v=>/^en/i.test(v.lang))||voices[0]||null; }
voiceSelect.addEventListener('change', ()=>{ user.voiceURI=voiceSelect.value||''; saveUser(user); toast('TTS ë³´ì´ìŠ¤ë¥¼ ë³€ê²½í–ˆì–´ìš”.'); });
function speakOnce(text){ return new Promise(async (resolve)=>{ if(!('speechSynthesis' in window)) return resolve(); await waitForVoices(); resumeTTS(); const utt=new SpeechSynthesisUtterance(text); utt.lang=user.lang||'en-US'; utt.rate=user.ttsRate||1; const v=getVoice(); if(v){ utt.voice=v; utt.lang=v.lang||utt.lang; } utt.onend=()=>resolve(); try{ if(speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){} setTimeout(()=>speechSynthesis.speak(utt),0); }); }
async function speakQueue(arr,onStart,onEnd){ try{ onStart&&onStart(); for(const s of arr){ await speakOnce(s); } } finally{ onEnd&&onEnd(); } }
function speak(text){ return speakQueue([text]); }

/* ====== STT & Scoring ====== */
function createRecognizer(onResult,onEnd,{continuous=false,interim=false}={}){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤. (Android Chrome ê¶Œì¥)'); return null; } const rec=new SR(); rec.lang='en-US'; rec.interimResults=!!interim; rec.continuous=!!continuous; rec.maxAlternatives=1; rec.onresult=(e)=>onResult&&onResult(e); rec.onerror=(e)=>{/* ì¼ì‹œ ì˜¤ë¥˜ëŠ” onendì—ì„œ ë³µêµ¬ */}; rec.onend=()=>onEnd&&onEnd(); return rec; }
function levenshtein(a,b){ const m=a.length,n=b.length; const d=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) d[i][0]=i; for(let j=0;j<=n;j++) d[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);} } return d[m][n]; }
function norm(s){ return s.toLowerCase().replace(/[^a-z\s]/g,'').replace(/\s+/g,' ').trim(); }
function scoreSentence(ref,hyp){ const A=norm(ref),B=norm(hyp); if(!B) return 0; const dist=levenshtein(A,B); const max=Math.max(A.length,B.length)||1; return Math.max(0, Math.round((1-dist/max)*100)); }
function tokenize(s){ return norm(s).split(' ').filter(Boolean); }
function wordDiffFeedback(ref, hyp){ const R=tokenize(ref), H=tokenize(hyp); if(!H.length) return ['ì¡°ê¸ˆ ë” í¬ê²Œ, ë˜ë ·í•˜ê²Œ ë§í•´ì¤˜ìš”!']; const setH=new Set(H); const tips=[]; const missing=R.filter(w=>!setH.has(w)); if(missing.length>=2) tips.push('ë‹¨ì–´ ëª‡ ê°œ ë¹ ì¡Œì–´ìš” (ëê¹Œì§€ ë§í•˜ê¸°).'); if(H.length <= Math.max(2, Math.floor(R.length*0.6))) tips.push('ì¡°ê¸ˆ ë” ê¸¸ê²Œ, ì „ì²´ ë¬¸ì¥ì„ ë§í•´ë³´ì„¸ìš”.'); if(tips.length<=1) tips.push('ì–µì–‘ì„ ì‚´ë ¤ ìì—°ìŠ¤ëŸ½ê²Œ ì½ì–´ë³´ì„¸ìš”.'); return tips.slice(0,2); }

/* ====== UI Refs ====== */
const tabs=document.querySelectorAll('.tab');
const views={home:document.getElementById('home'),challenge:document.getElementById('challenge'),progress:document.getElementById('progress')};
const elDayNum=document.getElementById('dayNum'); const elTitle=document.getElementById('dayTitle'); const elLines=document.getElementById('lines');
const elAvg=document.getElementById('avgScore'); const elMeter=document.getElementById('meterBar');
const btnRetry=document.getElementById('btnRetry'); const btnReset=document.getElementById('btnReset');

for (const t of tabs){ t.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active');
  Object.values(views).forEach(v=>v.style.display='none'); views[t.dataset.view].style.display='';
  if(t.dataset.view==='challenge') renderChallenge100();
  if(t.dataset.view==='progress') renderHistory();
}); }

/* ====== Toast ====== */
let toastTimer; function toast(msg){ clearTimeout(toastTimer); const el=document.getElementById('toast'); const m=document.getElementById('toastMsg'); m.textContent=msg; el.style.display='flex'; toastTimer=setTimeout(()=>el.style.display='none', 1800); }

/* ====== TTS rate ====== */
const elRate=document.getElementById('rate');
elRate.textContent=(user.ttsRate||1).toFixed(1)+'x';
document.getElementById('rateDown').onclick=()=>{ user.ttsRate=Math.max(.6, Math.round(((user.ttsRate||1)-.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };
document.getElementById('rateUp').onclick=()=>{ user.ttsRate=Math.min(1.4, Math.round(((user.ttsRate||1)+.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };

/* ====== Render Today (fixed 21 bank, 3 lines per view) ====== */
function renderToday(){
  const day=getTodayDay(); const state=ensureDayState(day);
  const title=TITLES[day-1]; const bank = bank21(title);
  const start = (state.bankOffset||0) % 21;
  const lines = [0,1,2].map(i=> bank[(start+i)%21]);

  elDayNum.textContent=day; elTitle.textContent=title; elLines.innerHTML='';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const sttSupported=!!SR;

  lines.forEach((pair)=>{
    const text = pair.en;
    const line=document.createElement('div'); line.className='line';

    const pEn=document.createElement('p'); pEn.textContent=text; line.appendChild(pEn);
    const pKo=document.createElement('p'); pKo.textContent=pair.ko; pKo.className='ko'; line.appendChild(pKo);

    const row=document.createElement('div'); row.className='row';

    const btnPlay=document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='â–¶ï¸ ë“£ê¸°';
    btnPlay.onclick=()=>{ speak(text); };

    const btnRec=document.createElement('button'); btnRec.className='btn pri'; btnRec.textContent='â— ë§í•˜ê¸°(ì—°ìŠµ)';
    const btnStop=document.createElement('button'); btnStop.className='btn'; btnStop.textContent='â–  ì¤‘ì§€'; btnStop.disabled=true;
    if(!sttSupported){ btnRec.disabled=true; btnStop.disabled=true; btnRec.title='ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤.'; }

    const scoreBox=document.createElement('span'); scoreBox.className='score'; scoreBox.style.marginLeft='6px';
    const fbBox=document.createElement('span'); fbBox.className='feedback'; fbBox.textContent='';

    // ì—°ìŠµ: ë°˜ë“œì‹œ ì‚¬ìš©ìê°€ ì¤‘ì§€ ëˆŒëŸ¬ì•¼ ì¢…ë£Œ(ìë™ ì¢…ë£Œì‹œ ì¬ì‹œì‘)
    let rec=null, recActive=false, hypAccum='';
    function setRecUI(active){ if(active){ btnRec.classList.add('rec'); btnRec.textContent='â— ë“£ëŠ” ì¤‘â€¦(ì—°ìŠµ)'; } else { btnRec.classList.remove('rec'); btnRec.textContent='â— ë§í•˜ê¸°(ì—°ìŠµ)'; } }
    function startLineRec(){
      rec = createRecognizer((e)=>{
        for(let i=e.resultIndex;i<e.results.length;i++){
          const r=e.results[i];
          if(r.isFinal){ hypAccum += (hypAccum?' ':'') + r[0].transcript; }
        }
      }, ()=>{
        if(recActive){ try{ rec=null; setTimeout(startLineRec, 200); }catch(_){} }
        else {
          const s=scoreSentence(text,hypAccum);
          const fb = (s===100) ? ['ì˜í–ˆì–´ìš”!'] : wordDiffFeedback(text,hypAccum);
          scoreBox.textContent=`ì—°ìŠµ ì ìˆ˜ ${s}%`;
          fbBox.textContent=fb.join(' Â· ');
          btnRec.disabled=false; btnStop.disabled=true; btnStop.textContent='â–  ì¤‘ì§€';
          setRecUI(false);
        }
      }, {continuous:true, interim:false});
      if(rec){ try{ rec.start(); }catch(_){ toast('ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨. ê¶Œí•œ/ë‹¤ë¥¸ ì•± ì ê²€ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'); } }
    }
    btnRec.onclick=()=>{ if(rec||!sttSupported) return; recActive=true; hypAccum=''; btnRec.disabled=true; btnStop.disabled=false; setRecUI(true); toast('ë§í•´ ë³´ì„¸ìš”â€¦ (ì—°ìŠµ)'); startLineRec(); };
    btnStop.onclick=()=>{ if(!rec) return; recActive=false; try{ rec.stop(); }catch(_){} btnStop.disabled=true; btnStop.textContent='ì¤‘ì§€ë¨'; };

    row.appendChild(btnPlay); row.appendChild(btnRec); row.appendChild(btnStop); row.appendChild(scoreBox);
    line.appendChild(row); line.appendChild(fbBox);
    elLines.appendChild(line);
  });

  // 3ë¬¸ì¥ ì—°ì† ë“£ê¸° & ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)
  const allRow=document.createElement('div'); allRow.className='row';

  const btnAll=document.createElement('button');
  btnAll.className='btn';
  btnAll.textContent='â–¶ï¸ 3ë¬¸ì¥ ì—°ì† ë“£ê¸°';
  btnAll.onclick=()=> speakQueue(lines.map(x=>x.en),
    ()=>{btnAll.disabled=true; btnAll.textContent='â–¶ï¸ ì¬ìƒ ì¤‘â€¦';},
    ()=>{btnAll.disabled=false; btnAll.textContent='â–¶ï¸ 3ë¬¸ì¥ ì—°ì† ë“£ê¸°';});
  allRow.appendChild(btnAll);

  const btnRecAll=document.createElement('button');
  btnRecAll.className='btn pri';
  btnRecAll.textContent='â— 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)';
  if(!sttSupported){ btnRecAll.disabled=true; btnRecAll.title='ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; }
  btnRecAll.onclick=()=> practiceReciteOneShot_final(lines.map(x=>x.en), btnRecAll);
  allRow.appendChild(btnRecAll);

  elLines.appendChild(allRow);

  updateProgress();
}

/* ====== Progress ====== */
function updateProgress(){
  const day=getTodayDay(); const d=ensureDayState(day);
  const avg = (typeof d.comboScore==='number') ? d.comboScore : 0;
  elAvg.textContent = avg>0 ? (avg+'%') : 'â€”';
  elMeter.style.width = `${avg}%`;
  const pass = avg>=80;
  const elDone=document.getElementById('markDone');
  elDone.disabled=!pass; elDone.textContent=pass?'âœ” ì¡°ê±´ ì¶©ì¡±! ì˜¤ëŠ˜ ì™„ë£Œí•˜ê¸°':'âœ” ì˜¤ëŠ˜ ì™„ë£Œë¡œ í‘œì‹œ';
  elDone.onclick=()=>{ if(pass){ markDone(getTodayDay(),avg); } };
}

function markDone(day,avg){
  const k='Day'+day; const title=TITLES[day-1];
  const now=todayKey();
  prog[k] = { ...(prog[k]||{}), comboScore:avg, done:true };
  prog.lastDone=k;
  const prev='Day'+(day-1), prevStreak=prog.streak||0;
  prog.streak = (day>1 && prog[prev]&&prog[prev].done)? prevStreak+1 : 1;
  if(!Array.isArray(prog._history)) prog._history=[];
  prog._history = prog._history.filter(h=>h.day!==day);
  prog._history.push({ day, date: now, title, avg });
  saveProg(prog);
  document.getElementById('streak').textContent=prog.streak;
  document.getElementById('lastDone').textContent=prog.lastDone;
  toast('âœ… ì˜¤ëŠ˜ í•™ìŠµ ì™„ë£Œ! ê¸°ë¡ì— ì €ì¥í–ˆì–´ìš”.');
  renderChallenge100(); renderHistory();
}

/* ====== 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜) ====== */
function concatenateLines(lines){ return lines.join(' '); }
function practiceReciteOneShot_final(lines, triggerBtn){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.'); return; }

  const origText = triggerBtn ? triggerBtn.textContent : '';
  function restoreTrigger(){
    if(triggerBtn){
      triggerBtn.classList.remove('rec');
      triggerBtn.disabled = false;
      triggerBtn.textContent = origText || 'â— 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)';
    }
  }

  const wrap=document.createElement('div'); wrap.className='practice';
  const box=document.createElement('div'); box.className='box';
  const refs = lines.map((s,i)=>`${i+1}. ${s}`).join('\n');
  box.innerHTML = `
    <h3>ğŸ¤ 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸° (ì ìˆ˜ ë°˜ì˜)</h3>
    <div class="ref">ì•„ë˜ 3ë¬¸ì¥ì„ í•œ ë²ˆì— ìì—°ìŠ¤ëŸ½ê²Œ ë§í•´ ë³´ì„¸ìš”.\n\n${refs}</div>
    <div class="meta">
      <button class="btn pri" id="btnStart">â— ë§í•˜ê¸° ì‹œì‘</button>
      <button class="btn" id="btnStop" disabled>â–  ì¤‘ì§€</button>
      <span class="small">ì—¬ëŸ¬ ë²ˆ ì‹œë„ ê°€ëŠ¥. <b>ë‹«ê¸°</b>ë¥¼ ëˆ„ë¥¸ ì‹œì ì˜ ì ìˆ˜ê°€ ë°˜ì˜ë©ë‹ˆë‹¤.</span>
    </div>
    <div class="result" id="resultBox" style="display:none">
      <div>ì ìˆ˜: <b id="sumScore">â€”</b></div>
      <div class="feedback" id="sumFb"></div>
      <div style="margin-top:8px"><button class="btn" id="btnClosePanel">ë‹«ê¸°</button></div>
    </div>
  `;
  wrap.appendChild(box); document.body.appendChild(wrap);

  const btnStart = box.querySelector('#btnStart');
  const btnStop  = box.querySelector('#btnStop');
  const resultBox= box.querySelector('#resultBox');
  const sumScore = box.querySelector('#sumScore');
  const sumFb    = box.querySelector('#sumFb');

  let rec=null, finalText='', lastScore=null, lastFb='';
  let recActive=false;
  let canStart=true;

  function resetStartUI(){ btnStart.classList.remove('rec'); btnStart.textContent='â— ë§í•˜ê¸° ì‹œì‘'; btnStart.disabled=false; }
  function startRecognizer(){
    rec = createRecognizer(onResult, onEnd, {continuous:true, interim:false});
    if(rec){ try{ rec.start(); }catch(_){ canStart=true; resetStartUI(); btnStop.disabled=true; toast('ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'); } }
    else { canStart=true; resetStartUI(); btnStop.disabled=true; }
  }

  function onResult(e){
    for (let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal) finalText += (finalText?' ':'') + r[0].transcript;
    }
  }
  function onEnd(){
    if(recActive){ try{ rec=null; setTimeout(startRecognizer, 200); }catch(_){}; return; }
    const refAll = concatenateLines(lines);
    const sc = scoreSentence(refAll, finalText);
    const fb = (sc===100) ? ['ì˜í–ˆì–´ìš”!'] : wordDiffFeedback(refAll, finalText);

    lastScore = isNaN(sc)? null : sc; lastFb = fb.join(' Â· ');
    sumScore.textContent = (lastScore==null)? 'â€”' : (lastScore + '%');
    sumFb.textContent = lastFb; resultBox.style.display = '';

    btnStop.disabled = true; btnStop.textContent = 'ì¤‘ì§€ë¨';
    resetStartUI(); rec=null; setTimeout(()=>{ canStart=true; }, 200);
  }

  btnStart.onclick = ()=>{
    if(!canStart || recActive) return;
    canStart=false; finalText='';
    recActive=true;
    if(triggerBtn){ triggerBtn.classList.add('rec'); triggerBtn.disabled=true; triggerBtn.textContent='â— ì—°ì† ë§í•˜ê¸° ì¤‘â€¦'; }
    btnStart.classList.add('rec'); btnStart.textContent='â— ë“£ëŠ” ì¤‘â€¦'; btnStart.disabled=true;
    btnStop.disabled=false; btnStop.textContent='â–  ì¤‘ì§€';
    setTimeout(startRecognizer, 150);
    toast('í•œ ë²ˆì— 3ë¬¸ì¥ì„ ë§í•´ ë³´ì„¸ìš”â€¦');
  };

  btnStop.onclick = ()=>{
    if(!recActive) return;
    recActive=false;
    if(rec){ try{ rec.stop(); }catch(_){} }
    btnStop.disabled = true; btnStop.textContent = 'ì¤‘ì§€ë¨';
  };

  box.querySelector('#btnClosePanel').onclick = ()=>{
    try{ if(recActive && rec){ recActive=false; rec.abort(); } }catch(_){}
    document.body.removeChild(wrap);
    restoreTrigger();
    if(lastScore!=null){
      const day=getTodayDay(); const d=ensureDayState(day);
      d.comboScore = lastScore; saveProg(prog);
      updateProgress();
      toast(`ì ìˆ˜ ${lastScore}% ë°˜ì˜ ì™„ë£Œ`);
    } else {
      toast('ì ìˆ˜ ì—†ì´ ë‹«ì•˜ìŠµë‹ˆë‹¤.');
    }
  };
}

/* ====== 100-Day Calendar & History ====== */
function renderChallenge100(){
  const grid=document.getElementById('challenge100'); grid.innerHTML='';
  const cur=getTodayDay();
  for(let i=1;i<=100;i++){
    const cell=document.createElement('div'); cell.className='day'; cell.textContent=i;
    const k='Day'+i; if(prog[k] && prog[k].done){ cell.classList.add('done'); cell.style.borderColor='#3b82f6'; }
    if(i===cur){ cell.style.outline='2px solid #5b8cff'; cell.style.color='#e8eefc'; }
    cell.title=k+(i===cur?' â€¢ today':'');
    cell.onclick=()=>{ prog._currentDay=i; saveProg(prog); tabs.forEach(b=>{ if(b.dataset.view==='home'){ b.click(); }}); renderToday(); };
    grid.appendChild(cell);
  }
}

function renderHistory(){
  const box=document.getElementById('history');
  let list = Array.isArray(prog._history) ? [...prog._history] : [];
  if (!list.length){
    list = Object.entries(prog)
      .filter(([k,v])=>/^Day\d+$/.test(k) && v && typeof v.comboScore==='number')
      .map(([k,v])=>({ day: parseInt(k.slice(3)), date: '', title: TITLES[parseInt(k.slice(3))-1], avg: v.comboScore }));
  }
  list.sort((a,b)=> a.day - b.day);
  if(!list.length){ box.innerHTML='<div class="small">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const frag=document.createDocumentFragment();
  list.forEach(item=>{
    const div=document.createElement('div'); div.className='line';
    const dateTxt = item.date ? ` <span class="small">(${item.date})</span>` : '';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <b>Day ${item.day} â€” ${item.title}${dateTxt}</b><span class="score">${item.avg}%</span></div>`;
    frag.appendChild(div);
  });
  box.innerHTML=''; box.appendChild(frag);
}

/* ====== Shortcuts ====== */
btnRetry.onclick=()=>{
  const day=getTodayDay(); const k='Day'+day; const st=ensureDayState(day);
  st.comboScore=null; st.done=false;
  st.bankOffset = ((st.bankOffset||0) + 3) % 21;
  saveProg(prog);
  renderToday(); updateProgress();
  toast('ğŸ” ë‹¤ìŒ 3ë¬¸ì¥ìœ¼ë¡œ ë°”ê¿¨ì–´ìš”.');
};
btnReset.onclick=()=>{ if(!confirm('ì •ë§ ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? (ì·¨ì†Œ ë¶ˆê°€)')) return;
  localStorage.removeItem(LS_PROGRESS); prog=loadProg();
  prog._startedAt=todayKey(); prog._currentDay=1; prog._lastDate=todayKey(); prog._history=[];
  saveProg(prog);
  renderToday(); renderChallenge100(); renderHistory(); updateProgress(); toast('ğŸ§¹ ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ëì–´ìš”.');
};

/* ====== Auto Day Rollover (KST) ====== */
function autoDayRolloverTick(){
  const nowKey = todayKey();
  if(prog._lastDate !== nowKey){
    prog._lastDate = nowKey;
    prog._currentDay = computeDayFromStart();
    const k='Day'+prog._currentDay;
    if(!prog[k]) prog[k]={ comboScore:null, done:false, bankOffset:0 };
    saveProg(prog);
    renderToday(); renderChallenge100(); updateProgress();
    toast('ğŸ“… ìƒˆë¡œìš´ ë‚ ì´ ì‹œì‘ë˜ì–´ ì£¼ì œë¥¼ ë°”ê¿¨ì–´ìš”!');
  }
}
setInterval(autoDayRolloverTick, 60*1000);
autoDayRolloverTick();

/* ====== PWA ====== */
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }

/* ====== Boot ====== */
function initHeaderKPI(){ document.getElementById('streak').textContent = prog.streak||0; document.getElementById('lastDone').textContent = prog.lastDone||'â€”'; }
function boot(){ initHeaderKPI(); renderToday(); renderChallenge100(); updateProgress(); }
boot();
</script>
</body>
</html>
