<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily 3 Lines </title>

  <!-- 1) ì£¼ì œ ë°ì´í„° íŒŒì¼: topics.js (ì „ì—­ window.TOPICS ì œê³µ í•„ìˆ˜) -->
  <script src="./topics.js?v=20250916"></script>

  <!-- 2) SHIM: TOPICS â†’ TITLES / TOPIC_BANKS (ë¶€ì¡±ë¶„ ìë™ ì±„ì›€ ì œê±°) -->
  <script>
  (function(){
    if (!Array.isArray(window.TOPICS)) {
      console.error("[topics] window.TOPICSê°€ ì—†ìŠµë‹ˆë‹¤. topics.jsë¥¼ ë¨¼ì € ë¡œë“œí–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
      return;
    }
    // ì œëª© ë°°ì—´
    window.TITLES = window.TOPICS.map(t => t.topic);

    // ì£¼ì œë³„ ë¬¸ì¥ [{en,ko}] ë°°ì—´ (21ê°œ ì´ˆê³¼ë§Œ ìë¥´ê³ , ë¶€ì¡±í•´ë„ ê·¸ëŒ€ë¡œ)
    const banks = {};
    for (const item of window.TOPICS) {
      const arr = Array.isArray(item.sentences) ? item.sentences : [];
      const mapped = arr.map(s => {
        if (typeof s === "string") return { en: String(s), ko: "" };
        return { en: (s && s.en) ? String(s.en) : "", ko: (s && s.ko) ? String(s.ko) : "" };
      }).slice(0, 21); // â¬… ìë™ ì±„ì›€ while ë£¨í”„ ì œê±°
      banks[item.topic] = mapped;
    }
    window.TOPIC_BANKS = banks;
  })();
  </script>

  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="/dailyenglish/manifest.webmanifest?v=10">
  <link rel="apple-touch-icon" href="/dailyenglish/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/dailyenglish/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/dailyenglish/icon-192.png">

  <style>
  :root{
    --bg:#0b1020; --card:#111a34; --ink:#e8eefc; --muted:#9fb0df;
    --pri:#5b8cff; --good:#21d39b; --warn:#ffb454; --bad:#ff5c7a;
    --ring:#31457a; --ring-strong:#4a63a8;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
    background:
      radial-gradient(80% 60% at 10% 0%,#15224b 0%,#0b1020 60%),
      radial-gradient(80% 60% at 100% 100%,#0f1834 0%,#0b1020 60%);
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(91,140,255,.15);color:#cfe0ff;border:1px solid var(--ring);font-size:12px}
  nav{display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap; align-items:center}
  .tab{padding:10px 14px;border-radius:12px;background:#101733;border:1px solid var(--ring);cursor:pointer;color:#a7b3d6}
  .tab.active{background:#141f45;color:var(--ink);border-color:#3a5296}
  select{appearance:none;background:#101733;border:1px solid var(--ring);color:#e8eefc;padding:10px 12px;border-radius:10px;min-height:44px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg,#111a34,#0f1731);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .hd{display:flex;align-items:flex-start;justify-content:space-between;padding:18px 18px 0}
  .card .body{padding:14px 18px 20px}
  .title{font-size:26px;margin-top:4px;font-weight:900;letter-spacing:.3px}
  .subtitle{font-size:13px;color:var(--muted)}
  .line{border:1px solid var(--ring);border-radius:16px;padding:14px;margin:12px 0;background:#0f1731}
  .line p{margin:0 0 8px;font-size:18px;line-height:1.5}
  .line p.ko{margin:0 0 10px; font-size:15.5px; line-height:1.6; color:#cbd4f5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .btn{
    appearance:none;border:none;border-radius:12px;padding:10px 14px;
    background:#17224a;color:#e8eefc;border:1px solid #2b3f7a;cursor:pointer;min-height:44px;
    transition:transform .06s ease, filter .15s ease, box-shadow .15s ease;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.pri{background:linear-gradient(180deg,#3d64ff,#2b4bd4);border-color:#3b57e0}
  .btn.warn{background:#3a2a0e;border-color:#9f6b18}
  .btn.ghost{background:transparent;border-color:#2b3f7a}
  .btn.rec{background:linear-gradient(180deg,#ff5c7a,#e44360); border-color:#ff7f97; color:white; box-shadow:0 0 0 2px rgba(255,92,122,.25) inset}

  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px;border:1px solid var(--ring);border-radius:12px;background:#101733;font-size:13px}
  .chip::before{content:''; width:8px; height:8px; border-radius:50%; background:linear-gradient(180deg,#a7baff,#5b8cff); box-shadow:0 0 0 2px rgba(91,140,255,.15);}
  .score{font-weight:900}

  .meter{height:12px;background:#0e1330;border-radius:999px;border:1px solid var(--ring);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff5c7a,#ffb454,#5b8cff,#21d39b)}

  .kpi{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
  .day{aspect-ratio:1/1;border:1px solid #2d3d72;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0e1430;color:#c9d4ff;font-weight:700; font-size:14px}
  @media (max-width:520px){ .calendar{grid-template-columns:repeat(7,1fr)} .day{font-size:13px} .line p{font-size:16px} .title{font-size:22px}}

  .toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;pointer-events:none}
  .toast span{pointer-events:auto;background:#101733;border:1px solid var(--ring);padding:10px 14px;border-radius:12px}

  .small{font-size:12px;color:#a7b3d6}
  .hint{font-size:12.5px;color:#d3dcff;background:#16214a;border:1px solid #2e4489;padding:10px 12px;border-radius:10px}

  /* ì—°ì† ë§í•˜ê¸° íŒ¨ë„ */
  .practice{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;}
  .practice .box{width:min(720px,94vw); max-height:92vh; overflow:auto; background:#101733; border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:var(--shadow);}
  .practice .box h3{margin:0 0 12px; font-size:18px;}
  .practice .ref{font-size:14.5px; color:#cfe0ff; margin:6px 0 12px; white-space:pre-wrap; line-height:1.6}
  .practice .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
  .practice .result{margin-top:12px; padding:12px; border:1px solid var(--ring); border-radius:12px; background:#0f1731}
  .feedback{display:block; font-size:12.5px; color:#cfe0ff; opacity:.95}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily 3 Lines <span class="badge">100ì¼ ì±Œë¦°ì§€</span></h1>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="btnRetry">âŸ² ë‹¤ì‹œ í•˜ê¸°</button>
        <button class="btn warn" id="btnReset">âŸ² ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="home">ì˜¤ëŠ˜ì˜ í•™ìŠµ</button>
      <button class="tab" data-view="challenge">ì±Œë¦°ì§€</button>
      <button class="tab" data-view="progress">ê¸°ë¡</button>

      <div style="display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:wrap">
        <label class="small" for="voiceSelect">Voice</label>
        <select id="voiceSelect" title="TTS Voice"></select>

        <span class="small">ì†ë„</span>
        <button class="btn" id="rateDown">â€“</button>
        <span id="rate" class="small">1.0x</span>
        <button class="btn" id="rateUp">+</button>
      </div>
    </nav>

    <section id="home" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="subtitle">ì˜¤ëŠ˜ì˜ ì œëª© (Day <span id="dayNum">1</span>)</div>
            <div class="title" id="dayTitle">â€”</div>
          </div>
        </div>
        <div class="body" id="lines"></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2>
          <div class="kpi">
            <div class="chip">80ì  ì´ìƒ ì„±ê³µ</div>
            <div class="chip">ì ìˆ˜: <span class="score" id="avgScore">â€”</span></div>
          </div>
        </div>
        <div class="body">
          <div class="meter" title="3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸° ì ìˆ˜"><i id="meterBar"></i></div>
          <div style="height:12px"></div>
          <button class="btn pri" id="markDone" disabled>âœ” ì˜¤ëŠ˜ ì™„ë£Œë¡œ í‘œì‹œ</button>
          <div style="height:12px"></div>
          <div class="hint">ì„¸ ë¬¸ì¥ì„ ëª¨ë‘ ë“£ê³ (â–¶ï¸) <b>3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì ìˆ˜ ë°˜ì˜)</b>ì—ì„œ 80ì  ì´ìƒì´ë©´ ì™„ë£Œí•  ìˆ˜ ìˆì–´ìš”.</div>
          <div style="height:12px"></div>
          <div class="kpi">
            <div class="chip">ì—°ì†ì¼ìˆ˜: <b id="streak">0</b>ì¼</div>
            <div class="chip">ë§ˆì§€ë§‰ ì™„ë£Œ: <span id="lastDone">â€”</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" style="display:none">
      <div class="card">
        <div class="hd"><h2>100ì¼ ì±Œë¦°ì§€</h2><div class="chip">Day 1 â†’ Day 100</div></div>
        <div class="body">
          <div class="calendar" id="challenge100"></div>
        </div>
      </div>
    </section>

    <section id="progress" style="display:none">
      <div class="card">
        <div class="hd"><h2>ì ìˆ˜ ê¸°ë¡</h2></div>
        <div class="body"><div id="history"></div></div>
      </div>
    </section>

    <div class="toast" id="toast" style="display:none"><span id="toastMsg"></span></div>
  </div>

<script>
/* ====== Storage / Date Utilities ====== */
const LS_USER='d3l_user', LS_PROGRESS='d3l_progress';
function todayKey(){ const f = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit'}); return f.format(new Date()); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER)||'{"ttsRate":1,"lang":"en-US","voiceURI":""}'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function loadProg(){ return JSON.parse(localStorage.getItem(LS_PROGRESS)||'{}'); }
function saveProg(p){ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }

let user=loadUser(), prog=loadProg();
if(!prog._startedAt){ prog._startedAt=todayKey(); }
if(!prog._currentDay){ prog._currentDay=1; }
if(!prog._lastDate){ prog._lastDate=todayKey(); } // KST ê¸°ì¤€ ë§ˆì§€ë§‰ ë³¸ ë‚ ì§œ
if(!Array.isArray(prog._history)) { prog._history = []; }
saveProg(prog);

function computeDayFromStart(){
  const start = new Date(prog._startedAt+'T00:00:00+09:00');
  return Math.max(1, Math.min(100, Math.floor((Date.now()-start)/86400000)+1));
}
function getTodayDay(){
  const cur=prog._currentDay || computeDayFromStart();
  const d=Math.max(1,Math.min(100,cur));
  if(prog._currentDay!==d){ prog._currentDay=d; saveProg(prog); }
  return d;
}

/* ====== Titles (fallback) ======
   topics.jsê°€ ìˆìœ¼ë©´ window.TITLESë¥¼ ìš°ì„  ì‚¬ìš© */
var TITLES = window.TITLES || [ 'Morning Routine','Commuting','Coffee Break','Emails','Team Meeting','Project Update','Lunch Out','Groceries','Gym','Evening Walk',
  'Streaming Show','Weekend Plan','Laundry','Room Cleaning','Errands','Bank Visit','Pharmacy','Salon','Car Wash','Pet Care',
  'Cooking Dinner','Takeout','Birthday Party','Small Talk','Weather Chat','Sports Talk','News Catch-up','Book Club','Movie Night','Concert',
  'Coffee Chat','Study Session','Library Visit','Note Taking','Presentation Prep','Public Speaking','Mentor Advice','Goal Setting','Habit Tracking','Budgeting',
  'Online Shopping','Return/Refund','Customer Service','Travel Plan','Packing','Airport','Hotel Check-in','City Tour','Photo Walk','Museum',
  'Park Picnic','Beach Day','Hiking','Rainy Day','Snow Day','Heat Wave','Cold Snap','Sick Day','Clinic Visit','Dentist Visit',
  'Back to Work','Overtime','Deadline Push','Celebration','Thank-you Notes','Apology','Making Plans','Canceling Plans','Running Late','Time Management',
  'Morning Coffee','Afternoon Slump','Power Nap','Evening Class','Night Drive','Late Snack','Phone Call','Video Call','Texting','Social Media',
  'Digital Detox','Mindfulness','Journaling','Reading','Music Playlist','Podcast','Language Practice','Networking','Interview Prep','Part-time Job',
  'Side Project','Coding Session','Design Draft','Feedback Round','Revision','Final Review','Presentation Day','Rest Day','Family Dinner','Friends Hangout',
  'Date Night','Neighborhood Walk','Farmerâ€™s Market','Car Maintenance','House Plants','Recycling','Donation','Volunteering','Community Event','Holiday Prep'
];

/* ====== Fixed 21-line bank (ê¸°ì¡´ í…œí”Œë¦¿) ======
   â€» ì•„ë˜ bank21ì€ ê·¸ëŒ€ë¡œ ë‘ë˜,
   topics.jsê°€ ì œê³µí•˜ëŠ” TOPIC_BANKSê°€ ìˆìœ¼ë©´ ê·¸ê±¸ **ìš°ì„ ** ì‚¬ìš©í•©ë‹ˆë‹¤. */
function bank21(title){
  const t = String(title||'').toLowerCase();
  return [
    {en:`I spent some time on ${t} today.`, ko:`ì˜¤ëŠ˜ ${t}ì— ì‹œê°„ì„ ì¢€ ì¼ì–´ìš”.`},
    {en:`I tried to keep ${t} simple.`, ko:`${t}ëŠ” ìµœëŒ€í•œ ì‹¬í”Œí•˜ê²Œ í•´ë´¤ì–´ìš”.`},
    {en:`Honestly, ${t} took longer than I expected.`, ko:`ì†”ì§íˆ ${t}ê°€ ìƒê°ë³´ë‹¤ ì˜¤ë˜ ê±¸ë ¸ì–´ìš”.`},
    {en:`I finally got around to ${t}.`, ko:`ë“œë””ì–´ ${t}ë¥¼ í•˜ê²Œ ëì–´ìš”.`},
    {en:`I checked in on ${t} after work.`, ko:`í‡´ê·¼ í›„ ${t}ë¥¼ ì ê¹ ì‚´í´ë´¤ì–´ìš”.`},
    {en:`Nothing fancy with ${t}â€”just the basics.`, ko:`${t}ëŠ” ê±°ì°½í•˜ê²Œ ì•ˆ í•˜ê³  ê¸°ë³¸ë§Œ í–ˆì–´ìš”.`},
    {en:`I made steady progress on ${t}.`, ko:`${t}ëŠ” ê¾¸ì¤€íˆ ì§„ì „ì´ ìˆì—ˆì–´ìš”.`},
    {en:`I kept ${t} practical, not overthinking it.`, ko:`${t}ëŠ” ì‹¤ìš©ì ìœ¼ë¡œ, ê³¼í•˜ê²Œ ê³ ë¯¼í•˜ì§„ ì•Šì•˜ì–´ìš”.`},
    {en:`We talked about ${t} for a bit.`, ko:`${t}ì— ëŒ€í•´ ì ê¹ ì–˜ê¸°í–ˆì–´ìš”.`},
    {en:`Iâ€™ll try to be more consistent with ${t}.`, ko:`${t}ë¥¼ ë” ê¾¸ì¤€íˆ í•´ë³¼ê²Œìš”.`},
    {en:`Next time, Iâ€™ll plan ${t} ahead.`, ko:`ë‹¤ìŒì—” ${t}ë¥¼ ë¯¸ë¦¬ ê³„íší•´ë³¼ê²Œìš”.`},
    {en:`Small wins on ${t} still count.`, ko:`${t}ì—ì„œ ì‘ì€ ì„±ì·¨ë„ ì˜ë¯¸ ìˆì–´ìš”.`},
    {en:`Slow and steady works for ${t}.`, ko:`${t}ëŠ” ì²œì²œíˆ ê¾¸ì¤€íˆê°€ ë§ëŠ” ê²ƒ ê°™ì•„ìš”.`},
    {en:`I had a quick update on ${t}.`, ko:`${t} ê´€ë ¨í•´ ê°„ë‹¨íˆ ì—…ë°ì´íŠ¸í–ˆì–´ìš”.`},
    {en:`I kept ${t} light but useful.`, ko:`${t}ëŠ” ê°€ë³ê²Œ í–ˆì§€ë§Œ ìœ ìµí–ˆì–´ìš”.`},
    {en:`I ran into a small hiccup with ${t}.`, ko:`${t}ì—ì„œ ì‘ì€ ë¬¸ì œê°€ ìˆì—ˆì–´ìš”.`},
    {en:`I sorted out a few details for ${t}.`, ko:`${t}ì˜ ëª‡ ê°€ì§€ ë””í…Œì¼ì„ ì •ë¦¬í–ˆì–´ìš”.`},
    {en:`${t} wasnâ€™t perfect, but it moved forward.`, ko:`${t}ê°€ ì™„ë²½í•˜ì§„ ì•Šì•˜ì§€ë§Œ ì§„ì „ëì–´ìš”.`},
    {en:`I wrapped up the basics of ${t}.`, ko:`${t}ì˜ ê¸°ë³¸ì€ ë§ˆë¬´ë¦¬í–ˆì–´ìš”.`},
    {en:`I set a simple goal for ${t} this week.`, ko:`ì´ë²ˆ ì£¼ ${t}ì— ë‹¨ìˆœí•œ ëª©í‘œë¥¼ ì„¸ì› ì–´ìš”.`},
    {en:`Iâ€™m glad ${t} is finally on track.`, ko:`${t}ê°€ ë“œë””ì–´ ê¶¤ë„ì— ì˜¬ë¼ì„œ ë‹¤í–‰ì´ì—ìš”.`},
  ];
}
/* ğŸ” Override: ì™¸ë¶€ TOPIC_BANKSê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš© */
const __origBank21 = bank21;
bank21 = function(title){
  const banks = window.TOPIC_BANKS || {};
  if (Array.isArray(banks[title]) && banks[title].length) return banks[title];
  return __origBank21(title);
};

/* ====== Per-day state ====== */
function ensureDayState(day){
  const k='Day'+day;
  if(!prog[k]){ prog[k]={ comboScore:null, done:false, bankOffset:0 }; }
  if(typeof prog[k].bankOffset!=='number') prog[k].bankOffset=0;
  return prog[k];
}

/* ====== TTS ====== */
let voices=[]; const voiceSelect=document.getElementById('voiceSelect');
function loadVoices(){ try{ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
function sortVoices(list){ return [...list].sort((a,b)=>{ const score=v=>(/en[-_]?US/i.test(v.lang)?2:/^en/i.test(v.lang)?1:0); const ds=score(b)-score(a); return ds||((a.name||'').localeCompare(b.name||'')); }); }
function populateVoiceSelect(){ voiceSelect.innerHTML=''; if(!voices.length){ const o=document.createElement('option'); o.textContent='(no voices)'; o.value=''; voiceSelect.appendChild(o); voiceSelect.disabled=true; return; } voiceSelect.disabled=false; const sorted=sortVoices(voices); for(const v of sorted){ const o=document.createElement('option'); o.value=v.voiceURI||v.name||''; o.textContent=`${v.name} â€” ${v.lang}`; voiceSelect.appendChild(o);} const byURI=sorted.find(v=>(v.voiceURI||'')===(user.voiceURI||'')); if(byURI) voiceSelect.value=byURI.voiceURI||''; else { const enUS=sorted.find(v=>/en[-_]?US/i.test(v.lang)); voiceSelect.value=(enUS&&(enUS.voiceURI||''))||(sorted[0].voiceURI||''); user.voiceURI=voiceSelect.value; saveUser(user);} }
async function waitForVoices(timeout=2000){ if(!('speechSynthesis' in window)) return; loadVoices(); if(voices.length) return; await new Promise(res=>{ const t0=Date.now(); function h(){ loadVoices(); if(voices.length||Date.now()-t0>timeout){ speechSynthesis.removeEventListener('voiceschanged',h); res(); } } speechSynthesis.addEventListener('voiceschanged',h); setTimeout(h,timeout); }); }
if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.addEventListener('voiceschanged', ()=>{ loadVoices(); populateVoiceSelect(); }); }
function resumeTTS(){ try{ if('speechSynthesis' in window && speechSynthesis.paused) speechSynthesis.resume(); }catch(_){} }
window.addEventListener('pointerdown', resumeTTS, { once:true }); document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resumeTTS(); });
function getVoice(){ if(!voices.length) return null; if(user.voiceURI){ const v=voices.find(v=>(v.voiceURI||'')===user.voiceURI); if(v) return v; } return voices.find(v=>/en[-_]?US/i.test(v.lang))||voices.find(v=>/^en/i.test(v.lang))||voices[0]||null; }
voiceSelect.addEventListener('change', ()=>{ user.voiceURI=voiceSelect.value||''; saveUser(user); toast('TTS ë³´ì´ìŠ¤ë¥¼ ë³€ê²½í–ˆì–´ìš”.'); });
function speakOnce(text){ return new Promise(async (resolve)=>{ if(!('speechSynthesis' in window)) return resolve(); await waitForVoices(); resumeTTS(); const utt=new SpeechSynthesisUtterance(text); utt.lang=user.lang||'en-US'; utt.rate=user.ttsRate||1; const v=getVoice(); if(v){ utt.voice=v; utt.lang=v.lang||utt.lang; } utt.onend=()=>resolve(); try{ if(speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){} setTimeout(()=>speechSynthesis.speak(utt),0); }); }
async function speakQueue(arr,onStart,onEnd){ try{ onStart&&onStart(); for(const s of arr){ await speakOnce(s); } } finally{ onEnd&&onEnd(); } }
function speak(text){ return speakQueue([text]); }

/* ====== STT & Scoring ====== */
/* â€¦ (ê¸°ì¡´ ë‚´ìš© ê·¸ëŒ€ë¡œ) â€¦ */

/* ====== Render Today (fixed 21 bank, 3 lines per view) ====== */
const tabs=document.querySelectorAll('.tab');
const views={home:document.getElementById('home'),challenge:document.getElementById('challenge'),progress:document.getElementById('progress')};
const elDayNum=document.getElementById('dayNum'); const elTitle=document.getElementById('dayTitle'); const elLines=document.getElementById('lines');
const elAvg=document.getElementById('avgScore'); const elMeter=document.getElementById('meterBar');
const btnRetry=document.getElementById('btnRetry'); const btnReset=document.getElementById('btnReset');

function renderToday(){
  const day=getTodayDay(); const state=ensureDayState(day);
  const title=TITLES[(day-1) % TITLES.length];
  const bank = bank21(title);
  const start = (state.bankOffset||0) % 21;
  const lines = [0,1,2].map(i=> bank[(start+i)%21]).filter(Boolean);

  elDayNum.textContent=day; elTitle.textContent=title; elLines.innerHTML='';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const sttSupported=!!SR;

  lines.forEach((pair)=>{
    const text = pair.en || '';
    const line=document.createElement('div'); line.className='line';

    const pEn=document.createElement('p'); pEn.textContent=text; line.appendChild(pEn);
    const pKo=document.createElement('p'); pKo.textContent=pair.ko||''; pKo.className='ko'; line.appendChild(pKo);

    const row=document.createElement('div'); row.className='row';

    const btnPlay=document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='â–¶ï¸ ë“£ê¸°';
    btnPlay.onclick=()=>{ speak(text); };

    const btnRec=document.createElement('button'); btnRec.className='btn pri'; btnRec.textContent='â— ë§í•˜ê¸°(ì—°ìŠµ)';
    const btnStop=document.createElement('button'); btnStop.className='btn'; btnStop.textContent='â–  ì¤‘ì§€'; btnStop.disabled=true;
    if(!sttSupported){ btnRec.disabled=true; btnStop.disabled=true; btnRec.title='ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤.'; }

    row.appendChild(btnPlay); row.appendChild(btnRec); row.appendChild(btnStop);
    line.appendChild(row); elLines.appendChild(line);
  });
}

/* â€¦ ê¸°ì¡´ì˜ ë²„íŠ¼/ì ìˆ˜/ìì • ì „í™˜/ì±Œë¦°ì§€/ê¸°ë¡ ë Œë”ë§ ë¡œì§ì€ ê·¸ëŒ€ë¡œ â€¦ */

document.addEventListener('DOMContentLoaded', ()=>{
  renderToday();
});
</script>
</body>
</html>
