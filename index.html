

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily 3 Lines â€” TTS Â· STT Â· Score Â· 100-Day</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- PWA manifest (ì ˆëŒ€ê²½ë¡œ + ìºì‹œë²„ìŠ¤í„°) -->
  <link rel="manifest" href="/dailyenglish/manifest.webmanifest?v=8">
  <link rel="apple-touch-icon" href="/dailyenglish/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/dailyenglish/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/dailyenglish/icon-192.png">

  <style>
  :root{ --bg:#0b1020; --card:#111a34; --ink:#e8eefc; --muted:#a7b3d6; --pri:#5b8cff; --good:#21d39b; --warn:#ffb454; --bad:#ff5c7a; --ring:#31457a; --shadow:0 12px 40px rgba(0,0,0,.35); --radius:18px; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;color:var(--ink);
    background:radial-gradient(80% 60% at 10% 0%,#15224b 0%,#0b1020 60%), radial-gradient(80% 60% at 100% 100%,#0f1834 0%,#0b1020 60%);}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(91,140,255,.15);color:#cfe0ff;border:1px solid var(--ring);font-size:12px}
  .badge.good{background:rgba(33,211,155,.18);color:#bff2e1;border-color:#2a7e66}
  .badge.bad{background:rgba(255,92,122,.18);color:#ffd1da;border-color:#8a2a3a}
  nav{display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap; align-items:center}
  .tab{padding:10px 14px;border-radius:12px;background:#101733;border:1px solid var(--ring);cursor:pointer;color:#a7b3d6}
  .tab.active{background:#141f45;color:var(--ink);border-color:#3a5296}
  select{appearance:none;background:#101733;border:1px solid var(--ring);color:#e8eefc;padding:8px 10px;border-radius:10px;min-height:40px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg,#111a34,#0f1731);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card h2{font-size:18px;margin:0 0 6px}
  .card .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 0}
  .card .body{padding:12px 14px 16px}
  .title{font-size:26px;font-weight:900;letter-spacing:.3px}
  .subtitle{font-size:13px;color:var(--muted)}
  .line{border:1px solid var(--ring);border-radius:14px;padding:12px;margin:8px 0;background:#0f1731}
  .line p{margin:0 0 6px;font-size:18px;line-height:1.45}
  .line p.ko{margin:0 0 8px; font-size:15px; line-height:1.5; color:#cbd4f5; display:block !important;}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;background:#17224a;color:#e8eefc;border:1px solid #2b3f7a;cursor:pointer;min-height:40px}
  .btn:hover{filter:brightness(1.05)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.pri{background:linear-gradient(180deg,#355bff,#2b4bd4);border-color:#3b57e0}
  .btn.warn{background:#3a2a0e;border-color:#9f6b18}
  .btn.ghost{background:transparent;border-color:#2b3f7a}
  /* â–¶ ê³µí†µ ë…¹ìŒ ì¤‘ ìŠ¤íƒ€ì¼ */
  .btn.rec{background:linear-gradient(180deg,#ff5c7a,#e44360); border-color:#ff7f97; color:white; box-shadow:0 0 0 2px rgba(255,92,122,.25) inset}

  .score{font-weight:800}
  .meter{height:10px;background:#0e1330;border-radius:12px;border:1px solid var(--ring);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff5c7a,#ffb454,#5b8cff,#21d39b)}
  .kpi{display:flex;gap:8px;flex-wrap:wrap}
  .kpi .chip{padding:8px 10px;border:1px solid var(--ring);border-radius:12px;background:#101733;font-size:13px}
  .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:6px}
  @media (max-width:520px){ .calendar{grid-template-columns:repeat(7,1fr);} .line p{font-size:16px} .title{font-size:22px}}
  .day{aspect-ratio:1/1;border:1px dashed #2d3d72;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0e1430;color:#a7b3d6}
  .day.done{border-style:solid;background:radial-gradient(100% 100% at 30% 20%,rgba(33,211,155,.25),transparent 60%)}
  .toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;pointer-events:none}
  .toast span{pointer-events:auto;background:#101733;border:1px solid var(--ring);padding:10px 14px;border-radius:12px}
  .small{font-size:12px;color:#a7b3d6}
  .hint{font-size:12px;color:#d3dcff;background:#16214a;border:1px solid #2e4489;padding:8px 10px;border-radius:10px}

  /* ì—°ì† ë§í•˜ê¸° ì—°ìŠµ íŒ¨ë„ */
  .practice{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9999;}
  .practice .box{width:min(680px,92vw); background:#101733; border:1px solid var(--ring); border-radius:16px; padding:14px; box-shadow:var(--shadow);}
  .practice .box h3{margin:0 0 10px; font-size:18px;}
  .practice .box .item{border:1px solid var(--ring); border-radius:12px; padding:10px; margin:8px 0; background:#0f1731;}
  .practice .box .item .ref{font-size:14px; color:#cfe0ff;}
  .practice .box .item .hyp{font-size:14px; color:#a7b3d6;}
  .practice .box .item .sc{font-weight:800;}
  .feedback{display:block; font-size:12px; color:#cfe0ff; opacity:.9}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily 3 Lines
        <span class="badge">100ì¼ ì±Œë¦°ì§€</span>
        <span id="diagSupport" class="badge">TTS: â€”</span>
        <span id="diagVoices" class="badge">voices: â€”</span>
      </h1>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="btnRetry">âŸ² ë‹¤ì‹œ í•˜ê¸°</button>
        <button class="btn warn" id="btnReset">âŸ² ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="home">ì˜¤ëŠ˜ì˜ í•™ìŠµ</button>
      <button class="tab" data-view="challenge">ì±Œë¦°ì§€</button>
      <button class="tab" data-view="progress">ê¸°ë¡</button>

      <div style="display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:wrap">
        <label class="small" for="voiceSelect">Voice</label>
        <select id="voiceSelect" title="TTS Voice"></select>

        <span class="small">ì†ë„</span>
        <button class="btn" id="rateDown">â€“</button>
        <span id="rate" class="small">1.0x</span>
        <button class="btn" id="rateUp">+</button>
      </div>
    </nav>

    <section id="home" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="subtitle">ì˜¤ëŠ˜ì˜ ì œëª© (Day <span id="dayNum">1</span>)</div>
            <div class="title" id="dayTitle">â€”</div>
          </div>
          <div class="kpi">
            <div class="chip">í‰ê·  ì ìˆ˜: <span class="score" id="avgScore">â€”</span></div>
            <div class="chip">ì§„í–‰: <span id="progressText">0/3</span></div>
          </div>
        </div>
        <div class="body" id="lines"></div>
      </div>

      <div class="card">
        <div class="hd"><h2>ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2><div class="chip">ì„ê³„ì¹˜ 80%+</div></div>
        <div class="body">
          <div class="meter" title="ì „ì²´ ì§„í–‰"><i id="meterBar"></i></div>
          <div style="height:10px"></div>
          <button class="btn pri" id="markDone" disabled>âœ” ì˜¤ëŠ˜ ì™„ë£Œë¡œ í‘œì‹œ</button>
          <div style="height:12px"></div>
          <div class="hint">ì„¸ ë¬¸ì¥ì„ ëª¨ë‘ ë“£ê³ (â–¶ï¸) ë§í•œ ë’¤(â—) í‰ê·  80% ì´ìƒì´ë©´ ì™„ë£Œ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div>
          <div style="height:12px"></div>
          <div class="kpi">
            <div class="chip">ì—°ì†ì¼ìˆ˜: <b id="streak">0</b>ì¼</div>
            <div class="chip">ë§ˆì§€ë§‰ ì™„ë£Œ: <span id="lastDone">â€”</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" style="display:none">
      <div class="card">
        <div class="hd"><h2>100ì¼ ì±Œë¦°ì§€</h2><div class="chip">Day 1 â†’ Day 100</div></div>
        <div class="body">
          <div class="calendar" id="challenge100"></div>
          <div style="height:8px"></div>
          <div class="small">íŒŒë€ í•˜ì´ë¼ì´íŠ¸ = ì™„ë£Œì¼ â€¢ ì¹¸ì„ íƒ­í•˜ë©´ í•´ë‹¹ Dayë¡œ ì´ë™</div>
        </div>
      </div>
    </section>

    <section id="progress" style="display:none">
      <div class="card">
        <div class="hd"><h2>ì ìˆ˜ ê¸°ë¡</h2></div>
        <div class="body"><div id="history"></div></div>
      </div>
    </section>

    <div class="toast" id="toast" style="display:none"><span id="toastMsg"></span></div>
  </div>

<script>
// ===== ìŠ¤í† ë¦¬ì§€ ìœ í‹¸ =====
const LS_USER='d3l_user', LS_PROGRESS='d3l_progress';
function todayKey(){ const f = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit'}); return f.format(new Date()); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER)||'{"ttsRate":1,"lang":"en-US","voiceURI":""}'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function loadProg(){ return JSON.parse(localStorage.getItem(LS_PROGRESS)||'{}'); }
function saveProg(p){ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }
let user=loadUser(), prog=loadProg();
if(!prog._startedAt){ prog._startedAt=todayKey(); saveProg(prog); }
if(!prog._currentDay){ prog._currentDay=1; saveProg(prog); }
if(!Array.isArray(prog._history)) { prog._history = []; saveProg(prog); }
function computeDayFromStart(){ const start = new Date(prog._startedAt+'T00:00:00+09:00'); return Math.max(1, Math.min(100, Math.floor((Date.now()-start)/86400000)+1)); }

// ===== ì œëª©/ëœë¤ ë¬¸ì¥ (ì˜Â·í•œ í…œí”Œë¦¿) =====
const TITLES=[ 'Morning Routine','Commuting','Coffee Break','Emails','Team Meeting','Project Update','Lunch Out','Groceries','Gym','Evening Walk',
  'Streaming Show','Weekend Plan','Laundry','Room Cleaning','Errands','Bank Visit','Pharmacy','Salon','Car Wash','Pet Care',
  'Cooking Dinner','Takeout','Birthday Party','Small Talk','Weather Chat','Sports Talk','News Catch-up','Book Club','Movie Night','Concert',
  'Coffee Chat','Study Session','Library Visit','Note Taking','Presentation Prep','Public Speaking','Mentor Advice','Goal Setting','Habit Tracking','Budgeting',
  'Online Shopping','Return/Refund','Customer Service','Travel Plan','Packing','Airport','Hotel Check-in','City Tour','Photo Walk','Museum',
  'Park Picnic','Beach Day','Hiking','Rainy Day','Snow Day','Heat Wave','Cold Snap','Sick Day','Clinic Visit','Dentist Visit',
  'Back to Work','Overtime','Deadline Push','Celebration','Thank-you Notes','Apology','Making Plans','Canceling Plans','Running Late','Time Management',
  'Morning Coffee','Afternoon Slump','Power Nap','Evening Class','Night Drive','Late Snack','Phone Call','Video Call','Texting','Social Media',
  'Digital Detox','Mindfulness','Journaling','Reading','Music Playlist','Podcast','Language Practice','Networking','Interview Prep','Part-time Job',
  'Side Project','Coding Session','Design Draft','Feedback Round','Revision','Final Review','Presentation Day','Rest Day','Family Dinner','Friends Hangout',
  'Date Night','Neighborhood Walk','Farmerâ€™s Market','Car Maintenance','House Plants','Recycling','Donation','Volunteering','Community Event','Holiday Prep'
];

const L1 = [
  { en:(t)=>`I spent some time on ${t} today.`, ko:(t)=>`ì˜¤ëŠ˜ ${t}ì— ì‹œê°„ì„ ì¢€ ì¼ì–´ìš”.` },
  { en:(t)=>`I worked on ${t} a bit this morning.`, ko:(t)=>`ì˜¤ëŠ˜ ì•„ì¹¨ì— ${t}ë¥¼ ì¡°ê¸ˆ í–ˆì–´ìš”.` },
  { en:(t)=>`We focused on ${t} for a while today.`, ko:(t)=>`ì˜¤ëŠ˜ ${t}ì— ì ì‹œ ì§‘ì¤‘í–ˆì–´ìš”.` },
  { en:(t)=>`I finally got around to ${t}.`, ko:(t)=>`ë“œë””ì–´ ${t}ë¥¼ í•˜ê²Œ ëì–´ìš”.` },
  { en:(t)=>`I checked in on ${t} after work.`, ko:(t)=>`í‡´ê·¼í•˜ê³  ${t}ë¥¼ ì ê¹ ì‚´í´ë´¤ì–´ìš”.` }
];
const L2 = [
  { en:()=>`Nothing fancyâ€”just keeping things simple.`, ko:()=>`ëŒ€ë‹¨í•œ ê±´ ì—†ê³ â€”ê·¸ëƒ¥ ì‹¬í”Œí•˜ê²Œ í–ˆì–´ìš”.` },
  { en:()=>`It took longer than I expected, to be honest.`, ko:()=>`ì†”ì§íˆ ìƒê°ë³´ë‹¤ ì‹œê°„ì´ ì¢€ ê±¸ë ¸ì–´ìš”.` },
  { en:()=>`It was casual but really helpful.`, ko:()=>`ê°€ë³ê²Œ í–ˆì§€ë§Œ ê½¤ ë„ì›€ì´ ëì–´ìš”.` },
  { en:()=>`It wasnâ€™t perfect, but it was progress.`, ko:()=>`ì™„ë²½í•˜ì§„ ì•Šì•˜ì§€ë§Œ, ì§„ì „ì€ ìˆì—ˆì–´ìš”.` },
  { en:()=>`I tried to keep it practical and not overthink it.`, ko:()=>`ì‹¤ìš©ì ìœ¼ë¡œ, ë„ˆë¬´ ê³ ë¯¼í•˜ì§€ ì•Šìœ¼ë ¤ í–ˆì–´ìš”.` }
];
const L3 = [
  { en:()=>`I'll try to be more consistent this week.`, ko:()=>`ì´ë²ˆ ì£¼ì—” ë” ê¾¸ì¤€íˆ í•´ë³¼ê²Œìš”.` },
  { en:()=>`Next time, I'll plan ahead and keep it easy.`, ko:()=>`ë‹¤ìŒì—” ë¯¸ë¦¬ ê³„íší•˜ê³  ì‰½ê²Œ ê°€ë³¼ê²Œìš”.` },
  { en:()=>`I'm glad we're on the same page now.`, ko:()=>`ì´ì œ ìƒê°ì´ ë§ì•„ì„œ ë‹¤í–‰ì´ì—ìš”.` },
  { en:()=>`Small wins still count.`, ko:()=>`ì‘ì€ ì„±ì·¨ë„ ì˜ë¯¸ ìˆì–´ìš”.` },
  { en:()=>`Slow and steady works for me.`, ko:()=>`ì²œì²œíˆ ê¾¸ì¤€íˆê°€ ì œ ìŠ¤íƒ€ì¼ì´ì—ìš”.` }
];

function pickIdx(a){ return Math.floor(Math.random()*a.length); }
function randomLinesBilingual(title){
  const t = title.toLowerCase();
  const i1 = pickIdx(L1), i2 = pickIdx(L2), i3 = pickIdx(L3);
  const s1 = L1[i1], s2 = L2[i2], s3 = L3[i3];
  return [
    { en: s1.en(t), ko: s1.ko(t) },
    { en: s2.en(),  ko: s2.ko()  },
    { en: s3.en(),  ko: s3.ko()  }
  ];
}

// ===== TTS(ë“£ê¸°) â€” ANDROID ì•ˆì •í™” + Voice ì„ íƒ =====
let voices=[];
const voiceSelect = document.getElementById('voiceSelect');

function loadVoices(){ try{ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
function sortVoices(list){
  return [...list].sort((a,b)=>{
    const score = v => (/en[-_]?US/i.test(v.lang)?2 : /^en/i.test(v.lang)?1 : 0);
    const ds = score(b)-score(a);
    if (ds) return ds;
    return (a.name||'').localeCompare(b.name||'');
  });
}
function populateVoiceSelect(){
  voiceSelect.innerHTML='';
  if(!voices || !voices.length){
    const opt=document.createElement('option'); opt.textContent='(no voices)'; opt.value=''; voiceSelect.appendChild(opt); voiceSelect.disabled=true;
    return;
  }
  voiceSelect.disabled=false;
  const sorted = sortVoices(voices);
  for(const v of sorted){
    const opt=document.createElement('option');
    opt.value = v.voiceURI || v.name || '';
    opt.textContent = `${v.name} â€” ${v.lang}`;
    voiceSelect.appendChild(opt);
  }
  const byURI = sorted.find(v => (v.voiceURI||'') === (user.voiceURI||''));
  if(byURI){ voiceSelect.value = byURI.voiceURI||''; }
  else {
    const enUS = sorted.find(v=>/en[-_]?US/i.test(v.lang));
    voiceSelect.value = (enUS && (enUS.voiceURI||'')) || (sorted[0].voiceURI||'');
    user.voiceURI = voiceSelect.value; saveUser(user);
  }
}
async function waitForVoices(timeout=2000){
  if(!('speechSynthesis' in window)) return;
  loadVoices(); if(voices.length) return;
  await new Promise((res)=>{ const t0=Date.now(); function h(){ loadVoices(); if(voices.length || Date.now()-t0>timeout){ speechSynthesis.removeEventListener('voiceschanged',h); res(); } } speechSynthesis.addEventListener('voiceschanged', h); setTimeout(h, timeout); });
}
if('speechSynthesis' in window){
  loadVoices();
  window.speechSynthesis.addEventListener('voiceschanged', ()=>{ loadVoices(); populateVoiceSelect(); updateDiag(); });
}
function resumeTTS(){ try{ if('speechSynthesis' in window && speechSynthesis.paused) speechSynthesis.resume(); }catch(_){} }
window.addEventListener('pointerdown', resumeTTS, { once:true });
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resumeTTS(); });

function getVoice(){
  if(!voices || !voices.length) return null;
  if(user.voiceURI){
    const v = voices.find(v=> (v.voiceURI||'') === user.voiceURI);
    if(v) return v;
  }
  return voices.find(v=>/en[-_]?US/i.test(v.lang)) || voices.find(v=>/^en/i.test(v.lang)) || voices[0] || null;
}
voiceSelect.addEventListener('change', ()=>{
  user.voiceURI = voiceSelect.value || '';
  saveUser(user);
  toast('TTS ë³´ì´ìŠ¤ë¥¼ ë³€ê²½í–ˆì–´ìš”.');
});

function speakOnce(text){
  return new Promise(async (resolve)=>{
    if(!('speechSynthesis' in window)) return resolve();
    await waitForVoices(); resumeTTS();
    const utt = new SpeechSynthesisUtterance(text);
    utt.lang = user.lang || 'en-US';
    utt.rate = user.ttsRate || 1;
    const v=getVoice(); if(v){ utt.voice=v; utt.lang=v.lang||utt.lang; }
    utt.onend=()=>resolve();
    try{ if(speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){}
    setTimeout(()=>speechSynthesis.speak(utt),0);
  });
}
async function speakQueue(arr,onStart,onEnd){ try{ onStart&&onStart(); for(const s of arr){ await speakOnce(s); } } finally { onEnd&&onEnd(); } }
function speak(text){ return speakQueue([text]); }

// ===== STT(ë§í•˜ê¸°) & ì±„ì  + í”¼ë“œë°± =====
function createRecognizer(onResult,onEnd){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”. (Android Chrome ê¶Œì¥)'); return null; }
  const rec=new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
  rec.onresult=(e)=>{ const text=e.results[0][0].transcript; onResult(text); };
  rec.onerror=(e)=>{ toast('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: '+(e.error||'unknown')); };
  rec.onend=()=>{ onEnd&&onEnd(); };
  return rec;
}
function recognizeOnce(){
  return new Promise((resolve,reject)=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ reject(new Error('STT not supported')); return; }
    const rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
    let got=false;
    rec.onresult=(e)=>{ got=true; resolve(e.results[0][0].transcript); };
    rec.onerror=(e)=>{ reject(e); };
    rec.onend=()=>{ if(!got) resolve(''); };
    rec.start();
  });
}
function levenshtein(a,b){ const m=a.length,n=b.length; const d=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++)d[i][0]=i; for(let j=0;j<=n;j++)d[0][j]=j;
  for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);} } return d[m][n]; }
function norm(s){ return s.toLowerCase().replace(/[^a-z\s]/g,'').replace(/\s+/g,' ').trim(); }
function scoreSentence(ref,hyp){ const A=norm(ref),B=norm(hyp); if(!B) return 0; const dist=levenshtein(A,B); const max=Math.max(A.length,B.length)||1; return Math.max(0, Math.round((1-dist/max)*100)); }
// === ê°„ë‹¨ í”¼ë“œë°± ìƒì„± ===
function tokenize(s){ return norm(s).split(' ').filter(Boolean); }
function wordDiffFeedback(ref, hyp){
  const R = tokenize(ref), H = tokenize(hyp);
  if(!H.length) return ['ì¡°ê¸ˆ ë” í¬ê²Œ, ë˜ë ·í•˜ê²Œ ë§í•´ì¤˜ìš”!'];
  const setH = new Set(H);
  const tips = [];
  const missing = R.filter(w=>!setH.has(w));
  if(missing.length>=2) tips.push('ë‹¨ì–´ ëª‡ ê°œ ë¹ ì¡Œì–´ìš” (ì „ì²´ ëê¹Œì§€ ë§í•˜ê¸°).');
  if(H.length <= Math.max(2, Math.floor(R.length*0.6))) tips.push('ë§ì´ ë„ˆë¬´ ì§§ì•„ìš”. ì „ì²´ ë¬¸ì¥ì„ ëê¹Œì§€ ë§í•´ë³´ì„¸ìš”.');
  const endsS = R.filter(w=>/^[a-z]+s$/.test(w));
  if(endsS.some(w=>!H.includes(w))) tips.push('ë³µìˆ˜í˜•/3ì¸ì¹­ ë‹¨ìˆ˜ -s ì†Œë¦¬ë¥¼ ì‚´ë ¤ìš”.');
  const endsED = R.filter(w=>/^[a-z]+ed$/.test(w));
  if(endsED.some(w=>!H.includes(w))) tips.push('ê³¼ê±°í˜• -ed ë°œìŒ ì ê²€!');
  if(/th/.test(norm(ref)) && !/th/.test(norm(hyp))) tips.push('th(Î¸/Ã°) í˜€ë ì†Œë¦¬ ì£¼ì˜!');
  if(/[rl]/.test(norm(ref)) && !/[rl]/.test(norm(hyp))) tips.push('R/L êµ¬ë¶„ ë˜ë ·í•˜ê²Œ!');
  if(/v/.test(norm(ref)) && /b/.test(norm(hyp))) tips.push('v(ì•„ë«ì…ìˆ +ìœ—ì´) vs b êµ¬ë¶„!');
  if(tips.length<=1) tips.push('ì–µì–‘ì„ ì‚´ë ¤ ìì—°ìŠ¤ëŸ½ê²Œ ì½ì–´ë³´ì„¸ìš”.');
  return tips.slice(0,2);
}

// ===== UI ì°¸ì¡° =====
const tabs=document.querySelectorAll('.tab');
const views={home:document.getElementById('home'),challenge:document.getElementById('challenge'),progress:document.getElementById('progress')};
const elTitle=document.getElementById('dayTitle'); const elDayNum=document.getElementById('dayNum'); const elLines=document.getElementById('lines');
const elAvg=document.getElementById('avgScore'); const elProgText=document.getElementById('progressText'); const elMeter=document.getElementById('meterBar');
const elDone=document.getElementById('markDone'); const elStreak=document.getElementById('streak'); const elLastDone=document.getElementById('lastDone');
const elRate=document.getElementById('rate'); const elToast=document.getElementById('toast'); const elToastMsg=document.getElementById('toastMsg');
const btnRetry=document.getElementById('btnRetry'); const btnReset=document.getElementById('btnReset');
const badgeSupport=document.getElementById('diagSupport'); const badgeVoices=document.getElementById('diagVoices');

// íƒ­
for (const t of tabs){ t.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active');
  Object.values(views).forEach(v=>v.style.display='none'); views[t.dataset.view].style.display='';
  if(t.dataset.view==='challenge') renderChallenge100();
  if(t.dataset.view==='progress') renderHistory();
}); }

// í† ìŠ¤íŠ¸
let toastTimer; function toast(msg){ clearTimeout(toastTimer); elToastMsg.textContent=msg; elToast.style.display='flex'; toastTimer=setTimeout(()=>elToast.style.display='none', 1800); }

// TTS ì†ë„
elRate.textContent=(user.ttsRate||1).toFixed(1)+'x';
document.getElementById('rateDown').onclick=()=>{ user.ttsRate=Math.max(.6, Math.round(((user.ttsRate||1)-.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };
document.getElementById('rateUp').onclick=()=>{ user.ttsRate=Math.min(1.4, Math.round(((user.ttsRate||1)+.1)*10)/10); elRate.textContent=user.ttsRate.toFixed(1)+'x'; saveUser(user); };

// ===== ì˜¤ëŠ˜ ë Œë”ë§ =====
function getTodayDay(){ const auto=computeDayFromStart(); const cur=prog._currentDay||auto; const d=Math.max(1,Math.min(100,cur)); if(prog._currentDay!==d){ prog._currentDay=d; saveProg(prog);} return d; }
function ensureDayState(day){ const k='Day'+day; if(!prog[k]){ prog[k]={ lines:[{heard:false,score:null,fb:[]},{heard:false,score:null,fb:[]},{heard:false,score:null,fb:[]}], done:false, avg:null }; saveProg(prog);} return prog[k]; }

function renderToday(){
  const day=getTodayDay(); const data=ensureDayState(day); const title=TITLES[day-1];
  const pairs=randomLinesBilingual(title); // [{en,ko},{en,ko},{en,ko}]
  elDayNum.textContent=day; elTitle.textContent=title; elLines.innerHTML='';
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const sttSupported=!!SR;

  pairs.forEach((pair,i)=>{
    const text = pair.en;
    const line=document.createElement('div'); line.className='line';

    const pEn=document.createElement('p'); pEn.textContent=text; line.appendChild(pEn);
    const pKo=document.createElement('p'); pKo.textContent=pair.ko; pKo.className='ko'; line.appendChild(pKo);

    const row=document.createElement('div'); row.className='row';

    const btnPlay=document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='â–¶ï¸ ë“£ê¸°';
    btnPlay.onclick=()=>{ speak(text); data.lines[i].heard=true; saveProg(prog); updateProgress(); };

    const btnRec=document.createElement('button'); btnRec.className='btn pri'; btnRec.textContent='â— ë§í•˜ê¸°';
    const btnStop=document.createElement('button'); btnStop.className='btn'; btnStop.textContent='â–  ì •ì§€'; btnStop.disabled=true;
    if(!sttSupported){ btnRec.disabled=true; btnStop.disabled=true; btnRec.title='ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤.'; }

    const scoreBox=document.createElement('span'); scoreBox.className='score'; scoreBox.style.marginLeft='6px'; scoreBox.textContent=data.lines[i].score!=null?(`ì ìˆ˜ ${data.lines[i].score}%`):'';
    const fbBox=document.createElement('span'); fbBox.className='feedback'; fbBox.textContent = (data.lines[i].fb||[]).join(' Â· ');

    let rec=null;

    // â–¶ ì¤„ë³„ ë§í•˜ê¸° ìƒíƒœ UI
    function setRecUI(active){
      if(active){ btnRec.classList.add('rec'); btnRec.textContent='â— ë“£ëŠ” ì¤‘â€¦'; }
      else{ btnRec.classList.remove('rec'); btnRec.textContent='â— ë§í•˜ê¸°'; }
    }

    btnRec.onclick=()=>{ 
      if(rec||!sttSupported) return; 
      btnRec.disabled=true; btnStop.disabled=false; setRecUI(true); toast('ë§í•´ ë³´ì„¸ìš”â€¦');
      rec=createRecognizer((hyp)=>{
        const s=scoreSentence(text,hyp);
        const fb = (s===100) ? ['ì˜í–ˆì–´ìš”!'] : wordDiffFeedback(text,hyp);
        data.lines[i].score=s; data.lines[i].fb=fb; saveProg(prog);
        scoreBox.textContent=`ì ìˆ˜ ${s}%`;
        fbBox.textContent=fb.join(' Â· ');
      },()=>{ 
        btnRec.disabled=false; btnStop.disabled=true; setRecUI(false); rec=null; updateProgress(); 
      });
      if(rec) rec.start();
    };

    btnStop.onclick=()=>{ if(rec){ rec.stop(); } };

    row.appendChild(btnPlay); row.appendChild(btnRec); row.appendChild(btnStop); row.appendChild(scoreBox);
    line.appendChild(row); line.appendChild(fbBox);
    elLines.appendChild(line);
  });

  // 3ë¬¸ì¥ ì—°ì† ë“£ê¸° & 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì—°ìŠµ)
  const allRow=document.createElement('div'); allRow.className='row';

  const btnAll=document.createElement('button');
  btnAll.className='btn';
  btnAll.textContent='â–¶ï¸ 3ë¬¸ì¥ ì—°ì† ë“£ê¸°';
  btnAll.onclick=()=> speakQueue(pairs.map(x=>x.en), ()=>{btnAll.disabled=true; btnAll.textContent='â–¶ï¸ ì¬ìƒ ì¤‘â€¦';}, ()=>{btnAll.disabled=false; btnAll.textContent='â–¶ï¸ 3ë¬¸ì¥ ì—°ì† ë“£ê¸°';});
  allRow.appendChild(btnAll);

  const btnRecAll=document.createElement('button');
  btnRecAll.className='btn pri';
  btnRecAll.textContent='â— 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì—°ìŠµ)';
  if(!sttSupported){ btnRecAll.disabled=true; btnRecAll.title='ì´ ê¸°ê¸°ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì œí•œë©ë‹ˆë‹¤.'; }
  // â–¶ íŠ¸ë¦¬ê±° ë²„íŠ¼ì„ í•¨ê»˜ ì „ë‹¬í•˜ì—¬ UI ë™ê¸°í™”
  btnRecAll.onclick=()=> practiceRecite(pairs.map(x=>x.en), btnRecAll);
  allRow.appendChild(btnRecAll);

  elLines.appendChild(allRow);

  updateProgress();
}

function updateProgress(){
  const day=getTodayDay(); const d=prog['Day'+day]; if(!d) return;
  const heard=d.lines.filter(x=>x.heard).length; const haveScores=d.lines.every(x=>typeof x.score==='number');
  const avg = haveScores? Math.round(d.lines.reduce((a,x)=>a+(x.score||0),0)/3) : null;
  document.getElementById('avgScore').textContent = avg!=null? (avg+'%'):'â€”';
  document.getElementById('progressText').textContent=`${heard}/3`;
  document.getElementById('meterBar').style.width=((heard/3)*100)+'%';
  const pass = haveScores && avg>=80 && heard===3;
  const elDone=document.getElementById('markDone');
  elDone.disabled=!pass; elDone.textContent=pass?'âœ” ì¡°ê±´ ì¶©ì¡±! ì˜¤ëŠ˜ ì™„ë£Œí•˜ê¸°':'âœ” ì˜¤ëŠ˜ ì™„ë£Œë¡œ í‘œì‹œ';
  elDone.onclick=()=>{ if(pass){ markDone(getTodayDay(),avg); } };
}

function markDone(day,avg){
  const k='Day'+day; const title=TITLES[day-1];
  prog[k].done=true; prog[k].avg=avg; prog.lastDone=k;
  const prev='Day'+(day-1), prevStreak=prog.streak||0;
  prog.streak = (day>1 && prog[prev]&&prog[prev].done)? prevStreak+1 : 1;
  const now=todayKey();
  if(!Array.isArray(prog._history)) prog._history=[];
  prog._history = prog._history.filter(h=>h.day!==day);
  prog._history.push({ day, date: now, title, avg });
  saveProg(prog);
  document.getElementById('streak').textContent=prog.streak;
  document.getElementById('lastDone').textContent=prog.lastDone;
  toast('âœ… ì˜¤ëŠ˜ í•™ìŠµ ì™„ë£Œ! ê¸°ë¡ì— ì €ì¥í–ˆì–´ìš”.');
  renderChallenge100(); renderHistory();
}

function initHeaderKPI(){
  document.getElementById('streak').textContent = prog.streak||0;
  document.getElementById('lastDone').textContent = prog.lastDone||'â€”';
}

// ===== 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì—°ìŠµ) =====
async function practiceRecite(lines, triggerBtn){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.'); return; }

  // íŠ¸ë¦¬ê±° ë²„íŠ¼ UI: ì‹œì‘
  const origText = triggerBtn ? triggerBtn.textContent : '';
  if(triggerBtn){
    triggerBtn.classList.add('rec');
    triggerBtn.disabled = true;
    triggerBtn.textContent = 'â— ì—°ì† ë§í•˜ê¸° ì¤‘â€¦';
  }

  // íŒ¨ë„ UI
  const wrap=document.createElement('div'); wrap.className='practice';
  const box=document.createElement('div'); box.className='box';
  box.innerHTML = `<h3>ğŸ¤ 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸° (ì—°ìŠµ) â€” ì ìˆ˜/ê¸°ë¡ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</h3>`;
  const list=document.createElement('div');
  const items=[];
  lines.forEach((ref,idx)=>{
    const it=document.createElement('div'); it.className='item';
    it.innerHTML = `<div><b>${idx+1}ë²ˆ ë¬¸ì¥</b></div>
      <div class="ref">ğŸ“Œ ${ref}</div>
      <div class="hyp">â€¦</div>
      <div>ì„ì‹œ ì ìˆ˜: <span class="sc">â€”</span></div>
      <div class="feedback"></div>`;
    list.appendChild(it); items.push(it);
  });
  const row=document.createElement('div'); row.className='row';
  const btnClose=document.createElement('button'); btnClose.className='btn'; btnClose.textContent='ë‹«ê¸°'; btnClose.onclick=()=>document.body.removeChild(wrap);
  row.appendChild(btnClose);
  box.appendChild(list); box.appendChild(row); wrap.appendChild(box); document.body.appendChild(wrap);

  // ìˆœì°¨ ì¸ì‹ (ê¸°ë¡/ì§„í–‰ ë¯¸ë°˜ì˜)
  try{
    for(let i=0;i<lines.length;i++){
      const ref = lines[i];
      items[i].querySelector('.hyp').textContent = 'ğŸ™ï¸ ë“£ëŠ” ì¤‘â€¦ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•´ ë³´ì„¸ìš”.';
      try{
        const hyp = await recognizeOnce();
        const sc = scoreSentence(ref, hyp);
        const fbs = (sc===100) ? ['ì˜í–ˆì–´ìš”!'] : wordDiffFeedback(ref, hyp);
        items[i].querySelector('.hyp').textContent = 'ğŸ—£ï¸ ' + (hyp || '(ì¸ì‹ ì‹¤íŒ¨)');
        items[i].querySelector('.sc').textContent = isNaN(sc)? 'â€”' : (sc + '%');
        items[i].querySelector('.feedback').textContent = fbs.join(' Â· ');
      }catch(e){
        items[i].querySelector('.hyp').textContent = 'âš ï¸ ì¸ì‹ ì˜¤ë¥˜';
        items[i].querySelector('.sc').textContent = 'â€”';
        items[i].querySelector('.feedback').textContent = 'ë§ˆì´í¬ ìƒíƒœ ë˜ëŠ” ì£¼ë³€ ì†ŒìŒì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';
      }
    }
    toast('ì—°ìŠµì´ ëë‚¬ì–´ìš”! (ì ìˆ˜/í”¼ë“œë°±ì€ ê¸°ë¡ì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ)');
  } finally {
    // íŠ¸ë¦¬ê±° ë²„íŠ¼ UI: ì¢…ë£Œ/ì›ë³µ
    if(triggerBtn){
      triggerBtn.classList.remove('rec');
      triggerBtn.disabled = false;
      triggerBtn.textContent = origText || 'â— 3ë¬¸ì¥ ì—°ì† ë§í•˜ê¸°(ì—°ìŠµ)';
    }
  }
}

// ===== 100ì¼ ì±Œë¦°ì§€ ìº˜ë¦°ë” =====
function renderChallenge100(){
  const grid=document.getElementById('challenge100'); grid.innerHTML='';
  const cur=getTodayDay();
  for(let i=1;i<=100;i++){ const cell=document.createElement('div'); cell.className='day'; cell.textContent=i;
    const k='Day'+i; if(prog[k] && prog[k].done){ cell.classList.add('done'); cell.style.borderColor='#3b82f6'; }
    if(i===cur){ cell.style.outline='2px solid #5b8cff'; cell.style.color='#e8eefc'; }
    cell.title=k+(i===cur?' â€¢ today':''); cell.onclick=()=>{ prog._currentDay=i; saveProg(prog); tabs.forEach(b=>{ if(b.dataset.view==='home'){ b.click(); }}); renderToday(); };
    grid.appendChild(cell);
  }
}

// ===== ê¸°ë¡(History) =====
function renderHistory(){
  const box=document.getElementById('history');
  let list = Array.isArray(prog._history) ? [...prog._history] : [];
  if (!list.length){
    list = Object.entries(prog)
      .filter(([k,v])=>/^Day\d+$/.test(k) && v && v.avg!=null)
      .map(([k,v])=>({ day: parseInt(k.slice(3)), date: '', title: TITLES[parseInt(k.slice(3))-1], avg: v.avg }));
  }
  list.sort((a,b)=> a.day - b.day);
  if(!list.length){ box.innerHTML='<div class="small">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const frag=document.createDocumentFragment();
  list.forEach(item=>{
    const div=document.createElement('div'); div.className='line';
    const dateTxt = item.date ? ` <span class="small">(${item.date})</span>` : '';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <b>Day ${item.day} â€” ${item.title}${dateTxt}</b><span class="score">${item.avg}%</span></div>`;
    frag.appendChild(div);
  });
  box.innerHTML=''; box.appendChild(frag);
}

// ===== ì¹˜íŠ¸í‚¤ =====
document.getElementById('btnRetry').onclick=()=>{ const day=getTodayDay(); prog['Day'+day]={ lines:[{heard:false,score:null,fb:[]},{heard:false,score:null,fb:[]},{heard:false,score:null,fb:[]}], done:false, avg:null }; saveProg(prog); renderToday(); toast('ğŸ” ì˜¤ëŠ˜ í•™ìŠµì„ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë ¸ì–´ìš”.');};
document.getElementById('btnReset').onclick=()=>{ if(!confirm('ì •ë§ ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? (ì·¨ì†Œ ë¶ˆê°€)')) return;
  localStorage.removeItem(LS_PROGRESS); prog=loadProg(); prog._startedAt=todayKey(); prog._currentDay=1; prog._history=[]; saveProg(prog);
  initHeaderKPI(); renderToday(); renderChallenge100(); renderHistory(); toast('ğŸ§¹ ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ëì–´ìš”.');
};

// ===== PWA =====
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }

// ===== ì§„ë‹¨ ë°°ì§€ =====
async function updateDiag(){
  const supported = 'speechSynthesis' in window;
  badgeSupport.textContent = 'TTS: ' + (supported?'yes':'no');
  badgeSupport.className = 'badge ' + (supported?'good':'bad');
  badgeVoices.textContent = 'voices: ' + (voices?voices.length:0);
  badgeVoices.className = 'badge ' + ((voices&&voices.length)?'good':'bad');
}
async function initDiag(){
  await waitForVoices(1200);
  populateVoiceSelect();
  updateDiag();
}

// ===== ë¶€íŒ… =====
async function boot(){ await initDiag(); initHeaderKPI(); renderToday(); renderChallenge100(); }
boot();
</script>

<!--
í•„ìˆ˜ ì¶”ê°€ íŒŒì¼ (ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸):

1) manifest.webmanifest  (/dailyenglish/manifest.webmanifest?v=8)
2) sw.js  (ì˜¤í”„ë¼ì¸ ìºì‹œ; ìƒˆ ë²„ì „ ë°˜ì˜ ìœ„í•´ ìºì‹œí‚¤ d3l-v8 ê¶Œì¥)
-->
</body>
</html>
