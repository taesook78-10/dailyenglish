<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily 3 Lines</title>

  <!-- topics.js: 전역 window.TOPICS 제공 -->
  <script src="./topics.js?v=20250917"></script>

  <!-- SHIM: TOPICS → TITLES / TOPIC_BANKS (부족분 자동 채움 제거) -->
  <script>
  (function(){
    if (!Array.isArray(window.TOPICS)) {
      console.error("[topics] window.TOPICS가 없습니다. topics.js를 먼저 로드하세요.");
      return;
    }
    window.TITLES = window.TOPICS.map(t => t.topic);
    const banks = {};
    for (const item of window.TOPICS) {
      const arr = Array.isArray(item.sentences) ? item.sentences : [];
      const mapped = arr.map(s => (typeof s === "string") ? ({en:String(s), ko:""}) :
        ({ en:(s&&s.en)?String(s.en):"", ko:(s&&s.ko)?String(s.ko):"" })
      ).slice(0,21); // 초과만 자름, 부족분 자동채움 없음
      banks[item.topic] = mapped;
    }
    window.TOPIC_BANKS = banks;
  })();
  </script>

  <meta name="theme-color" content="#0b1020" />
  <style>
  :root{
    --bg:#0b1020; --card:#111a34; --ink:#e8eefc; --muted:#9fb0df;
    --pri:#5b8cff; --good:#21d39b; --warn:#ffb454; --ring:#31457a;
    --shadow:0 12px 40px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;
    background:radial-gradient(80% 60% at 10% 0%,#15224b 0%,#0b1020 60%),radial-gradient(80% 60% at 100% 100%,#0f1834 0%,#0b1020 60%);}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(91,140,255,.15);color:#cfe0ff;border:1px solid var(--ring);font-size:12px}
  nav{display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap; align-items:center}
  .tab{padding:10px 14px;border-radius:12px;background:#101733;border:1px solid var(--ring);cursor:pointer;color:#a7b3d6}
  .tab.active{background:#141f45;color:var(--ink);border-color:#3a5296}
  select{appearance:none;background:#101733;border:1px solid var(--ring);color:#e8eefc;padding:10px 12px;border-radius:10px;min-height:44px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg,#111a34,#0f1731);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .hd{display:flex;align-items:flex-start;justify-content:space-between;padding:18px 18px 0}
  .card .body{padding:14px 18px 20px}
  .title{font-size:26px;margin-top:4px;font-weight:900;letter-spacing:.3px}
  .subtitle{font-size:13px;color:var(--muted)}
  .line{border:1px solid var(--ring);border-radius:16px;padding:14px;margin:12px 0;background:#0f1731}
  .line p{margin:0 0 8px;font-size:18px;line-height:1.5}
  .line p.ko{margin:0 0 10px; font-size:15.5px; line-height:1.6; color:#cbd4f5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#17224a;color:#e8eefc;border:1px solid #2b3f7a;cursor:pointer;min-height:44px;transition:transform .06s ease, filter .15s ease}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.pri{background:linear-gradient(180deg,#3d64ff,#2b4bd4);border-color:#3b57e0}
  .btn.warn{background:#3a2a0e;border-color:#9f6b18}
  .btn.ghost{background:transparent;border-color:#2b3f7a}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--ring);border-radius:12px;background:#101733;font-size:13px}
  .meter{height:12px;background:#0e1330;border-radius:999px;border:1px solid var(--ring);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff5c7a,#ffb454,#5b8cff,#21d39b)}
  .kpi{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
  .day{aspect-ratio:1/1;border:1px solid #2d3d72;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0e1430;color:#c9d4ff;font-weight:700;font-size:14px}
  @media (max-width:520px){ .calendar{grid-template-columns:repeat(7,1fr)} .day{font-size:13px} .line p{font-size:16px} .title{font-size:22px}}
  .toast{position:fixed;inset:auto 0 18px 0;display:flex;justify-content:center;pointer-events:none}
  .toast span{pointer-events:auto;background:#101733;border:1px solid var(--ring);padding:10px 14px;border-radius:12px}
  .small{font-size:12px;color:#a7b3d6} .hint{font-size:12.5px;color:#d3dcff;background:#16214a;border:1px solid #2e4489;padding:10px 12px;border-radius:10px}

  /* 연속 말하기 패널 */
  .practice{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;}
  .practice .box{width:min(720px,94vw); max-height:92vh; overflow:auto; background:#101733; border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:var(--shadow);}
  .practice .box h3{margin:0 0 12px; font-size:18px;}
  .practice .ref{font-size:14.5px; color:#cfe0ff; margin:6px 0 12px; white-space:pre-wrap; line-height:1.6}
  .practice .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
  .practice .result{margin-top:12px; padding:12px; border:1px solid var(--ring); border-radius:12px; background:#0f1731}
  .feedback{display:block; font-size:12.5px; color:#cfe0ff; opacity:.95}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily 3 Lines <span class="badge">100일 챌린지</span></h1>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="btnRetry">⟲ 다시 하기</button>
        <button class="btn warn" id="btnReset">⟲ 전체 초기화</button>
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="home">오늘의 학습</button>
      <button class="tab" data-view="challenge">챌린지</button>
      <button class="tab" data-view="progress">기록</button>

      <div style="display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:wrap">
        <label class="small" for="voiceSelect">Voice</label>
        <select id="voiceSelect" title="TTS Voice"></select>

        <span class="small">속도</span>
        <button class="btn" id="rateDown">–</button>
        <span id="rate" class="small">1.0x</span>
        <button class="btn" id="rateUp">+</button>
      </div>
    </nav>

    <section id="home" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="subtitle">오늘의 제목 (Day <span id="dayNum">1</span>)</div>
            <div class="title" id="dayTitle">—</div>
          </div>
        </div>
        <div class="body" id="lines"></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>오늘의 목표</h2>
          <div class="kpi">
            <div class="chip">80점 이상 성공</div>
            <div class="chip">점수: <span class="score" id="avgScore">—</span></div>
          </div>
        </div>
        <div class="body">
          <div class="meter" title="3문장 연속 말하기 점수"><i id="meterBar"></i></div>
          <div style="height:12px"></div>
          <button class="btn pri" id="markDone" disabled>✔ 오늘 완료로 표시</button>
          <div style="height:12px"></div>
          <div class="hint">세 문장을 모두 듣고(▶︎) <b>3문장 연속 말하기(점수 반영)</b>에서 80점 이상이면 완료로 기록돼요.</div>
          <div style="height:12px"></div>
          <div class="kpi">
            <div class="chip">연속일수: <b id="streak">0</b>일</div>
            <div class="chip">마지막 완료: <span id="lastDone">—</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" style="display:none">
      <div class="card">
        <div class="hd"><h2>100일 챌린지</h2><div class="chip">Day 1 → Day 100</div></div>
        <div class="body"><div class="calendar" id="challenge100"></div></div>
      </div>
    </section>

    <section id="progress" style="display:none">
      <div class="card">
        <div class="hd"><h2>점수 기록</h2></div>
        <div class="body"><div id="history"></div></div>
      </div>
    </section>

    <div class="toast" id="toast" style="display:none"><span id="toastMsg"></span></div>
  </div>

  <!-- 3문장 연속 듣기/말하기 패널 -->
  <div class="practice" id="practice">
    <div class="box">
      <h3>3문장 연속 말하기</h3>
      <div class="ref" id="practiceRef"></div>
      <div class="meta">
        <button class="btn" id="btnPlayAll">▶︎ 3문장 연속 듣기</button>
        <button class="btn pri" id="btnSpeakAll">● 3문장 연속 말하기(점수 반영)</button>
        <button class="btn" id="btnClosePractice">닫기</button>
      </div>
      <div class="result" id="practiceResult" style="display:none"></div>
    </div>
  </div>

<script>
/* ====== Util / Storage / Day ====== */
const LS_USER='d3l_user', LS_PROGRESS='d3l_progress';
function todayKey(){ const f = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit'}); return f.format(new Date()); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER)||'{"ttsRate":1,"lang":"en-US","voiceURI":""}'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function loadProg(){ return JSON.parse(localStorage.getItem(LS_PROGRESS)||'{}'); }
function saveProg(p){ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }

let user=loadUser(), prog=loadProg();
if(!prog._startedAt){ prog._startedAt=todayKey(); }
if(!prog._currentDay){ prog._currentDay=1; }
if(!prog._lastDate){ prog._lastDate=todayKey(); }
if(!Array.isArray(prog._history)) { prog._history = []; }
saveProg(prog);

function computeDayFromStart(){
  const start = new Date(prog._startedAt+'T00:00:00+09:00');
  return Math.max(1, Math.min(100, Math.floor((Date.now()-start)/86400000)+1));
}
function getTodayDay(){
  const cur=computeDayFromStart();
  if(prog._currentDay!==cur){ prog._currentDay=cur; saveProg(prog); }
  return cur;
}
function ensureDayState(day){
  const k='Day'+day;
  if(!prog[k]){ prog[k]={ comboScore:null, done:false, bankOffset:0, lastShown:[] }; }
  if(typeof prog[k].bankOffset!=='number') prog[k].bankOffset=0;
  if(!Array.isArray(prog[k].lastShown)) prog[k].lastShown=[];
  return prog[k];
}

/* ====== Titles fallback (topics.js가 없을 때만 사용) ====== */
var TITLES = window.TITLES || ['Coffee Break','Morning Routine','Commuting','Emails','Meetings','Exercise','Walking','Grocery Shopping','Cooking','Mentor Advice'];

/* ====== 기본 템플릿 뱅크 (폴백) & 외부 뱅크 우선 ====== */
function __templateBank(title){
  const t=String(title||'').toLowerCase();
  return [
    {en:`I spent some time on ${t} today.`,ko:`오늘 ${t}에 시간을 좀 썼어요.`},
    {en:`I tried to keep ${t} simple.`,ko:`${t}는 최대한 심플하게 해봤어요.`},
    {en:`Honestly, ${t} took longer than I expected.`,ko:`솔직히 ${t}가 생각보다 오래 걸렸어요.`},
    {en:`I finally got around to ${t}.`,ko:`드디어 ${t}를 하게 됐어요.`},
    {en:`I checked in on ${t} after work.`,ko:`퇴근 후 ${t}를 잠깐 살펴봤어요.`},
    {en:`Nothing fancy with ${t}—just the basics.`,ko:`${t}는 거창하게 안 하고 기본만 했어요.`},
    {en:`I made steady progress on ${t}.`,ko:`${t}는 꾸준히 진전이 있었어요.`},
    {en:`I kept ${t} practical, not overthinking it.`,ko:`${t}는 실용적으로, 과하게 고민하진 않았어요.`},
    {en:`We talked about ${t} for a bit.`,ko:`${t}에 대해 잠깐 얘기했어요.`},
    {en:`I’ll try to be more consistent with ${t}.`,ko:`${t}를 더 꾸준히 해볼게요.`},
    {en:`Next time, I’ll plan ${t} ahead.`,ko:`다음엔 ${t}를 미리 계획해볼게요.`},
    {en:`Small wins on ${t} still count.`,ko:`${t}에서 작은 성취도 의미 있어요.`},
    {en:`Slow and steady works for ${t}.`,ko:`${t}는 천천히 꾸준히가 맞는 것 같아요.`},
    {en:`I had a quick update on ${t}.`,ko:`${t} 관련해 간단히 업데이트했어요.`},
    {en:`I kept ${t} light but useful.`,ko:`${t}는 가볍게 했지만 유익했어요.`},
    {en:`I ran into a small hiccup with ${t}.`,ko:`${t}에서 작은 문제가 있었어요.`},
    {en:`I sorted out a few details for ${t}.`,ko:`${t}의 몇 가지 디테일을 정리했어요.`},
    {en:`${t} wasn’t perfect, but it moved forward.`,ko:`${t}가 완벽하진 않았지만 진전됐어요.`},
    {en:`I wrapped up the basics of ${t}.`,ko:`${t}의 기본은 마무리했어요.`},
    {en:`I set a simple goal for ${t} this week.`,ko:`이번 주 ${t}에 단순한 목표를 세웠어요.`},
    {en:`I’m glad ${t} is finally on track.`,ko:`${t}가 드디어 궤도에 올라서 다행이에요.`}
  ];
}
function bank21(title){
  const fromTopics = (window.TOPIC_BANKS && window.TOPIC_BANKS[title]) || null;
  if (Array.isArray(fromTopics) && fromTopics.length) return fromTopics;
  return __templateBank(title);
}

/* ====== TTS ====== */
let voices=[]; const voiceSelect=document.getElementById('voiceSelect');
function loadVoices(){ try{ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
function sortVoices(list){ return [...list].sort((a,b)=>{ const score=v=>(/en[-_]?US/i.test(v.lang)?2:/^en/i.test(v.lang)?1:0); const ds=score(b)-score(a); return ds||((a.name||'').localeCompare(b.name||'')); }); }
function populateVoiceSelect(){ voiceSelect.innerHTML=''; if(!voices.length){ const o=document.createElement('option'); o.textContent='(no voices)'; o.value=''; voiceSelect.appendChild(o); voiceSelect.disabled=true; return; } voiceSelect.disabled=false; const sorted=sortVoices(voices); for(const v of sorted){ const o=document.createElement('option'); o.value=v.voiceURI||v.name||''; o.textContent=`${v.name} — ${v.lang}`; voiceSelect.appendChild(o);} const byURI=sorted.find(v=>(v.voiceURI||'')===(user.voiceURI||'')); if(byURI) voiceSelect.value=byURI.voiceURI||''; else { const enUS=sorted.find(v=>/en[-_]?US/i.test(v.lang)); voiceSelect.value=(enUS&&(enUS.voiceURI||''))||(sorted[0].voiceURI||''); user.voiceURI=voiceSelect.value; saveUser(user);} }
async function waitForVoices(timeout=2000){ if(!('speechSynthesis' in window)) return; loadVoices(); if(voices.length) return; await new Promise(res=>{ const t0=Date.now(); function h(){ loadVoices(); if(voices.length||Date.now()-t0>timeout){ speechSynthesis.removeEventListener('voiceschanged',h); res(); } } speechSynthesis.addEventListener('voiceschanged',h); setTimeout(h,timeout); }); }
if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.addEventListener('voiceschanged', ()=>{ loadVoices(); populateVoiceSelect(); }); }
function resumeTTS(){ try{ if('speechSynthesis' in window && speechSynthesis.paused) speechSynthesis.resume(); }catch(_){} }
window.addEventListener('pointerdown', resumeTTS, { once:true }); document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resumeTTS(); });
function getVoice(){ if(!voices.length) return null; if(user.voiceURI){ const v=voices.find(v=>(v.voiceURI||'')===user.voiceURI); if(v) return v; } return voices.find(v=>/en[-_]?US/i.test(v.lang))||voices.find(v=>/^en/i.test(v.lang))||voices[0]||null; }
function speakOnce(text){ return new Promise(async (resolve)=>{ if(!('speechSynthesis' in window)) return resolve(); await waitForVoices(); resumeTTS(); const utt=new SpeechSynthesisUtterance(text); utt.lang=user.lang||'en-US'; utt.rate=user.ttsRate||1; const v=getVoice(); if(v){ utt.voice=v; utt.lang=v.lang||utt.lang; } utt.onend=()=>resolve(); try{ if(speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){} setTimeout(()=>speechSynthesis.speak(utt),0); }); }
async function speakQueue(arr,onStart,onEnd){ try{ onStart&&onStart(); for(const s of arr){ await speakOnce(s); } } finally{ onEnd&&onEnd(); } }

/* ====== 간단 STT & 점수 ====== */
function norm(s){ return (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim(); }
function jaccard(a,b){ const A=new Set(norm(a).split(' ').filter(Boolean)); const B=new Set(norm(b).split(' ').filter(Boolean)); if(!A.size && !B.size) return 1; let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; }); const uni=A.size + B.size - inter; return uni? inter/uni : 0; }
function scoreLine(ref, hyp){ return Math.round(jaccard(ref,hyp)*100); }

/* ====== 탭/토스트 ====== */
const tabs=document.querySelectorAll('.tab');
const views={home:document.getElementById('home'),challenge:document.getElementById('challenge'),progress:document.getElementById('progress')};
tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    Object.values(views).forEach(v=>v.style.display='none');
    views[btn.dataset.view].style.display='';
  });
});
function toast(msg){ const t=document.getElementById('toast'); const s=document.getElementById('toastMsg'); s.textContent=msg; t.style.display='flex'; setTimeout(()=>t.style.display='none',1800); }

/* ====== 렌더링 ====== */
const elDayNum=document.getElementById('dayNum'); const elTitle=document.getElementById('dayTitle'); const elLines=document.getElementById('lines');
const btnRetry=document.getElementById('btnRetry'); const btnReset=document.getElementById('btnReset');
const elAvg=document.getElementById('avgScore'); const elMeter=document.getElementById('meterBar'); const btnDone=document.getElementById('markDone');

function renderToday(){
  const day=getTodayDay(); const state=ensureDayState(day);
  const title=TITLES[(day-1) % TITLES.length]; const bank=bank21(title);
  const start=(state.bankOffset||0)%21; const trio=[0,1,2].map(i=>bank[(start+i)%21]).filter(Boolean);
  elDayNum.textContent=day; elTitle.textContent=title; elLines.innerHTML='';

  const SR = window.SpeechRecognition||window.webkitSpeechRecognition; const sttSupported=!!SR;

  trio.forEach((pair,idx)=>{
    const text=pair.en||''; const ko=pair.ko||'';
    const line=document.createElement('div'); line.className='line';
    const pEn=document.createElement('p'); pEn.textContent=text; line.appendChild(pEn);
    const pKo=document.createElement('p'); pKo.className='ko'; pKo.textContent=ko; line.appendChild(pKo);

    const row=document.createElement('div'); row.className='row';
    const btnPlay=document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='▶︎ 듣기';
    btnPlay.onclick=()=>speakOnce(text);

    const btnRec=document.createElement('button'); btnRec.className='btn pri'; btnRec.textContent='● 말하기(연습)';
    const btnStop=document.createElement('button'); btnStop.className='btn'; btnStop.textContent='■ 중지'; btnStop.disabled=true;

    if(!sttSupported){ btnRec.disabled=true; btnStop.disabled=true; btnRec.title='이 기기에서는 음성 인식이 제한됩니다.'; }

    // 1문장 연습 모드(점수 기록 X)
    if(sttSupported){
      let rec=null;
      btnRec.onclick=()=>{
        rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
        btnRec.disabled=true; btnStop.disabled=false;
        rec.onresult=(e)=>{ const said=e.results[0][0].transcript||''; const sc=scoreLine(text,said); toast(`점수 ${sc}점: ${said}`); btnRec.disabled=false; btnStop.disabled=true; };
        rec.onend=()=>{ btnRec.disabled=false; btnStop.disabled=true; };
        rec.onerror=()=>{ btnRec.disabled=false; btnStop.disabled=true; toast('음성 인식 오류'); };
        rec.start();
      };
      btnStop.onclick=()=>{ try{ rec&&rec.stop(); }catch(_){ } };
    }

    row.appendChild(btnPlay); row.appendChild(btnRec); row.appendChild(btnStop);
    line.appendChild(row); elLines.appendChild(line);
  });

  // 우측 패널 상태
  const avg = (ensureDayState(day).comboScore ?? null);
  if(avg==null){ elAvg.textContent='—'; elMeter.style.width='0%'; btnDone.disabled=true; }
  else{ elAvg.textContent = `${avg}%`; elMeter.style.width=`${Math.max(0,Math.min(100,avg))}%`; btnDone.disabled = avg<80; }
}

/* ====== 3문장 연속 듣기/말하기 ====== */
const practice = document.getElementById('practice');
const practiceRef = document.getElementById('practiceRef');
const practiceResult = document.getElementById('practiceResult');
document.getElementById('btnClosePractice').onclick=()=>{ practice.style.display='none'; };

function openPractice(trio){
  practiceRef.textContent = trio.map((s,i)=>`${i+1}. ${s.en}`).join('\n');
  practiceResult.style.display='none';
  practice.style.display='flex';
}
document.getElementById('btnPlayAll').onclick=async ()=>{
  const day=getTodayDay(); const state=ensureDayState(day);
  const title=TITLES[(day-1)%TITLES.length]; const bank=bank21(title); const start=(state.bankOffset||0)%21;
  const trio=[0,1,2].map(i=>bank[(start+i)%21]).filter(Boolean);
  openPractice(trio);
  await speakQueue(trio.map(s=>s.en));
};
document.getElementById('btnSpeakAll').onclick=()=>{
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ toast('이 브라우저는 음성 인식을 지원하지 않습니다.'); return; }

  const day=getTodayDay(); const state=ensureDayState(day);
  const title=TITLES[(day-1)%TITLES.length]; const bank=bank21(title); const start=(state.bankOffset||0)%21;
  const trio=[0,1,2].map(i=>bank[(start+i)%21]).filter(Boolean);
  openPractice(trio);

  const rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
  let idx=0, scores=[], transcripts=[];
  practiceResult.style.display='block'; practiceResult.innerHTML='<b>진행 중…</b>';

  function next(){
    if(idx>=trio.length){
      const avg=Math.round(scores.reduce((a,b)=>a+b,0)/Math.max(1,scores.length));
      ensureDayState(day).comboScore = avg; saveProg(prog);
      practiceResult.innerHTML = `<b>결과</b><div class="feedback">점수: ${scores.join(', ')} → 평균 <b>${avg}</b>점</div>`;
      renderToday();
      return;
    }
    const ref=trio[idx].en;
    speakOnce(ref).then(()=>{
      try{ rec.start(); }catch(_){/* already running */}
    });
  }
  rec.onresult=(e)=>{
    const said=e.results[0][0].transcript||''; transcripts.push(said);
    const sc=scoreLine(trio[idx].en, said); scores.push(sc); idx++;
    practiceResult.innerHTML = `<b>진행 중…</b><div class="feedback">${idx}/${trio.length}개 완료 (방금 점수 ${sc}점)</div>`;
    setTimeout(next, 400);
  };
  rec.onerror=()=>{ toast('음성 인식 오류'); };
  rec.onend=()=>{ /* 연속모드: 자동 재시작은 next()에서 호출 */ };
  next();
};

/* ====== 버튼/탭 기타 ====== */
btnRetry.onclick=()=>{ const d=getTodayDay(); const st=ensureDayState(d); st.bankOffset=(st.bankOffset+3)%21; saveProg(prog); renderToday(); };
btnReset.onclick=()=>{ if(!confirm('모든 진행 기록을 초기화할까요?')) return; localStorage.removeItem(LS_PROGRESS); prog=loadProg(); prog._startedAt=todayKey(); prog._currentDay=1; prog._history=[]; saveProg(prog); toast('초기화 완료'); renderToday(); };
document.getElementById('markDone').onclick=()=>{ const d=getTodayDay(); const st=ensureDayState(d); if((st.comboScore||0)<80){ toast('80점 이상일 때 완료할 수 있어요.'); return; } st.done=true; prog._history.push({date:todayKey(),day:d,score:st.comboScore}); saveProg(prog); toast('오늘 완료로 기록했어요!'); renderChallenge(); renderHistory(); };

/* ====== 속도/보이스 ====== */
const rateEl=document.getElementById('rate'); document.getElementById('rateDown').onclick=()=>{ user.ttsRate=Math.max(.5,(user.ttsRate||1)-.1); user.ttsRate=+user.ttsRate.toFixed(1); saveUser(user); rateEl.textContent=user.ttsRate+'x'; }; document.getElementById('rateUp').onclick=()=>{ user.ttsRate=Math.min(2,(user.ttsRate||1)+.1); user.ttsRate=+user.ttsRate.toFixed(1); saveUser(user); rateEl.textContent=user.ttsRate+'x'; };
function initVoices(){ rateEl.textContent=(user.ttsRate||1)+'x'; loadVoices(); populateVoiceSelect(); }

/* ====== 챌린지/기록 ====== */
function renderChallenge(){
  const el=document.getElementById('challenge100'); el.innerHTML='';
  for(let d=1; d<=100; d++){
    const cell=document.createElement('div'); cell.className='day'; cell.textContent=d;
    const st=prog['Day'+d]; if(st&&st.done) cell.style.background='#123a2a';
    el.appendChild(cell);
  }
}
function renderHistory(){
  const el=document.getElementById('history'); el.innerHTML='';
  prog._history.slice(-50).reverse().forEach(h=>{
    const div=document.createElement('div'); div.className='line';
    div.innerHTML=`<p>Day ${h.day} — ${h.date}</p><div class="kpi"><div class="chip">점수 ${h.score}점</div></div>`;
    el.appendChild(div);
  });
}

/* ====== 자정(한국시간) 전환 감시 ====== */
setInterval(()=>{
  const now=todayKey();
  if(prog._lastDate!==now){
    prog._lastDate=now; saveProg(prog);
    // 새 날: 오프셋/점수 초기화, day 갱신
    const d=getTodayDay(); const st=ensureDayState(d); st.bankOffset=0; st.comboScore=null; saveProg(prog);
    renderToday(); renderChallenge(); renderHistory();
  }
}, 60000);

/* ====== 초기 구동 ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  initVoices();
  renderToday();
  renderChallenge();
  renderHistory();

  // 홈에서 연속 패널 열기: 라인 영역을 클릭하면 상단 3문장으로 패널 열기
  document.getElementById('lines').addEventListener('dblclick', ()=>{
    const d=getTodayDay(); const st=ensureDayState(d);
    const title=TITLES[(d-1)%TITLES.length]; const bank=bank21(title); const start=(st.bankOffset||0)%21;
    const trio=[0,1,2].map(i=>bank[(start+i)%21]).filter(Boolean);
    openPractice(trio);
  });
});
</script>
</body>
</html>
