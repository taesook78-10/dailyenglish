<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>영어 말하기 챌린지 — Daily Topic & Lines</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121833; --ink:#e6ebff; --muted:#9aa7d6;
      --pri:#6ea8ff; --accent:#ffd166; --ok:#22c55e;
      --radius:18px; --shadow:0 12px 36px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
      radial-gradient(1200px 600px at 10% 0%, #0f1a3b 0%, #0b1020 55%) fixed;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      color:var(--ink); display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{
      width:min(980px, 100%); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.08); border-radius:26px; box-shadow:var(--shadow); overflow:hidden;
    }
    header{
      padding:22px 24px; display:flex; gap:16px; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(110,168,255,.18), rgba(110,168,255,.05));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:42px; height:42px; border-radius:12px; background:conic-gradient(from 220deg, var(--pri), #9bd2ff);
      box-shadow:0 6px 18px rgba(110,168,255,.35);
    }
    h1{font-size:20px; margin:0}
    .today{
      font-size:13px; color:var(--muted)
    }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end;
    }
    .pill{
      background:#0f1530; border:1px solid rgba(255,255,255,.10); color:var(--ink);
      padding:10px 14px; border-radius:999px; font-size:13px
    }
    .btn{
      background:var(--pri); color:#06142c; border:none; padding:10px 16px; border-radius:12px;
      font-weight:700; cursor:pointer; transition:transform .05s ease; font-size:14px;
    }
    .btn:active{ transform:translateY(1px) }
    .btn.secondary{
      background:#182043; color:var(--ink); border:1px solid rgba(255,255,255,.10);
      font-weight:600;
    }

    main{ padding:24px; display:grid; grid-template-columns: 1fr 380px; gap:18px }
    @media (max-width:900px){ main{ grid-template-columns:1fr } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px; padding:18px; min-height:120px;
    }
    .topic{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px
    }
    .topic-name{
      font-size:22px; font-weight:800; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .topic-name .tag{ font-size:12px; padding:6px 10px; border-radius:999px; background:#101941; border:1px solid rgba(255,255,255,.10); color:var(--muted) }
    .line{
      font-size:20px; line-height:1.6; padding:12px 14px; border-radius:16px;
      background:#0e1535; border:1px dashed rgba(255,255,255,.12); min-height:72px;
    }
    .hint{ color:var(--muted); font-size:13px; margin-top:8px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px }

    .menu{ display:flex; gap:8px; flex-wrap:wrap }
    .menu button{
      background:#10173a; color:var(--ink); border:1px solid rgba(255,255,255,.10);
      padding:8px 12px; border-radius:12px; cursor:pointer; font-size:13px
    }
    .menu button.active{ outline:2px solid var(--accent); color:#0b1020; background:var(--accent); font-weight:800 }
    .meta{ font-size:12px; color:var(--muted); margin-left:6px }

    .side .card{ height:100% }
    .stat{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:12px; background:#0f1738; border:1px solid rgba(255,255,255,.08); margin-bottom:10px }
    .stat b{ font-size:14px }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>영어 말하기 챌린지</h1>
          <div class="today" id="todayStr">—</div>
        </div>
      </div>
      <div class="controls">
        <span class="pill" id="autoStatus">⏱ 매일 00:00 자동 주제 변경 (KST)</span>
        <button class="btn secondary" id="nextLineBtn">새 문장</button>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="topic">
          <div class="topic-name">
            <span>오늘의 주제:</span>
            <span id="topicLabel">—</span>
            <span class="tag" id="topicTag">AUTO</span>
          </div>
          <div class="meta" id="progress">0 / 0</div>
        </div>
        <div class="line" id="lineBox">문장을 불러오고 있어요…</div>
        <div class="hint">Tip: “새 문장” 버튼으로 같은 주제의 다음 문장을 받아보세요. (하루 동안은 중복 없이 순서 제공)</div>

        <div class="row">
          <div class="menu" id="menu"></div>
        </div>
      </section>

      <aside class="side">
        <div class="card">
          <div class="stat"><span>주제 자동 선택 기준</span><b id="baseDateInfo">—</b></div>
          <div class="stat"><span>오늘의 주제 인덱스</span><b id="todayIdx">—</b></div>
          <div class="stat"><span>현재 선택된 주제</span><b id="currentTopic">—</b></div>
          <div class="stat"><span>오늘 제공 가능한 문장 수</span><b id="lineCount">—</b></div>
          <div class="stat"><span>다음 자동 변경 예정</span><b id="nextMidnight">—</b></div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ====== 유틸: KST 날짜 문자열(YYYY-MM-DD) ======
    const toKSTDateString = (d = new Date()) =>
      new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' }).format(d);

    // ====== 기준 시작일(원하시면 바꾸셔도 됩니다) ======
    const START_DATE_STR = '2025-01-01'; // KST 기준
    const todayStrKST = toKSTDateString(new Date());
    document.getElementById('todayStr').textContent = `KST ${todayStrKST}`;

    // ====== 토픽(주제) 및 문장 세트 ======
    // 각 토픽은 "그 토픽에서 실제로 쓸 법한 문장"으로 구성했습니다.
    const TOPICS = [
      {
        key: 'coffee',
        label: '☕ Coffee',
        lines: [
          "I’d like a cup of coffee, please.",
          "Do you prefer hot coffee or iced coffee?",
          "Could I get a latte with an extra shot?",
          "This café makes the best espresso in town.",
          "I usually take my coffee black in the morning.",
          "Is there any non-dairy milk available?",
          "Can I have it to go?",
          "What roast do you recommend for a smooth taste?",
          "I’m trying to cut down on caffeine this week.",
          "Could you make it less sweet, please?"
        ]
      },
      {
        key: 'commuting',
        label: '🚇 Commuting',
        lines: [
          "I usually commute by subway.",
          "The traffic is terrible during rush hour.",
          "I transfer at City Hall to get to my office.",
          "I listen to podcasts while commuting.",
          "I try to leave earlier to avoid the crowd.",
          "The express train saves me about ten minutes.",
          "I missed the bus and had to wait for the next one.",
          "Do you know which line goes to Gangnam?",
          "I prefer standing near the door for a quick exit.",
          "I often read an e-book on the way."
        ]
      },
      {
        key: 'grocery',
        label: '🛒 Grocery',
        lines: [
          "Where can I find the dairy section?",
          "Is there a discount on fresh produce today?",
          "Could you weigh these apples for me?",
          "Do you have any reusable bags?",
          "I’m looking for whole grain bread.",
          "Is there a self-checkout counter?",
          "Are these organic?",
          "Can I pay by card?",
          "Do you have a loyalty program?",
          "What time do you close on weekends?"
        ]
      },
      {
        key: 'smalltalk',
        label: '💬 Small Talk',
        lines: [
          "How’s your day going so far?",
          "That’s a great question—let me think.",
          "Have you tried the new place down the street?",
          "I totally agree with you on that.",
          "By the way, how was your weekend?",
          "I’ve been meaning to ask you about your project.",
          "Sounds good to me!",
          "Could you share your thoughts on this?",
          "It’s nice to finally meet you in person.",
          "Let’s catch up later this week."
        ]
      },
      {
        key: 'school',
        label: '🏫 School',
        lines: [
          "Please line up quietly, everyone.",
          "Let’s review what we learned yesterday.",
          "Raise your hand if you have a question.",
          "Work with your partner for this activity.",
          "We’ll have a short quiz on Friday.",
          "Please submit your homework on time.",
          "Let’s take a five-minute break.",
          "Share your ideas with the class.",
          "Remember to use your inside voice.",
          "Well done! Keep it up."
        ]
      }
    ];

    // ====== 도우미: 안정적인 '하루-토픽' 고정 셔플을 위한 시드형 랜덤 ======
    // 해시 → 시드 → mulberry32 PRNG
    function cyrb128(str) {
      let h1 = 1779033703, h2 = 3144134277, h3 = 1013904242, h4 = 2773480762;
      for (let i = 0, k; i < str.length; i++) {
        k = str.charCodeAt(i);
        h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
        h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
        h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
        h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
      }
      h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
      h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
      h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
      h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
      let h = (h1 ^ h2 ^ h3 ^ h4) >>> 0;
      return h;
    }
    function mulberry32(a){ return function(){let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }

    function stableDailyShuffle(arr, seedStr){
      const seed = cyrb128(seedStr);
      const rand = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rand() * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // ====== 날짜 → 일수 차이 ======
    function daysBetweenUTC(yyyy_mm_dd_A, yyyy_mm_dd_B){
      const msA = Date.parse(yyyy_mm_dd_A); // UTC로 파싱
      const msB = Date.parse(yyyy_mm_dd_B);
      return Math.floor((msB - msA) / 86400000);
    }

    // ====== 오늘의 자동 토픽 인덱스 ======
    function getTodayTopicIndex(){
      const days = daysBetweenUTC(START_DATE_STR, todayStrKST);
      return ((days % TOPICS.length) + TOPICS.length) % TOPICS.length;
    }

    // ====== 상태 ======
    const state = {
      auto: true,                 // 자동 주제 모드 (상시 ON)
      topicIndex: 0,              // 현재 선택된 토픽 인덱스
      todaysOrder: [],            // 오늘의 (해당 토픽) 문장 순서(중복 없이)
      pointer: 0,                 // 오늘 보여준 개수
    };

    // ====== UI 참조 ======
    const $menu = document.getElementById('menu');
    const $topicLabel = document.getElementById('topicLabel');
    const $topicTag = document.getElementById('topicTag');
    const $lineBox = document.getElementById('lineBox');
    const $progress = document.getElementById('progress');
    const $nextBtn = document.getElementById('nextLineBtn');
    const $baseDateInfo = document.getElementById('baseDateInfo');
    const $todayIdx = document.getElementById('todayIdx');
    const $currentTopic = document.getElementById('currentTopic');
    const $lineCount = document.getElementById('lineCount');
    const $nextMidnight = document.getElementById('nextMidnight');

    // ====== 메뉴 생성 ======
    function renderMenu(){
      $menu.innerHTML = '';
      TOPICS.forEach((t, idx) => {
        const b = document.createElement('button');
        b.textContent = `${idx+1}. ${t.label}`;
        b.dataset.idx = idx;
        b.addEventListener('click', () => {
          state.auto = false; // 수동 선택하면 자동 표시만 OFF 상태로 보여줌(자정되면 다시 자동 주제로 전환)
          selectTopic(idx, 'manual');
        });
        $menu.appendChild(b);
      });
      refreshMenuActive();
    }
    function refreshMenuActive(){
      const btns = $menu.querySelectorAll('button');
      btns.forEach(b => {
        const isActive = Number(b.dataset.idx) === state.topicIndex;
        b.classList.toggle('active', isActive);
      });
    }

    // ====== 토픽 선택 & 오늘 순서 구성 ======
    function selectTopic(idx, reason='auto'){
      state.topicIndex = idx;
      const topic = TOPICS[idx];
      // 하루-토픽 고정 셔플: "YYYY-MM-DD|topicKey"로 시드 고정
      state.todaysOrder = stableDailyShuffle(topic.lines, `${todayStrKST}|${topic.key}`);
      state.pointer = 0;
      // UI 갱신
      $topicLabel.textContent = topic.label;
      $topicTag.textContent = reason === 'auto' ? 'AUTO' : 'MANUAL';
      $currentTopic.textContent = `${topic.label}`;
      $lineCount.textContent = `${topic.lines.length}`;
      refreshMenuActive();
      showNextLine(true);
    }

    // ====== 다음 문장 보여주기 (중복 없이) ======
    function showNextLine(resetIfEnd=false){
      const lines = state.todaysOrder;
      if(lines.length === 0){
        $lineBox.textContent = '이 토픽에는 아직 문장이 없습니다.';
        $progress.textContent = '0 / 0';
        return;
      }
      if(state.pointer >= lines.length){
        if(resetIfEnd){
          state.pointer = 0; // 끝까지 봤으면 처음부터 재시작(그래도 오늘 순서는 유지되어 중복 느낌 최소화)
        } else {
          state.pointer = lines.length - 1; // 방어
        }
      }
      const line = lines[state.pointer];
      $lineBox.textContent = line;
      $progress.textContent = `${state.pointer+1} / ${lines.length}`;
      state.pointer++;
    }

    // ====== 다음 자정(KST) 타이머 설정: 자정에 자동 주제로 전환 ======
    function scheduleMidnightSwitch(){
      // KST에서의 다음 자정까지 남은 ms 계산
      const now = new Date();
      const nowKSTStr = new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Seoul', hourCycle:'h23', hour:'2-digit', minute:'2-digit'}).format(now);
      // 다음 자정 시각 문자열 만들기
      const today = new Date(now);
      const kstDateStr = toKSTDateString(today); // YYYY-MM-DD
      // 자정(다음 날 00:00 KST)의 UTC ms 계산
      const nextDay = new Date(Date.parse(kstDateStr) + 86400000); // UTC 기준 다음날 00:00
      const msUntil = nextDay.getTime() - Date.now();
      const etaMin = Math.max(0, Math.round(msUntil/60000));
      $nextMidnight.textContent = `약 ${etaMin}분 후`;
      setTimeout(() => {
        // 날짜 문자열 갱신
        const newToday = toKSTDateString(new Date());
        if(newToday !== todayStrKST){
          // 자정이 지나면 자동 주제로 전환
          state.auto = true;
          const idx = getTodayTopicIndex();
          selectTopic(idx, 'auto');
          document.getElementById('todayStr').textContent = `KST ${newToday}`;
        } else {
          // 혹시 환경에 따라 변동이 없으면 재스케줄
        }
        // 다음 자정도 다시 스케줄
        scheduleMidnightSwitch();
      }, Math.max(1000, msUntil));
    }

    // ====== 초기화 ======
    function init(){
      renderMenu();
      const todayIdx = getTodayTopicIndex();
      $baseDateInfo.textContent = `기준: ${START_DATE_STR}`;
      $todayIdx.textContent = `${todayIdx+1} / ${TOPICS.length}`;
      selectTopic(todayIdx, 'auto');
      $nextBtn.addEventListener('click', () => showNextLine());
      scheduleMidnightSwitch();
    }

    init();
  </script>
</body>
</html>
