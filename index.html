<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>영어 말하기 챌린지</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121833; --ink:#e6ebff; --muted:#9aa7d6;
      --pri:#6ea8ff; --accent:#ffd166; --ok:#22c55e; --bad:#ef4444;
      --radius:18px; --shadow:0 12px 36px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
      radial-gradient(1200px 600px at 10% 0%, #0f1a3b 0%, #0b1020 55%) fixed;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      color:var(--ink); display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{
      width:min(1100px, 100%); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.08); border-radius:26px; box-shadow:var(--shadow); overflow:hidden;
    }
    header{
      padding:22px 24px; display:flex; gap:16px; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(110,168,255,.18), rgba(110,168,255,.05));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{ width:42px; height:42px; border-radius:12px; background:conic-gradient(from 220deg, var(--pri), #9bd2ff);
      box-shadow:0 6px 18px rgba(110,168,255,.35);}
    h1{font-size:20px; margin:0}
    .today{font-size:13px; color:var(--muted)}

    .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; }
    .pill{
      background:#0f1530; border:1px solid rgba(255,255,255,.10); color:var(--ink);
      padding:8px 12px; border-radius:999px; font-size:12px
    }
    .btn{
      background:var(--pri); color:#06142c; border:none; padding:10px 16px; border-radius:12px;
      font-weight:700; cursor:pointer; transition:transform .05s ease; font-size:14px;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn.secondary{
      background:#182043; color:var(--ink); border:1px solid rgba(255,255,255,.10);
      font-weight:600;
    }
    .btn.danger{ background:#ff9aa9; color:#3a0d13; }

    main{ padding:24px; display:grid; grid-template-columns: 1.3fr .7fr; gap:18px }
    @media (max-width:1000px){ main{ grid-template-columns:1fr } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px; padding:18px; min-height:120px;
    }

    /* 왼쪽: 주제/문장/메뉴 */
    .topic{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px }
    .topic-name{
      font-size:22px; font-weight:800; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .topic-name .tag{ font-size:12px; padding:6px 10px; border-radius:999px; background:#101941; border:1px solid rgba(255,255,255,.10); color:var(--muted) }
    .lines-3{ display:grid; gap:8px; }
    .line{
      font-size:20px; line-height:1.6; padding:12px 14px; border-radius:16px;
      background:#0e1535; border:1px dashed rgba(255,255,255,.12); min-height:56px;
    }
    .hint{ color:var(--muted); font-size:13px; margin-top:8px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px }

    .menu{ display:flex; gap:8px; flex-wrap:wrap; max-height:180px; overflow:auto; padding-right:6px }
    .menu button{
      background:#10173a; color:var(--ink); border:1px solid rgba(255,255,255,.10);
      padding:8px 12px; border-radius:12px; cursor:pointer; font-size:13px
    }
    .menu button.active{ outline:2px solid var(--accent); color:#0b1020; background:var(--accent); font-weight:800 }
    .meta{ font-size:12px; color:var(--muted); margin-left:6px }

    /* 오른쪽: 녹음/점수/정보 */
    .side .card{ height:100% }
    .stat{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:12px; background:#0f1738; border:1px solid rgba(255,255,255,.08); margin-bottom:10px }
    .stat b{ font-size:14px }

    .recorder{ display:grid; gap:10px; grid-template-columns:1fr; }
    .indicators{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .dot{ width:10px; height:10px; border-radius:50%; background:#8a93b8; }
    .dot.live{ background:#ff5d73; box-shadow:0 0 0 6px rgba(255,93,115,.15) }
    .timer{ font-variant-numeric: tabular-nums; font-size:14px; color:var(--muted) }

    .score{ display:grid; gap:10px; }
    .score-row{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:12px; background:#0f1738; border:1px solid rgba(255,255,255,.08) }
    .score b{ font-size:14px }
    .score .val{ font-weight:800 }

    .transcript{ font-size:14px; color:var(--muted); white-space:pre-wrap; background:#0f1433; border:1px solid rgba(255,255,255,.08); padding:10px; border-radius:12px; min-height:46px }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>영어 말하기 챌린지</h1>
          <div class="today" id="todayStr">—</div>
        </div>
      </div>
      <div class="controls">
        <span class="pill">🕛 매일 00:00 자동 주제 변경 (KST)</span>
        <button class="btn secondary" id="retryBtn">다시하기</button>
        <button class="btn" id="toggle3Btn">3문장 연속 말하기: OFF</button>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="topic">
          <div class="topic-name">
            <span>오늘의 주제:</span>
            <span id="topicLabel">—</span>
            <span class="tag" id="topicTag">AUTO</span>
          </div>
          <div class="meta" id="progress">0 / 0</div>
        </div>

        <!-- 항상 3문장 UI (어제 화면 유지) -->
        <div class="lines-3" id="linesWrap">
          <div class="line" id="lineBox0">문장을 불러오고 있어요…</div>
          <div class="line" id="lineBox1"></div>
          <div class="line" id="lineBox2"></div>
        </div>

        <div class="hint">Tip: ‘다시하기’ 버튼을 누르면 같은 주제의 새로운 3문장을 순서대로 제공합니다. (하루 동안 중복 없이 제공)</div>

        <div class="row">
          <div class="menu" id="menu"></div>
        </div>
      </section>

      <aside class="side">
        <div class="card recorder">
          <div class="indicators">
            <div class="dot" id="recDot"></div>
            <span id="recStatus">대기 중</span>
            <span class="timer" id="timer">00:00</span>
          </div>
          <div class="row">
            <button class="btn" id="startBtn">▶ 말하기 시작</button>
            <button class="btn danger" id="stopBtn" disabled>■ 정지</button>
            <button class="btn secondary" id="resetBtn">초기화</button>
          </div>

          <div class="score">
            <div class="score-row"><span>점수</span><span class="val" id="scoreVal">—</span></div>
            <div class="score-row"><span>모드</span><span class="val" id="modeVal">단문(1문장)</span></div>
          </div>

          <div class="transcript" id="transcriptBox">전사 결과가 여기에 표시됩니다.</div>

          <div class="card" style="background:transparent;border:none;padding:0;margin-top:8px">
            <div class="stat"><span>주제 자동 선택 기준</span><b id="baseDateInfo">—</b></div>
            <div class="stat"><span>오늘의 주제 인덱스</span><b id="todayIdx">—</b></div>
            <div class="stat"><span>현재 선택된 주제</span><b id="currentTopic">—</b></div>
            <div class="stat"><span>오늘 제공 가능한 문장 수</span><b id="lineCount">—</b></div>
            <div class="stat"><span>다음 자동 변경 예정</span><b id="nextMidnight">—</b></div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- 토픽 데이터 (필수) -->
  <script src="topics.js"></script>

  <script>
    // ====== KST 날짜 유틸 ======
    const toKSTDateString = (d = new Date()) =>
      new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' }).format(d);

    const START_DATE_STR = '2025-01-01';
    let todayStrKST = toKSTDateString(new Date());
    document.getElementById('todayStr').textContent = `KST ${todayStrKST}`;

    // ====== 토픽 로드 ======
    const TOPICS = Array.isArray(window.TOPICS) ? window.TOPICS : [];

    // ====== 상태 & 엘리먼트 ======
    const state = {
      auto:true,
      topicIndex:0,
      todaysOrder:[],
      pointer:0,          // 3개 단위로 증가
      mode3:false         // 연속 말하기 모드(점수 계산용)
    };

    const $menu = document.getElementById('menu');
    const $topicLabel = document.getElementById('topicLabel');
    const $topicTag = document.getElementById('topicTag');
    const $progress = document.getElementById('progress');
    const $retryBtn = document.getElementById('retryBtn');
    const $toggle3Btn = document.getElementById('toggle3Btn');

    const $L0 = document.getElementById('lineBox0');
    const $L1 = document.getElementById('lineBox1');
    const $L2 = document.getElementById('lineBox2');

    const $baseDateInfo = document.getElementById('baseDateInfo');
    const $todayIdx = document.getElementById('todayIdx');
    const $currentTopic = document.getElementById('currentTopic');
    const $lineCount = document.getElementById('lineCount');
    const $nextMidnight = document.getElementById('nextMidnight');

    // ====== 셔플(하루/토픽 고정 시드) ======
    function cyrb128(str) {
      let h1 = 1779033703, h2 = 3144134277, h3 = 1013904242, h4 = 2773480762;
      for (let i = 0, k; i < str.length; i++) {
        k = str.charCodeAt(i);
        h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
        h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
        h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
        h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
      }
      h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
      h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
      h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
      h4 = Math.imul(h2 ^ (h4 >>> 19), 2869860239);
      return (h1 ^ h2 ^ h3 ^ h4) >>> 0;
    }
    function mulberry32(a){ return function(){let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
    function stableDailyShuffle(arr, seedStr){
      const seed = cyrb128(seedStr);
      const rand = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rand() * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // ====== 날짜 → 인덱스 ======
    function daysBetweenUTC(a,b){ return Math.floor((Date.parse(b)-Date.parse(a))/86400000); }
    function getTodayTopicIndex(){
      const days = daysBetweenUTC(START_DATE_STR, todayStrKST);
      return ((days % TOPICS.length) + TOPICS.length) % TOPICS.length;
    }

    // ====== 메뉴 ======
    function renderMenu(){
      $menu.innerHTML='';
      TOPICS.forEach((t, idx)=>{
        const b=document.createElement('button');
        b.textContent=`${idx+1}. ${t.label}`;
        b.dataset.idx=idx;
        b.addEventListener('click', ()=>{
          state.auto=false;
          selectTopic(idx,'manual');
        });
        $menu.appendChild(b);
      });
      refreshMenuActive();
    }
    function refreshMenuActive(){
      $menu.querySelectorAll('button').forEach(b=>{
        b.classList.toggle('active', Number(b.dataset.idx)===state.topicIndex);
      });
    }

    // ====== 토픽 선택 & 3문장 표시 ======
    function selectTopic(idx, reason='auto'){
      state.topicIndex = idx;
      const topic = TOPICS[idx] || {label:'—', lines:[]};
      // 하루-토픽 고정 셔플
      state.todaysOrder = stableDailyShuffle(topic.lines||[], `${todayStrKST}|${topic.key||idx}`);
      state.pointer = 0;

      $topicLabel.textContent = topic.label || '—';
      $topicTag.textContent = reason==='auto' ? 'AUTO' : 'MANUAL';
      $currentTopic.textContent = topic.label || '—';
      $lineCount.textContent = `${(topic.lines||[]).length}`;
      refreshMenuActive();

      show3();
      document.dispatchEvent(new CustomEvent('topicChanged',{detail:{index:idx,key:topic.key,label:topic.label,dateKST:todayStrKST,reason}}));
    }

    function show3(){
      const lines = state.todaysOrder;
      if(!lines.length){
        $L0.textContent='문장이 없습니다.'; $L1.textContent=''; $L2.textContent='';
        $progress.textContent='0 / 0';
        return;
      }
      const a = lines[(state.pointer+0)%lines.length];
      const b = lines[(state.pointer+1)%lines.length];
      const c = lines[(state.pointer+2)%lines.length];
      $L0.textContent=a; $L1.textContent=b; $L2.textContent=c;
      $progress.textContent = `${Math.min(state.pointer+3, lines.length)} / ${lines.length}`;

      document.dispatchEvent(new CustomEvent('lineAdvanced',{detail:{
        topicIndex:state.topicIndex,
        bundleStart:state.pointer,
        texts:[a,b,c],
        dateKST:todayStrKST
      }}));
    }

    // ====== 다시하기(다음 3문장) ======
    document.getElementById('retryBtn').addEventListener('click', ()=>{
      if(!$stop.disabled){ alert('녹음 중에는 바꿀 수 없습니다. 먼저 정지해 주세요.'); return; }
      const len = state.todaysOrder.length || 1;
      state.pointer = (state.pointer + 3) % len;
      show3();
    });

    // ====== 자정(KST) 자동 전환 ======
    function scheduleMidnight(){
      function tick(){
        const now = toKSTDateString(new Date());
        // 남은 시간 표시
        const kstTodayStr = toKSTDateString(new Date());
        const nextDayUTC = new Date(Date.parse(kstTodayStr) + 86400000);
        const min = Math.max(0, Math.round((nextDayUTC.getTime()-Date.now())/60000));
        $nextMidnight.textContent = `약 ${min}분 후`;

        if(now !== todayStrKST){
          todayStrKST = now;
          document.getElementById('todayStr').textContent = `KST ${todayStrKST}`;
          state.auto = true;
          selectTopic(getTodayTopicIndex(),'auto');
        }
      }
      tick();
      setInterval(tick, 60000); // 1분마다 체크
    }

    // ====== 초기화 ======
    function init(){
      $baseDateInfo.textContent = `기준: ${START_DATE_STR}`;
      renderMenu();
      const tIdx = getTodayTopicIndex();
      $todayIdx.textContent = `${tIdx+1} / ${TOPICS.length}`;
      selectTopic(tIdx,'auto');
      scheduleMidnight();
    }

    // ====== 녹음/ASR/점수 (정지 버튼 필수) ======
    const $start = document.getElementById('startBtn');
    const $stop = document.getElementById('stopBtn');
    const $reset = document.getElementById('resetBtn');
    const $recDot = document.getElementById('recDot');
    const $recStatus = document.getElementById('recStatus');
    const $timer = document.getElementById('timer');
    const $scoreVal = document.getElementById('scoreVal');
    const $modeVal = document.getElementById('modeVal');
    const $transcript = document.getElementById('transcriptBox');

    let mediaRecorder, chunks = [];
    let recStartedAt = 0, timerId = null;
    let recognition = null, recogActive = false;
    let capturedTranscript = '';

    function fmt(ms){ const s=Math.floor(ms/1000), m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
    function startTimer(){ stopTimer(); timerId=setInterval(()=>{ $timer.textContent=fmt(Date.now()-recStartedAt); },200); }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
    function setLiveUI(live){
      $recDot.classList.toggle('live', live);
      $recStatus.textContent = live ? '녹음 중(정지 버튼 필수)' : '대기 중';
      $start.disabled = live; $stop.disabled = !live; $retryBtn.disabled = live;
      $menu.querySelectorAll('button').forEach(b=>b.disabled = live);
      $toggle3Btn.disabled = live;
    }

    function setupASR(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.lang='en-US'; r.continuous=true; r.interimResults=true;
      r.onresult=(e)=>{
        let t=''; for(let i=e.resultIndex;i<e.results.length;i++){ t+=e.results[i][0].transcript; }
        capturedTranscript=t.trim(); $transcript.textContent=capturedTranscript||'…';
      };
      r.onerror=()=>{}; r.onend=()=>{recogActive=false;};
      return r;
    }

    async function startRecording(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true }, video:false });
        const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
        mediaRecorder = new MediaRecorder(stream, mime?{mimeType:mime}:{});
        chunks=[]; mediaRecorder.ondataavailable=(e)=>{ if(e.data.size>0) chunks.push(e.data); };
        mediaRecorder.onstop=()=>{ stream.getTracks().forEach(t=>t.stop()); };
        mediaRecorder.start();

        recognition = setupASR();
        if(recognition){ capturedTranscript=''; recognition.start(); recogActive=true; }

        recStartedAt=Date.now(); startTimer(); setLiveUI(true);
      }catch(err){ alert('마이크 권한을 허용해 주세요.\\n'+err); }
    }
    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); }
      if(recognition && recogActive){ try{recognition.stop();}catch{} recogActive=false; }
      stopTimer(); setLiveUI(false);

      // 점수 계산: 모드별로 화면의 1개 또는 3개 문장과 비교
      const targets = getCurrentTargets();
      const score = scoreSpeech(capturedTranscript, targets, state.mode3);
      $scoreVal.textContent = score.toFixed(0);
    }
    function resetAll(){
      if(mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); }
      if(recognition && recogActive){ try{recognition.stop();}catch{} recogActive=false; }
      stopTimer(); setLiveUI(false);
      $timer.textContent='00:00'; $scoreVal.textContent='—'; $transcript.textContent='전사 결과가 여기에 표시됩니다.'; capturedTranscript='';
    }

    // 모드 토글(어제 화면 유지)
    $toggle3Btn.addEventListener('click', ()=>{
      if(!$stop.disabled){ alert('녹음 중에는 모드를 바꿀 수 없습니다. 먼저 정지해 주세요.'); return; }
      state.mode3 = !state.mode3;
      $modeVal.textContent = state.mode3 ? '연속(3문장)' : '단문(1문장)';
      $toggle3Btn.textContent = `3문장 연속 말하기: ${state.mode3?'ON':'OFF'}`;
    });

    $start.addEventListener('click', startRecording);
    $stop.addEventListener('click', stopRecording);
    $reset.addEventListener('click', resetAll);

    // 점수 계산 보조함수
    function norm(s){ return (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim(); }
    function levenshtein(a,b){
      const m=a.length,n=b.length; if(!m) return n; if(!n) return m;
      const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){
        const cost=a[i-1]===b[j-1]?0:1;
        dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
      }} return dp[m][n];
    }
    function sim(hyp, ref){
      const A=norm(hyp), B=norm(ref); if(!A&&!B) return 100; if(!A&&B) return 0;
      const d=levenshtein(A,B), max=Math.max(A.length,B.length)||1; return Math.max(0,1-d/max)*100;
    }
    function scoreSpeech(transcript, targets, isBundle){
      if(transcript && transcript.trim()){
        if(isBundle){
          const parts = transcript.split(/[.?!]/).map(s=>s.trim()).filter(Boolean).slice(0,3);
          const scores = targets.map((t,i)=> sim(parts[i]||'', t));
          return scores.reduce((a,b)=>a+b,0)/(scores.length||1);
        } else {
          return sim(transcript, targets[0]||'');
        }
      } else {
        // 대체 점수: 발화 시간 기반 (20초=100점)
        const dur = (Date.now()-recStartedAt)/1000;
        return Math.min(100, Math.max(0, (dur/20)*100));
      }
    }
    function getCurrentTargets(){
      return [$L0.textContent||'', $L1.textContent||'', $L2.textContent||''];
    }

    // 시작!
    init();

    // 디버그
    window._DailyTopicApp = {
      get state(){return {...state}}, get topic(){return TOPICS[state.topicIndex];},
      retry:()=>document.getElementById('retryBtn').click(),
      select:(i)=>selectTopic(i,'manual')
    };
  </script>
</body>
</html>
